### 表一：攻击机制配置表 (Attack Config)

| UI名称 | 标识符 | 攻击范围 | 伤害数值 (Dmg) | 判定逻辑 (Dev Logic) |
| :--- | :--- | :--- | :--- | :--- |
| **主炮** | `GUN` | **1格** | **3** (若持有者存活)<br>**1** (若持有者全灭) | **单点判定**：<br>`Target.HP -= Dmg`<br>若 `Target.HP <= 0`，状态转为 **X (毁坏)**；<br>若 `Target.HP > 0`，状态转为 **Hit (受损)**。 |
| **空袭** | `AIR` | **5格** (X字) | **1** | **多点循环判定**：<br>对5个坐标分别执行单点判定。<br>若某点已是 Miss/X，则跳过；若为未知，执行扣血逻辑。 |
| **水听** | `SONAR` | **9格** (3x3) | **0** | **区域扫描逻辑**：<br>1. 遍历9格，若 `Sum(ShipCount) == 0` $\rightarrow$ 全部标记为 **Miss**。<br>2. 若 `Sum > 0` $\rightarrow$ 强制揭示中心点 `(x,y)` 的当前真实状态（Miss/Hit/X），并为周围区域标记疑似状态 |

---

### 表二：船只属性定义表 (Ship Stats)

| 代号 | 船只名称 | 占格 | 格位血量 (MaxHP) | 绑定攻击 | 战术解释 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **CV** | 航空母舰 | 4 | **2** | **空袭** | **空袭核心**：拥有者 |
| **CL** | 轻巡洋舰 | 3 | **1** | **主炮** | **穿甲僚机**：存活时主炮伤害>=2 |
| **BB** | 战列舰 | 4 | **3** | **主炮** | **穿甲核心**：存活时主炮伤害=3 |
| **SS** | 潜艇 | 1 | **2** | **主炮** | **穿甲雷击**：存活时主炮伤害=3 (雷击) |
| **DD** | 驱逐舰 | 2 | **1** | **水听** | **侦查核心**：失去后无法发动水听。 |

---

### 表三：格位状态机 (Grid State Machine)

这张表定义了地图上每一个格子（Grid Cell）在数据层和表现层的状态流转。

*   **FOW**: Fog of War (战争迷雾，未探索)
*   **Obj**: 该格子是否有船只实体 (null 或 ShipID)

| 状态名称 (State) | 前置条件 | 触发事件 (Event) | 转换后状态 (Next State) | UI表现 (View) | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **未知 (FOW)** | 初始状态 | 玩家攻击 / 水听扫描 | (见下文判定) | **空白/海浪** | 玩家不可见内部是否有船 |
| **$\downarrow$ 判定过程** | FOW状态被击中 | **判定：Obj Is Null?** | (分流) | - | 后端逻辑 |
| **未命中 (MISS)** | Obj Is Null | 攻击结算 / 水听排空 | **终态** | **水花图标 / 灰点** | 确认为安全海域，不可再被选为目标 |
| **疑似 (DETECT)** | Obj Is Null | 水听排空 | **受损，毁坏或未命中** | **问号图标** | 疑似标记，类似于扫雷中的插旗 |
| **受损 (HIT)** | Obj Not Null | 攻击结算 (HP剩余 > 0) | **保持 HIT 状态**<br>(但在数据层更新HP) | **冒烟 / 黄色爆炸** | 玩家知道这里有船，但没打烂。<br>*注：BB需打3次，SS需打2次* |
| **毁坏 (X)** | Obj Not Null | 攻击结算 (HP剩余 $\le$ 0) | **终态** | **大红叉 / 燃烧残骸** | 该格彻底报废。若该船所有格均为X，全船沉没。 |

#### 状态流转示例 (以攻击 BB 为例，BB单格血量=3)：

1.  **初始**：状态 `FOW`，HP=3。
2.  **玩家使用 HE (1伤)**：
    *   HP 变 2。
    *   状态变为 `HIT`。UI显示：冒烟。
3.  **玩家再使用 HE (1伤)**：
    *   HP 变 1。
    *   状态仍为 `HIT`。UI显示：冒烟（或者火势变大，如果美术资源允许）。
4.  **玩家使用 AP (3伤，溢出)**：
    *   HP 变 -2。
    *   状态变为 `X`。UI显示：红叉/残骸。

---

### 附录：AI 智能逻辑 (v3.0)



#### 1. 核心机制：概率网格 (Probability Grid)

- **视野输入**：AI 仅能读取 `getAiViewGrid()` 生成的 10x10 视野矩阵，编码为 `0=未知 / 1=Miss / 2=Hit(未沉) / 3=Destroyed / 4=Suspect / 5=Sunk`，沉没船体被视为永久障碍。
- **船型遍历**：对仍存活的 `myShips` 逐一调用 `enumerateShipPlacements`，尝试全部水平/垂直合法摆放；若摆放跨越 Miss/Sunk 则直接舍弃。
- **权重定义**：每个可行摆放根据命中/疑似格累计关注度，并乘以舰体存活段比例 `scale = aliveSegments / len`。

```text
focusScore = 1
focusScore += hitCount   * AI_PROB_CONFIG.hitFocus
focusScore += suspectCnt * AI_PROB_CONFIG.sonarFocus
weight = max(0.0001, focusScore * scale)
```

- **概率归一**：对同一摆放内所有「可被击中」的格子平均分摊权重，随后整体除以 `totalWeight` 得到概率密度；命中格强制设为 1，Miss/Destroyed/Sunk 强制 0，形成 `probabilityGrid`。
- **调试热力图**：若启用 “🧠 AI 视角”，`updateAiHeatmapVisuals()` 会以 `probabilityGrid` 作为热力着色依据，方便验证概率分布是否符合预期。

#### 2. 难度配置 (Difficulty Presets)

| 档位 | `hitFocus` | `sonarFocus` | `airstrikeAdvantage` | `sonarVarianceGate` | `sonarUnknownRatio` | `randomness` | 特性描述 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **EASY** | 0.5 | 0.5 | 1.6 | 0.40 | 8/9 | 0.8 | 主要随机射击，几乎不连线、不侦查 |
| **NORMAL** | 2.0 | 1.2 | 1.1 | 0.25 | 2/3 | 0.2 | 具备连线意识，偶尔侦查，存在失误 |
| **HARD** *(默认)* | 4.5 | 1.8 | 0.85 | 0.08 | 5/9 | 0.0 | 完全理性，紧抓命中并积极侦查 |

#### 3. 决策流程 (Decision Loop)

1. **资源检测** (`aiTurn` Step1)：
    - 根据敌舰存活情况决定主炮伤害 `aiAPDamage`（BB/SS≥1则 3 点，CL 存活则 2 点，否则 1 点）。
    - 若 `CV`/`DD` 仍在，则可解锁空袭/水听。
2. **概率推断** (`aiTurn` Step2)：
    - 以 `probabilityGrid` 作为主炮和空袭的基础收益。
    - 计算全图得分统计 `scoreStats`（均值、方差、归一化方差）。
    - 归一化方差的计算遵循 `evaluateScoreStats()`，先以所有可攻击格的得分组成集合 `scores`：

    ```text
    score = P(r,c) * aiAPDamage
    mean = (Σ score) / N
    variance = (Σ (score - mean)^2) / N
    half = maxScore / 2
    denom = half > 0 ? half^2 : 1
    normVariance = min(1, variance / denom)
    ```

    - 其中 `maxScore` 为当前最高打击收益；若其越大，`normVariance` 越能体现“全图是否存在显著高点”，供声纳判定使用。
3. **随机扰动**：若命中 `randomness` 概率，完全忽略概率图，改为从未确认格随机挑点（10% 概率顺带随机调用空袭/水听）。
4. **理性分支-武器决策**：
    - **主炮 (AP)**：挑选 `score = P(r,c) * aiAPDamage` 最高的格子。

    ```text
    score_AP(r,c) = probabilityGrid[r][c] * aiAPDamage
    ```

    - **空袭 (HE)**：扫描所有 X 型模板，计算 `score_HE = Σ baseProb`。若 `score_HE > score_AP * airstrikeAdvantage` 则换用空袭。
    - **水听 (SONAR)**：评估每个 3x3 区域的未知覆盖率 `coverage = unknown/9` 与密度 `density = mass / unknown`。当 `coverage >= sonarUnknownRatio` 且 `scoreStats.normVariance < sonarVarianceGate` 时触发侦查。

5. **行动执行**：
    - `AP`：调用 `aiProcessHit` 对单格结算伤害，并在 UI 中打上 `hit/destroyed`。
    - `HE`：对中心与四个对角格各自调用 `aiProcessHit(… , 1)`。
    - `SONAR`：若 3x3 区域含舰则中心点执行 0 伤攻击并对周围格添加 `ai-detect`；若为空则整区标记 Miss。
6. **热度回写**：结束后若开启 Debug，会用最新 `probabilityGrid` 刷新我方棋盘的热点可视化。

#### 4. 实装要点 (Implementation Notes)

- **公式引用**：`calculateProbabilityGrid → enumerateShipPlacements → aiTurn` 构成完整决策链，若未来增删武器或船型，只需在这三处同步更新就能确保概率图与武器选择一致。
- **数值调节入口**：所有难度参数集中在 `DIFFICULTY_SETTINGS`，UI 通过 `setDifficulty()` 即时热更；测试时可在控制台手动覆盖 `AI_PROB_CONFIG` 来进行实验。
- **扩展建议**：若需要加入“锁定追击”“排布惩罚”等玩法，可在 `weight` 计算或 `findBestArea` 中引入更多上下文因子（例如最近命中时间、船只朝向等）。