# æ­¦å™¨ç³»ç»Ÿé‡æ„è¯¦ç»†å®æ–½æ–¹æ¡ˆ

## æ–‡æ¡£è¯´æ˜
æœ¬æ–‡æ¡£æ˜¯å¯¹åŸ `æ­¦å™¨ç³»ç»Ÿé‡æ„.md` çš„è¡¥å……å’Œç»†åŒ–ï¼ŒåŸºäºå¯¹ç°æœ‰ä»£ç çš„æ·±å…¥åˆ†æï¼Œæä¾›å¯æ‰§è¡Œçš„æ¸è¿›å¼é‡æ„è·¯çº¿å›¾ã€‚

## 0. æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰

åœ¨å¼€å§‹ä»»ä½•é‡æ„ä¹‹å‰ï¼Œå¿…é¡»å…ˆæ˜ç¡®æ‰€æœ‰å…±äº«çš„æ•°æ®ç»“æ„ã€‚

### 0.1 æ­¦å™¨æ‰§è¡Œä¸Šä¸‹æ–‡ (WeaponContext)

```javascript
/**
 * æ­¦å™¨æ‰§è¡Œä¸Šä¸‹æ–‡ - ç©å®¶ä¾§
 * @typedef {Object} PlayerWeaponContext
 */
const PlayerWeaponContext = {
    // æ”»å‡»æ–¹ä¿¡æ¯
    attackerShips: [ShipState],     // æ”»å‡»æ–¹èˆ°èˆ¹çŠ¶æ€ï¼ˆç”¨äºåˆ¤æ–­æ­¦å™¨å¯ç”¨æ€§å’Œä¼¤å®³ï¼‰
    
    // é˜²å®ˆæ–¹ä¿¡æ¯
    defenderGrid: [[GridCell]],     // é˜²å®ˆæ–¹ç½‘æ ¼æ•°æ® (10x10)
    defenderShips: [Ship],          // é˜²å®ˆæ–¹èˆ°èˆ¹å¼•ç”¨ï¼ˆç”¨äºæ‰£è¡€å’Œæ²‰èˆ¹åˆ¤å®šï¼‰
    
    // èº«ä»½æ ‡è¯†
    isPlayer: true,                 // true=ç©å®¶æ”»å‡», false=AIæ”»å‡»
    
    // å›è°ƒå‡½æ•°ï¼ˆå¯é€‰ï¼Œç”¨äºç‰¹æ®Šå¤„ç†ï¼‰
    onShipSunk: (ship) => void,     // èˆ¹åªæ²‰æ²¡æ—¶çš„å›è°ƒ
};

/**
 * AI æ­¦å™¨æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆç»§æ‰¿ç©å®¶ä¸Šä¸‹æ–‡ï¼Œå¢åŠ é¢å¤–å­—æ®µï¼‰
 * @typedef {Object} AIWeaponContext
 */
const AIWeaponContext = {
    ...PlayerWeaponContext,
    isPlayer: false,
    markAsLastAttack: true,         // AI æ”»å‡»éœ€è¦æ ‡è®° last-enemy-attack æ ·å¼
};
```

### 0.2 æ­¦å™¨æ‰§è¡Œç»“æœ (WeaponResult)

```javascript
/**
 * æ­¦å™¨æ‰§è¡Œåè¿”å›çš„ç»“æ„åŒ–ç»“æœ
 * @typedef {Object} WeaponResult
 */
const WeaponResult = {
    success: boolean,               // æ˜¯å¦æˆåŠŸæ‰§è¡Œ
    events: [Event],                // äº‹ä»¶åˆ—è¡¨ï¼Œç”±æ¸²æŸ“å™¨è§£é‡Š
    summary: {                      // æ‘˜è¦ä¿¡æ¯ï¼ˆç”¨äºæ—¥å¿—å’Œ AI å­¦ä¹ ï¼‰
        cellsHit: number,           // å‘½ä¸­æ ¼æ•°
        damageDealt: number,        // æ€»ä¼¤å®³
        shipsSunk: [shipId],        // æœ¬æ¬¡å‡»æ²‰çš„èˆ¹åª ID
    }
};
```

### 0.3 äº‹ä»¶ç±»å‹å®šä¹‰ (Event Types)

```javascript
/**
 * CELL_UPDATE - æ ¼å­çŠ¶æ€æ›´æ–°
 */
{
    type: 'CELL_UPDATE',
    payload: {
        grid: 'PLAYER' | 'ENEMY',   // ç›®æ ‡ç½‘æ ¼ï¼ˆç”± WeaponService æ³¨å…¥ï¼‰
        r: number,                  // è¡Œåæ ‡ (0-9)
        c: number,                  // åˆ—åæ ‡ (0-9)
        state: 'HIT' | 'DESTROYED' | 'MISS' | 'SUSPECT',
        markClass: string | null,   // å¯é€‰çš„é¢å¤– CSS ç±»ï¼ˆå¦‚ 'last-enemy-attack'ï¼‰
    }
}

/**
 * SHIP_UPDATE - èˆ¹åªçŠ¶æ€æ›´æ–°
 */
{
    type: 'SHIP_UPDATE',
    payload: {
        grid: 'PLAYER' | 'ENEMY',   // ç›®æ ‡ç½‘æ ¼
        shipId: number,             // èˆ¹åª ID
        segmentIndex: number,       // å—æŸçš„èˆ¹ä½“æ®µç´¢å¼•
        newHp: number,              // è¯¥æ®µæ–°çš„ HP å€¼
        sunk: boolean,              // æ˜¯å¦æ²‰æ²¡
    }
}

/**
 * LOG - æ—¥å¿—è¾“å‡º
 */
{
    type: 'LOG',
    payload: {
        message: string,            // æ—¥å¿—å†…å®¹
        className: 'c-p' | 'c-e' | 'c-sys' | 'c-warn',  // æ ·å¼ç±»
    }
}
```

### 0.4 æ–‡ä»¶ç»“æ„è§„åˆ’

```
src/
â”œâ”€â”€ game/
â”‚   â”œâ”€â”€ game.js                    # ä¸»æ§åˆ¶å™¨ï¼ˆä¿ç•™ï¼Œé€æ­¥ç²¾ç®€ï¼‰
â”‚   â”œâ”€â”€ weapons/
â”‚   â”‚   â”œâ”€â”€ WeaponTypes.js         # æ•°æ®ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ WeaponBase.js          # æ­¦å™¨æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ WeaponRegistry.js      # æ­¦å™¨æ³¨å†Œä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ WeaponService.js       # æ­¦å™¨æ‰§è¡ŒæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ APWeapon.js            # ä¸»ç‚®å®ç°
â”‚   â”‚   â”œâ”€â”€ HEWeapon.js            # ç©ºè¢­å®ç°
â”‚   â”‚   â””â”€â”€ SonarWeapon.js         # æ°´å¬å®ç°
â”‚   â””â”€â”€ battle/
â”‚       â”œâ”€â”€ BattleRenderer.js      # äº‹ä»¶æ¸²æŸ“å™¨
â”‚       â”œâ”€â”€ HitResolver.js         # å‘½ä¸­ç»“ç®—ï¼ˆçº¯æ•°æ®ï¼‰
â”‚       â””â”€â”€ SonarResolver.js       # å£°çº³æ‰«æï¼ˆçº¯æ•°æ®ï¼‰
â””â”€â”€ ai/
    â””â”€â”€ aiStrategy.js              # AI ç­–ç•¥ï¼ˆéœ€åŒæ­¥ä¿®æ”¹ï¼‰
```

---

## 1. é‡æ„èƒŒæ™¯ä¸é—®é¢˜è¯Šæ–­

### 1.1 å½“å‰ä»£ç è€¦åˆç‚¹åˆ†æ

#### é—®é¢˜ Aï¼šæ­¦å™¨é€»è¾‘åˆ†æ•£åœ¨å¤šå¤„
```javascript
// ä½ç½®1: handleEnemyGridHover (L401-426) - é¢„è§ˆèŒƒå›´
if (currentWeapon === 'AP') { /* å•ç‚¹ */ }
else if (currentWeapon === 'HE') { /* Xå‹5æ ¼ */ }
else if (currentWeapon === 'SONAR') { /* 3x3 */ }

// ä½ç½®2: clickEnemy (L1203-1300) - ç©å®¶æ”»å‡»
if (currentWeapon === 'AP') { /* ä¸»ç‚®é€»è¾‘ */ }
else if (currentWeapon === 'HE') { /* ç©ºè¢­é€»è¾‘ */ }
else if (currentWeapon === 'SONAR') { /* æ°´å¬é€»è¾‘ */ }

// ä½ç½®3: aiTurn (L1419-1490) - AIæ”»å‡»
if (weapon === 'AP') { /* ä¸ç©å®¶é‡å¤çš„ä¸»ç‚®é€»è¾‘ */ }
else if (weapon === 'HE') { /* ä¸ç©å®¶é‡å¤çš„ç©ºè¢­é€»è¾‘ */ }
else if (weapon === 'SONAR') { /* ä¸ç©å®¶é‡å¤çš„æ°´å¬é€»è¾‘ */ }
```

**ä»£ç é‡å¤ç‡**ï¼šçº¦ 80%  
**æ–°å¢æ­¦å™¨æˆæœ¬**ï¼šéœ€åŒæ­¥ä¿®æ”¹ 5-6 å¤„

#### é—®é¢˜ Bï¼šDOM æ“ä½œä¸ä¸šåŠ¡é€»è¾‘æ·±åº¦è€¦åˆ
```javascript
// processHit å‡½æ•°æ··æ‚äº†æ•°æ®æ›´æ–°å’ŒDOMæ“ä½œ
function processHit(r, c, dmg) {
    const cell = enemyGridMap[r][c];  // æ•°æ®å±‚
    const uiCell = document.querySelector(...);  // DOMå±‚
    
    cell.hit = true;  // ä¿®æ”¹æ•°æ®
    uiCell.classList.add('hit');  // ä¿®æ”¹UI
    
    if (ship.hp.every(h => h <= 0)) {
        ship.sunk = true;  // ä¿®æ”¹æ•°æ®
        log(`ã€${ship.name}ã€‘æ²‰æ²¡ï¼`);  // è¾“å‡ºæ—¥å¿—
        revealSingleEnemyShip(ship);  // è§¦å‘åŠ¨ç”»
        checkWin("ç©å®¶");  // æ£€æŸ¥èƒœè´Ÿ
    }
}
```

**å½±å“**ï¼šæ— æ³•å•ç‹¬æµ‹è¯•æ•°æ®å±‚é€»è¾‘ï¼Œæ— æ³•å¤ç”¨åˆ°åŒäºº/è”ç½‘æ¨¡å¼ã€‚

#### é—®é¢˜ Cï¼šæ­¦å™¨ä¾èµ–åˆ¤å®šé‡å¤å®ç°
```javascript
// ç©å®¶ä¾§ï¼šupdateWeaponStates()
const cvAlive = myShips.some(s => s.code === 'CV' && !s.sunk);
document.getElementById('btn-he').disabled = !cvAlive;

// AIä¾§ï¼šcheckAIAbilities() (aiStrategy.js)
const aiCV = enemyShips.some(s => s.code === 'CV' && !s.sunk);
return { canUseAir: aiCV };
```

### 1.2 é‡æ„æ”¶ç›Šé¢„ä¼°

| æŒ‡æ ‡ | ç°çŠ¶ | ç›®æ ‡ | æå‡ |
|------|------|------|------|
| æ–°å¢æ­¦å™¨ä»£ç é‡ | ~150è¡Œ (åˆ†æ•£5å¤„) | ~50è¡Œ (1ä¸ªæ–‡ä»¶) | å‡å°‘ 67% |
| ä»£ç é‡å¤ç‡ | 80% | <10% | å‡å°‘ 70% |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | ~0% | 80%+ | æ–°å¢èƒ½åŠ› |
| ç©å®¶/AIä¸€è‡´æ€§ | æ‰‹åŠ¨ä¿è¯ | æ¶æ„ä¿è¯ | æ¶ˆé™¤é£é™© |

---

## 2. é‡æ„ç­–ç•¥ï¼šæ¸è¿›å¼åŒè·¯å¾„å¹¶è¡Œ

### 2.1 æ ¸å¿ƒåŸåˆ™
1. **æ¯ä¸€æ­¥éƒ½ä¿æŒæ¸¸æˆå¯è¿è¡Œ** - ç»ä¸å‡ºç°"ä»£ç ä¸€åŠæ–°ä¸€åŠæ—§å¯¼è‡´å´©æºƒ"
2. **å…ˆéªŒè¯ä¸€ç§æ­¦å™¨** - APæ­¦å™¨ä½œä¸ºè¯•ç‚¹ï¼ŒéªŒè¯æ•´å¥—æµç¨‹
3. **ä¿ç•™æ—§è·¯å¾„ä½œä¸º fallback** - å‡ºé—®é¢˜å¯ç«‹å³å›é€€
4. **åˆ†é˜¶æ®µæäº¤ä»£ç ** - æ¯å®Œæˆä¸€ä¸ª Step å³å¯å‘å¸ƒ
5. **AI æ¨¡å—åŒæ­¥æ›´æ–°** - é¿å…æ­¦å™¨èŒƒå›´å®šä¹‰é‡å¤

### 2.2 å®æ–½é‡Œç¨‹ç¢‘

```
ç¬¬ä¸€é˜¶æ®µï¼ˆåŸºç¡€è®¾æ–½ï¼‰        ç¬¬äºŒé˜¶æ®µï¼ˆæ ¸å¿ƒéªŒè¯ï¼‰       ç¬¬ä¸‰é˜¶æ®µï¼ˆå…¨é¢è¿ç§»ï¼‰       ç¬¬å››é˜¶æ®µï¼ˆæ”¶å°¾ï¼‰
â”œâ”€ Step 1: æ•°æ®ç±»å‹        â”œâ”€ Step 4: APæ­¦å™¨å®ç°     â”œâ”€ Step 6: HEæ­¦å™¨         â”œâ”€ Step 9: æ¸…ç†æ—§ä»£ç 
â”œâ”€ Step 2: ç»“ç®—å™¨          â”œâ”€ Step 5: åŒè·¯å¾„é›†æˆ     â”œâ”€ Step 7: SONARæ­¦å™¨      â”œâ”€ Step 10: æ–‡æ¡£æ›´æ–°
â””â”€ Step 3: æ¸²æŸ“å™¨          â””â”€ éªŒè¯ï¼šä¸»ç‚®å¯ç”¨         â”œâ”€ Step 8: AIè¿ç§»         â””â”€ äº¤ä»˜ï¼šä»£ç åº“æ•´æ´
                                                     â””â”€ éªŒè¯ï¼šæ‰€æœ‰åŠŸèƒ½æ­£å¸¸
```

### 2.3 å…³é”®ä¾èµ–å…³ç³»

```
Step 1 â”€â”€â”¬â”€â”€ Step 2 â”€â”€â”¬â”€â”€ Step 4 â”€â”€ Step 5 â”€â”€â”¬â”€â”€ Step 6 â”€â”€â”
         â”‚            â”‚                      â”‚            â”‚
         â””â”€â”€ Step 3 â”€â”€â”˜                      â”œâ”€â”€ Step 7 â”€â”€â”¼â”€â”€ Step 8 â”€â”€ Step 9 â”€â”€ Step 10
                                             â”‚            â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Step 1-3 å¯å¹¶è¡Œå¼€å‘ï¼Œä½†å¿…é¡»åœ¨ Step 4 ä¹‹å‰å®Œæˆ
- Step 6/7 å¯å¹¶è¡Œå¼€å‘
- Step 8 ä¾èµ– Step 6/7 å®Œæˆ
- Step 9/10 å¿…é¡»æœ€åæ‰§è¡Œ

---

## 3. è¯¦ç»†å®æ–½è®¡åˆ’

### Step 1ï¼šåˆ›å»ºæ•°æ®ç±»å‹å®šä¹‰

**ç›®æ ‡**ï¼šå»ºç«‹æ‰€æœ‰å…±äº«çš„æ•°æ®ç»“æ„ï¼Œä¸ºåç»­æ¨¡å—æä¾›ç±»å‹åŸºç¡€

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/WeaponTypes.js`

```javascript
// src/game/weapons/WeaponTypes.js

import { BOARD_SIZE } from '../../config/constants.js';

/**
 * æ ¼å­çŠ¶æ€æšä¸¾
 */
export const CellState = {
    UNKNOWN: 'UNKNOWN',
    MISS: 'MISS',
    HIT: 'HIT',
    DESTROYED: 'DESTROYED',
    SUSPECT: 'SUSPECT',
    SUNK: 'SUNK'
};

/**
 * äº‹ä»¶ç±»å‹æšä¸¾
 */
export const EventType = {
    CELL_UPDATE: 'CELL_UPDATE',
    SHIP_UPDATE: 'SHIP_UPDATE',
    LOG: 'LOG',
    EFFECT: 'EFFECT'
};

/**
 * èˆ¹åªçŠ¶æ€å¿«ç…§ï¼ˆç”¨äºä¼ é€’ç»™æ­¦å™¨ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡ï¼‰
 */
export class ShipState {
    constructor(ship) {
        this.id = ship.id;
        this.code = ship.code;
        this.name = ship.name;
        this.len = ship.len;
        this.maxHp = ship.maxHp;
        this.hp = [...ship.hp];     // æ·±æ‹·è´
        this.sunk = ship.sunk;
        this.r = ship.r ?? -1;
        this.c = ship.c ?? -1;
        this.vertical = ship.vertical ?? false;
    }
}

/**
 * åˆ›å»ºäº‹ä»¶çš„å·¥å‚å‡½æ•°
 */
export function createCellUpdateEvent(r, c, state, markClass = null) {
    return {
        type: EventType.CELL_UPDATE,
        payload: { r, c, state, markClass }
        // æ³¨æ„ï¼šgrid å­—æ®µç”± WeaponService ç»Ÿä¸€æ³¨å…¥
    };
}

export function createShipUpdateEvent(shipId, segmentIndex, newHp, sunk) {
    return {
        type: EventType.SHIP_UPDATE,
        payload: { shipId, segmentIndex, newHp, sunk }
    };
}

export function createLogEvent(message, className) {
    return {
        type: EventType.LOG,
        payload: { message, className }
    };
}

/**
 * è¾¹ç•Œæ£€æŸ¥å·¥å…·
 */
export function isInBounds(r, c) {
    return r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE;
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ–‡ä»¶æ— è¯­æ³•é”™è¯¯
- [ ] å¯ä»¥è¢«å…¶ä»–æ¨¡å—æ­£ç¡®å¯¼å…¥
- [ ] `ShipState` èƒ½æ­£ç¡®æ·±æ‹·è´ hp æ•°ç»„

---

### Step 2ï¼šåˆ›å»ºç»“ç®—å™¨æ¨¡å—

**ç›®æ ‡**ï¼šå°†å‘½ä¸­åˆ¤å®šå’Œå£°çº³æ‰«æçš„çº¯æ•°æ®é€»è¾‘æŠ½ç¦»ï¼Œä¸ä¾èµ– DOM

#### 2.1 åˆ›å»º HitResolver.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/battle/HitResolver.js`

```javascript
// src/game/battle/HitResolver.js

import { createCellUpdateEvent, createShipUpdateEvent, createLogEvent, isInBounds } from '../weapons/WeaponTypes.js';

/**
 * å‘½ä¸­ç»“ç®—å™¨ - çº¯æ•°æ®å±‚ï¼Œä¸æ“ä½œ DOM
 * 
 * @param {number} r - è¡Œåæ ‡
 * @param {number} c - åˆ—åæ ‡
 * @param {number} damage - ä¼¤å®³å€¼
 * @param {Array<Array<Object>>} grid - ç½‘æ ¼æ•°æ® (enemyGridMap æ ¼å¼)
 * @param {Array<Object>} ships - èˆ°èˆ¹æ•°ç»„
 * @param {boolean} isPlayer - æ˜¯å¦ä¸ºç©å®¶æ”»å‡»
 * @returns {Object} { events: Event[], hitShip: Ship|null, sunk: boolean }
 */
export function resolveHit(r, c, damage, grid, ships, isPlayer) {
    const events = [];
    
    // è¾¹ç•Œæ£€æŸ¥
    if (!isInBounds(r, c)) {
        return { events: [], hitShip: null, sunk: false };
    }
    
    const cell = grid[r][c];
    
    // å·²ç¡®è®¤ miss çš„æ ¼å­ä¸å†å¤„ç†
    if (cell.hit && cell.shipId === -1) {
        return { events: [], hitShip: null, sunk: false };
    }
    
    // æ ‡è®°æ ¼å­ä¸ºå·²æ”»å‡»
    cell.hit = true;
    
    if (cell.shipId !== -1) {
        // å‘½ä¸­èˆ¹åª
        const ship = ships[cell.shipId];
        const segIdx = cell.segmentIndex;
        
        // å·²æ‘§æ¯çš„æ ¼å­ä¸å†æ‰£è¡€
        if (ship.hp[segIdx] <= 0) {
            return { events: [], hitShip: ship, sunk: false };
        }
        
        // æ‰£è¡€
        if (damage > 0) {
            ship.hp[segIdx] -= damage;
        }
        
        // åˆ¤æ–­æ ¼å­çŠ¶æ€
        const cellState = ship.hp[segIdx] <= 0 ? 'DESTROYED' : 'HIT';
        events.push(createCellUpdateEvent(r, c, cellState));
        events.push(createShipUpdateEvent(ship.id, segIdx, ship.hp[segIdx], false));
        
        // åˆ¤æ–­æ²‰èˆ¹
        const isSunk = ship.hp.every(h => h <= 0) && !ship.sunk;
        if (isSunk) {
            ship.sunk = true;
            events.push(createShipUpdateEvent(ship.id, -1, 0, true));
            
            const logClass = isPlayer ? 'c-warn' : 'c-e';
            const logMsg = isPlayer 
                ? `æˆ˜æŠ¥ï¼šæ•Œæ–¹ã€${ship.name}ã€‘ç¡®è®¤æ²‰æ²¡ï¼`
                : `ä¸¥é‡è­¦æŠ¥ï¼šæˆ‘æ–¹ã€${ship.name}ã€‘æ²‰æ²¡ï¼`;
            events.push(createLogEvent(logMsg, logClass));
        }
        
        return { events, hitShip: ship, sunk: isSunk };
    } else {
        // æœªå‘½ä¸­
        events.push(createCellUpdateEvent(r, c, 'MISS'));
        return { events, hitShip: null, sunk: false };
    }
}

/**
 * æ‰¹é‡å‘½ä¸­ç»“ç®—ï¼ˆç”¨äºç©ºè¢­ç­‰å¤šç‚¹æ”»å‡»ï¼‰
 */
export function resolveMultiHit(cells, damage, grid, ships, isPlayer) {
    const allEvents = [];
    let totalSunk = [];
    
    for (const { r, c } of cells) {
        const result = resolveHit(r, c, damage, grid, ships, isPlayer);
        allEvents.push(...result.events);
        if (result.sunk) {
            totalSunk.push(result.hitShip.id);
        }
    }
    
    return { events: allEvents, shipsSunk: totalSunk };
}
```

#### 2.2 åˆ›å»º SonarResolver.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/battle/SonarResolver.js`

```javascript
// src/game/battle/SonarResolver.js

import { createCellUpdateEvent, createLogEvent, isInBounds } from '../weapons/WeaponTypes.js';
import { BOARD_SIZE } from '../../config/constants.js';

/**
 * å£°çº³æ‰«æç»“ç®—å™¨
 * 
 * @param {number} centerR - ä¸­å¿ƒè¡Œåæ ‡
 * @param {number} centerC - ä¸­å¿ƒåˆ—åæ ‡
 * @param {Array<Array<Object>>} grid - ç½‘æ ¼æ•°æ®
 * @param {Array<Object>} ships - èˆ°èˆ¹æ•°ç»„
 * @param {boolean} isPlayer - æ˜¯å¦ä¸ºç©å®¶ä½¿ç”¨
 * @returns {Object} { events: Event[], hasSignal: boolean }
 */
export function resolveSonar(centerR, centerC, grid, ships, isPlayer) {
    const events = [];
    
    // ç»Ÿè®¡ 3x3 åŒºåŸŸå†…æœªæš´éœ²çš„èˆ¹åªæ ¼æ•°
    let shipCount = 0;
    const scanCells = [];
    
    for (let i = -1; i <= 1; i++) {
        for (let j = -1; j <= 1; j++) {
            const nr = centerR + i;
            const nc = centerC + j;
            
            if (!isInBounds(nr, nc)) continue;
            
            scanCells.push({ r: nr, c: nc, isCenter: i === 0 && j === 0 });
            
            const cell = grid[nr][nc];
            if (cell.shipId !== -1 && !cell.hit) {
                shipCount++;
            }
        }
    }
    
    const logClass = isPlayer ? 'c-sys' : 'c-e';
    const prefix = isPlayer ? '' : 'æ•Œæ–¹';
    
    if (shipCount === 0) {
        // æ— ä¿¡å·ï¼šå…¨éƒ¨æ ‡è®°ä¸º miss
        for (const { r, c } of scanCells) {
            const cell = grid[r][c];
            if (!cell.hit) {
                cell.hit = true;
                events.push(createCellUpdateEvent(r, c, 'MISS'));
            }
        }
        events.push(createLogEvent(
            `${prefix}å£°çº³æ‰«æ (${centerR + 1},${centerC + 1}) åŒºåŸŸï¼šæ— ååº”ã€‚`,
            'c-sys'
        ));
        return { events, hasSignal: false };
    } else {
        // æœ‰ä¿¡å·ï¼šä¸­å¿ƒç‚¹æ˜¾å½¢ï¼Œå‘¨å›´æ ‡è®°ç–‘ä¼¼
        
        // ä¸­å¿ƒç‚¹å¤„ç†ï¼šé€ æˆ 0 ä¼¤å®³çš„"å‘½ä¸­"åˆ¤å®šï¼Œæ­ç¤ºçœŸå®çŠ¶æ€
        const centerCell = grid[centerR][centerC];
        if (!centerCell.hit) {
            centerCell.hit = true;
            if (centerCell.shipId !== -1) {
                events.push(createCellUpdateEvent(centerR, centerC, 'HIT'));
            } else {
                events.push(createCellUpdateEvent(centerR, centerC, 'MISS'));
            }
        }
        
        // å‘¨å›´ 8 æ ¼æ ‡è®°ç–‘ä¼¼
        for (const { r, c, isCenter } of scanCells) {
            if (isCenter) continue;
            
            const cell = grid[r][c];
            // åªæ ‡è®°æœªæš´éœ²çš„æ ¼å­
            if (!cell.hit) {
                events.push(createCellUpdateEvent(r, c, 'SUSPECT'));
            }
        }
        
        events.push(createLogEvent(
            `${prefix}å£°çº³æ‰«æ (${centerR + 1},${centerC + 1}) åŒºåŸŸï¼šå‘ç°ä¿¡å·ï¼å‘¨è¾¹æ ‡è®°ä¸ºç–‘ä¼¼ã€‚`,
            'c-warn'
        ));
        
        return { events, hasSignal: true };
    }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `resolveHit` èƒ½æ­£ç¡®æ‰£è¡€å’Œåˆ¤æ–­æ²‰èˆ¹
- [ ] `resolveHit` ä¸åŒ…å«ä»»ä½• `document` æˆ– DOM æ“ä½œ
- [ ] `resolveSonar` èƒ½æ­£ç¡®åŒºåˆ†æœ‰ä¿¡å·/æ— ä¿¡å·æƒ…å†µ
- [ ] æ‰€æœ‰è¿”å›çš„äº‹ä»¶æ ¼å¼ç¬¦åˆè§„èŒƒ

---

### Step 3ï¼šåˆ›å»ºæ¸²æŸ“å™¨

**ç›®æ ‡**ï¼šå°†äº‹ä»¶è½¬æ¢ä¸º DOM æ“ä½œï¼Œè§£è€¦æ•°æ®å±‚å’Œè§†å›¾å±‚

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/battle/BattleRenderer.js`

```javascript
// src/game/battle/BattleRenderer.js

import { EventType } from '../weapons/WeaponTypes.js';

/**
 * æˆ˜æ–—æ¸²æŸ“å™¨ - å°†äº‹ä»¶è½¬æ¢ä¸º DOM æ“ä½œ
 */
export class BattleRenderer {
    /**
     * @param {Object} options
     * @param {Function} options.logFn - æ—¥å¿—è¾“å‡ºå‡½æ•° (msg, className) => void
     * @param {Function} options.onShipSunk - èˆ¹åªæ²‰æ²¡å›è°ƒ (shipId, grid) => void
     */
    constructor(options = {}) {
        this.logFn = options.logFn || ((msg, cls) => console.log(`[${cls}] ${msg}`));
        this.onShipSunk = options.onShipSunk || (() => {});
    }
    
    /**
     * æ¸²æŸ“ä¸€ç»„äº‹ä»¶
     * @param {Array<Event>} events - äº‹ä»¶æ•°ç»„
     */
    render(events) {
        if (!events || !Array.isArray(events)) return;
        
        for (const event of events) {
            this._renderOne(event);
        }
    }
    
    _renderOne(event) {
        switch (event.type) {
            case EventType.CELL_UPDATE:
                this._renderCellUpdate(event.payload);
                break;
            case EventType.SHIP_UPDATE:
                this._renderShipUpdate(event.payload);
                break;
            case EventType.LOG:
                this._renderLog(event.payload);
                break;
            case EventType.EFFECT:
                this._renderEffect(event.payload);
                break;
        }
    }
    
    _renderCellUpdate(payload) {
        const { grid, r, c, state, markClass } = payload;
        const gridId = grid === 'PLAYER' ? 'player-grid' : 'enemy-grid';
        const cell = document.querySelector(`#${gridId} .cell[data-r="${r}"][data-c="${c}"]`);
        
        if (!cell) return;
        
        // æ¸…é™¤æ—§çŠ¶æ€
        cell.classList.remove('hit', 'destroyed', 'miss', 'detect', 'ai-detect');
        
        // åº”ç”¨æ–°çŠ¶æ€
        switch (state) {
            case 'HIT':
                cell.classList.add('hit');
                break;
            case 'DESTROYED':
                cell.classList.add('destroyed');
                break;
            case 'MISS':
                cell.classList.add('miss');
                break;
            case 'SUSPECT':
                // ç©å®¶ä¾§ç”¨ detectï¼ŒAI ä¾§ç”¨ ai-detect
                cell.classList.add(grid === 'PLAYER' ? 'ai-detect' : 'detect');
                break;
        }
        
        // é™„åŠ é¢å¤–æ ·å¼
        if (markClass) {
            cell.classList.add(markClass);
        }
    }
    
    _renderShipUpdate(payload) {
        const { grid, shipId, sunk } = payload;
        
        if (sunk) {
            // è§¦å‘æ²‰èˆ¹å›è°ƒ
            this.onShipSunk(shipId, grid);
        }
    }
    
    _renderLog(payload) {
        const { message, className } = payload;
        this.logFn(message, className);
    }
    
    _renderEffect(payload) {
        // é¢„ç•™ï¼šç”¨äºæ’­æ”¾çˆ†ç‚¸ã€æ‰«æç­‰åŠ¨ç”»æ•ˆæœ
        // å½“å‰ç‰ˆæœ¬æš‚ä¸å®ç°
    }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æ­£ç¡®å°† CELL_UPDATE è½¬æ¢ä¸º DOM ç±»åå˜æ›´
- [ ] èƒ½æ­£ç¡®åŒºåˆ† PLAYER/ENEMY ç½‘æ ¼
- [ ] æ²‰èˆ¹æ—¶èƒ½è§¦å‘ `onShipSunk` å›è°ƒ
- [ ] å¯¹æ— æ•ˆäº‹ä»¶ä¸å´©æºƒ

---

### Step 4ï¼šå®ç° AP æ­¦å™¨

**ç›®æ ‡**ï¼šåˆ›å»ºç¬¬ä¸€ä¸ªå®Œæ•´çš„æ­¦å™¨å®ç°ï¼ŒéªŒè¯æ•´ä½“æ¶æ„

#### 4.1 åˆ›å»º WeaponBase.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/WeaponBase.js`

```javascript
// src/game/weapons/WeaponBase.js

/**
 * æ­¦å™¨æŠ½è±¡åŸºç±»
 * æ‰€æœ‰æ­¦å™¨å¿…é¡»å®ç°æ­¤æ¥å£
 */
export class WeaponBase {
    constructor({ id, label, icon }) {
        this.id = id;           // æ­¦å™¨æ ‡è¯†ç¬¦ï¼š'AP', 'HE', 'SONAR'
        this.label = label;     // æ˜¾ç¤ºåç§°ï¼š'ä¸»ç‚®', 'ç©ºè¢­', 'æ°´å¬'
        this.icon = icon;       // å›¾æ ‡ï¼š'ğŸ’¥', 'âœˆï¸', 'ğŸ“¡'
    }
    
    /**
     * åˆ¤æ–­æ­¦å™¨æ˜¯å¦å¯ç”¨
     * @param {Object} context - æ­¦å™¨æ‰§è¡Œä¸Šä¸‹æ–‡
     * @returns {boolean}
     */
    canUse(context) {
        throw new Error('å­ç±»å¿…é¡»å®ç° canUse æ–¹æ³•');
    }
    
    /**
     * åˆ¤æ–­ç›®æ ‡æ˜¯å¦æœ‰æ•ˆ
     * @param {Object} target - { r, c }
     * @param {Object} context - æ­¦å™¨æ‰§è¡Œä¸Šä¸‹æ–‡
     * @returns {boolean}
     */
    isValidTarget(target, context) {
        const { r, c } = target;
        const cell = context.defenderGrid[r]?.[c];
        if (!cell) return false;
        
        // å·²ç¡®è®¤ miss ä¸èƒ½å†æ‰“
        if (cell.hit && cell.shipId === -1) return false;
        
        return true;
    }
    
    /**
     * è·å–é¢„è§ˆèŒƒå›´ï¼ˆç”¨äºé¼ æ ‡æ‚¬åœé«˜äº®ï¼‰
     * @param {Object} target - { r, c }
     * @returns {Object} { cells: [{r, c}] }
     */
    previewArea(target) {
        throw new Error('å­ç±»å¿…é¡»å®ç° previewArea æ–¹æ³•');
    }
    
    /**
     * æ‰§è¡Œæ­¦å™¨æ•ˆæœ
     * @param {Object} target - { r, c }
     * @param {Object} context - æ­¦å™¨æ‰§è¡Œä¸Šä¸‹æ–‡
     * @returns {Object} { events: Event[] }
     */
    resolve(target, context) {
        throw new Error('å­ç±»å¿…é¡»å®ç° resolve æ–¹æ³•');
    }
}
```

#### 4.2 åˆ›å»º APWeapon.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/APWeapon.js`

```javascript
// src/game/weapons/APWeapon.js

import { WeaponBase } from './WeaponBase.js';
import { resolveHit } from '../battle/HitResolver.js';
import { createLogEvent } from './WeaponTypes.js';

/**
 * ä¸»ç‚®æ­¦å™¨
 * - å•ç‚¹æ”»å‡»
 * - ä¼¤å®³æ ¹æ®æ”»å‡»æ–¹å­˜æ´»èˆ¹åªå†³å®šï¼šBB/SS=3, CL=2, å…¶ä»–=1
 */
export class APWeapon extends WeaponBase {
    constructor() {
        super({ id: 'AP', label: 'ä¸»ç‚®', icon: 'ğŸ’¥' });
    }
    
    canUse(context) {
        // ä¸»ç‚®å§‹ç»ˆå¯ç”¨
        return true;
    }
    
    isValidTarget(target, context) {
        if (!super.isValidTarget(target, context)) return false;
        
        const { r, c } = target;
        const cell = context.defenderGrid[r][c];
        
        // å·²æ‘§æ¯çš„æ ¼å­ä¸èƒ½å†æ‰“
        if (cell.hit && cell.shipId !== -1) {
            const ship = context.defenderShips[cell.shipId];
            if (ship.hp[cell.segmentIndex] <= 0) {
                return false;
            }
        }
        
        return true;
    }
    
    previewArea(target) {
        return { cells: [{ r: target.r, c: target.c }] };
    }
    
    resolve(target, context) {
        const { r, c } = target;
        const damage = this._calculateDamage(context.attackerShips);
        
        // è°ƒç”¨ç»“ç®—å™¨
        const result = resolveHit(
            r, c, damage,
            context.defenderGrid,
            context.defenderShips,
            context.isPlayer
        );
        
        // æ·»åŠ æ”»å‡»æ—¥å¿—
        const logClass = context.isPlayer ? 'c-p' : 'c-e';
        const prefix = context.isPlayer ? 'ä½¿ç”¨' : 'æ•Œæ–¹ä½¿ç”¨';
        result.events.unshift(createLogEvent(
            `${prefix}ä¸»ç‚®æ”»å‡» (${r + 1},${c + 1})ï¼Œä¼¤å®³: ${damage}`,
            logClass
        ));
        
        return result;
    }
    
    _calculateDamage(attackerShips) {
        const bbAlive = attackerShips.some(s => s.code === 'BB' && !s.sunk);
        const ssAlive = attackerShips.some(s => s.code === 'SS' && !s.sunk);
        const clAlive = attackerShips.some(s => s.code === 'CL' && !s.sunk);
        
        if (bbAlive || ssAlive) return 3;
        if (clAlive) return 2;
        return 1;
    }
}
```

#### 4.3 åˆ›å»º WeaponRegistry.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/WeaponRegistry.js`

```javascript
// src/game/weapons/WeaponRegistry.js

/**
 * æ­¦å™¨æ³¨å†Œä¸­å¿ƒ
 * é›†ä¸­ç®¡ç†æ‰€æœ‰æ­¦å™¨å®ä¾‹
 */
export class WeaponRegistry {
    constructor() {
        this._weapons = new Map();
    }
    
    /**
     * æ³¨å†Œæ­¦å™¨
     * @param {WeaponBase} weapon 
     */
    register(weapon) {
        this._weapons.set(weapon.id, weapon);
    }
    
    /**
     * è·å–æ­¦å™¨
     * @param {string} id 
     * @returns {WeaponBase}
     */
    get(id) {
        return this._weapons.get(id);
    }
    
    /**
     * è·å–æ‰€æœ‰æ­¦å™¨
     * @returns {Array<WeaponBase>}
     */
    getAll() {
        return Array.from(this._weapons.values());
    }
    
    /**
     * æ£€æŸ¥æ­¦å™¨æ˜¯å¦å­˜åœ¨
     * @param {string} id 
     * @returns {boolean}
     */
    has(id) {
        return this._weapons.has(id);
    }
}
```

#### 4.4 åˆ›å»º WeaponService.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/WeaponService.js`

```javascript
// src/game/weapons/WeaponService.js

/**
 * æ­¦å™¨æœåŠ¡
 * åè°ƒæ­¦å™¨æ‰§è¡Œã€äº‹ä»¶æ³¨å…¥å’Œæ¸²æŸ“
 */
export class WeaponService {
    /**
     * @param {WeaponRegistry} registry 
     * @param {BattleRenderer} renderer 
     */
    constructor(registry, renderer) {
        this.registry = registry;
        this.renderer = renderer;
        this.currentWeaponId = 'AP';
    }
    
    /**
     * è®¾ç½®å½“å‰æ­¦å™¨
     */
    setCurrentWeapon(weaponId) {
        if (this.registry.has(weaponId)) {
            this.currentWeaponId = weaponId;
        }
    }
    
    /**
     * è·å–å½“å‰æ­¦å™¨
     */
    getCurrentWeapon() {
        return this.registry.get(this.currentWeaponId);
    }
    
    /**
     * è·å–é¢„è§ˆèŒƒå›´
     */
    getPreviewArea(target) {
        const weapon = this.getCurrentWeapon();
        return weapon ? weapon.previewArea(target) : { cells: [] };
    }
    
    /**
     * æ‰§è¡Œç©å®¶æ”»å‡»
     * @param {Object} target - { r, c }
     * @param {Object} context - ç©å®¶æ­¦å™¨ä¸Šä¸‹æ–‡
     * @returns {Object} æ‰§è¡Œç»“æœ
     */
    executePlayerAction(target, context) {
        const weapon = this.getCurrentWeapon();
        
        if (!weapon.canUse(context)) {
            return { success: false, events: [], reason: 'æ­¦å™¨ä¸å¯ç”¨' };
        }
        
        if (!weapon.isValidTarget(target, context)) {
            return { success: false, events: [], reason: 'ç›®æ ‡æ— æ•ˆ' };
        }
        
        const result = weapon.resolve(target, context);
        
        // æ³¨å…¥ grid æ ‡è¯†
        this._injectGrid(result.events, 'ENEMY');
        
        // æ¸²æŸ“
        this.renderer.render(result.events);
        
        return { success: true, ...result };
    }
    
    /**
     * æ‰§è¡Œ AI æ”»å‡»
     * @param {Object} decision - { r, c, weapon }
     * @param {Object} context - AI æ­¦å™¨ä¸Šä¸‹æ–‡
     * @returns {Object} æ‰§è¡Œç»“æœ
     */
    executeAIAction(decision, context) {
        const { r, c, weapon: weaponId } = decision;
        const weapon = this.registry.get(weaponId);
        
        if (!weapon) {
            return { success: false, events: [], reason: 'æ­¦å™¨ä¸å­˜åœ¨' };
        }
        
        const result = weapon.resolve({ r, c }, context);
        
        // æ³¨å…¥ grid æ ‡è¯†å’Œ AI æ”»å‡»æ ‡è®°
        this._injectGrid(result.events, 'PLAYER', 'last-enemy-attack');
        
        // æ¸²æŸ“
        this.renderer.render(result.events);
        
        return { success: true, ...result };
    }
    
    /**
     * ä¸ºäº‹ä»¶æ³¨å…¥ grid æ ‡è¯†
     */
    _injectGrid(events, grid, markClass = null) {
        for (const event of events) {
            if (event.payload) {
                event.payload.grid = grid;
                if (markClass && event.type === 'CELL_UPDATE') {
                    event.payload.markClass = markClass;
                }
            }
        }
    }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `APWeapon` èƒ½æ­£ç¡®è®¡ç®—ä¼¤å®³
- [ ] `WeaponRegistry` èƒ½æ­£ç¡®æ³¨å†Œå’Œè·å–æ­¦å™¨
- [ ] `WeaponService` èƒ½æ­£ç¡®æ‰§è¡Œç©å®¶/AI æ”»å‡»
- [ ] äº‹ä»¶çš„ `grid` å­—æ®µè¢«æ­£ç¡®æ³¨å…¥

---

### Step 5ï¼šåŒè·¯å¾„é›†æˆ

**ç›®æ ‡**ï¼šåœ¨ game.js ä¸­é›†æˆæ­¦å™¨ç³»ç»Ÿï¼Œå®ç° AP æ­¦å™¨çš„æ–°è·¯å¾„ï¼Œä¿ç•™ HE/SONAR æ—§è·¯å¾„

#### 5.1 ä¿®æ”¹ game.js å¯¼å…¥

```javascript
// åœ¨ game.js é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import { WeaponRegistry } from './weapons/WeaponRegistry.js';
import { WeaponService } from './weapons/WeaponService.js';
import { BattleRenderer } from './battle/BattleRenderer.js';
import { APWeapon } from './weapons/APWeapon.js';
import { ShipState } from './weapons/WeaponTypes.js';
```

#### 5.2 åˆå§‹åŒ–æ­¦å™¨ç³»ç»Ÿ

```javascript
// åœ¨ initGame() ä¸­æ·»åŠ åˆå§‹åŒ–é€»è¾‘

// æ­¦å™¨ç³»ç»Ÿå®ä¾‹ï¼ˆæ¨¡å—çº§å˜é‡ï¼‰
let weaponRegistry = null;
let battleRenderer = null;
let weaponService = null;

function initGame() {
    // ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
    
    // åˆå§‹åŒ–æ­¦å™¨ç³»ç»Ÿ
    initWeaponSystem();
    
    // ... å…¶ä½™ä»£ç  ...
}

function initWeaponSystem() {
    // åˆ›å»ºæ¸²æŸ“å™¨
    battleRenderer = new BattleRenderer({
        logFn: log,
        onShipSunk: (shipId, grid) => {
            if (grid === 'ENEMY') {
                const ship = enemyShips.find(s => s.id === shipId);
                if (ship) revealSingleEnemyShip(ship);
            }
        }
    });
    
    // åˆ›å»ºæ³¨å†Œä¸­å¿ƒå¹¶æ³¨å†Œæ­¦å™¨
    weaponRegistry = new WeaponRegistry();
    weaponRegistry.register(new APWeapon());
    // åç»­æ·»åŠ ï¼š
    // weaponRegistry.register(new HEWeapon());
    // weaponRegistry.register(new SonarWeapon());
    
    // åˆ›å»ºæœåŠ¡
    weaponService = new WeaponService(weaponRegistry, battleRenderer);
}
```

#### 5.3 åˆ›å»ºä¸Šä¸‹æ–‡æ„å»ºå‡½æ•°

```javascript
/**
 * æ„å»ºç©å®¶æ­¦å™¨ä¸Šä¸‹æ–‡
 */
function buildPlayerWeaponContext() {
    return {
        attackerShips: myShips.map(s => new ShipState(s)),
        defenderGrid: enemyGridMap,
        defenderShips: enemyShips,
        isPlayer: true
    };
}

/**
 * æ„å»º AI æ­¦å™¨ä¸Šä¸‹æ–‡
 */
function buildAIWeaponContext() {
    return {
        attackerShips: enemyShips.map(s => new ShipState(s)),
        defenderGrid: myGridMap,  // æ³¨æ„ï¼šAI è§†è§’ä¸‹éœ€è¦ä¸€ä¸ªç±»ä¼¼ç»“æ„
        defenderShips: myShips,
        isPlayer: false
    };
}
```

#### 5.4 ä¿®æ”¹ clickEnemy ä½¿ç”¨åŒè·¯å¾„

```javascript
function clickEnemy(r, c) {
    if (gameState !== 'PLAYING') return;
    if (document.getElementById('enemy-grid').style.pointerEvents === 'none') return;

    // === æ–°è·¯å¾„ï¼šä½¿ç”¨æ­¦å™¨ç³»ç»Ÿ ===
    if (currentWeapon === 'AP' && weaponService) {
        const context = buildPlayerWeaponContext();
        const result = weaponService.executePlayerAction({ r, c }, context);
        
        if (!result.success) return;
        
        // æ£€æŸ¥èƒœè´Ÿ
        const hasSunk = result.events?.some(e => 
            e.type === 'SHIP_UPDATE' && e.payload.sunk
        );
        if (hasSunk) {
            checkWin("ç©å®¶");
        }
    }
    // === æ—§è·¯å¾„ï¼šHE å’Œ SONAR æš‚æ—¶ä¿ç•™ ===
    else if (currentWeapon === 'HE') {
        // ... ä¿ç•™ç°æœ‰ HE é€»è¾‘ ...
    } else if (currentWeapon === 'SONAR') {
        // ... ä¿ç•™ç°æœ‰ SONAR é€»è¾‘ ...
    }

    // åç»­å¤„ç†ï¼ˆä¸¤æ¡è·¯å¾„å…±ç”¨ï¼‰
    updateStatus();
    document.getElementById('enemy-grid').style.pointerEvents = 'none';
    
    if (gameState === 'PLAYING') {
        const timing = getTiming();
        if (timing.VIEW_SWITCH_DELAY > 0) {
            setTimeout(() => {
                if (gameState === 'PLAYING') switchMobileView('player');
            }, timing.VIEW_SWITCH_DELAY);
        }
        scheduleAiTurn(timing.AI_ACTION_DELAY);
    }
}
```

#### 5.5 ä¿®æ”¹ handleEnemyGridHover æ”¯æŒæ­¦å™¨ç³»ç»Ÿ

```javascript
function handleEnemyGridHover(r, c) {
    if (gameState !== 'PLAYING') return;
    if (document.getElementById('enemy-grid').style.pointerEvents === 'none') return;

    clearAttackHighlights();

    let cellsToHighlight = [];

    // å°è¯•ä½¿ç”¨æ­¦å™¨ç³»ç»Ÿè·å–é¢„è§ˆèŒƒå›´
    if (weaponService && weaponRegistry.has(currentWeapon)) {
        weaponService.setCurrentWeapon(currentWeapon);
        const preview = weaponService.getPreviewArea({ r, c });
        cellsToHighlight = preview.cells;
    } else {
        // å›é€€åˆ°æ—§é€»è¾‘
        if (currentWeapon === 'AP') {
            cellsToHighlight.push({ r, c });
        } else if (currentWeapon === 'HE') {
            const offsets = [[0, 0], [-1, -1], [-1, 1], [1, -1], [1, 1]];
            offsets.forEach(off => {
                cellsToHighlight.push({ r: r + off[0], c: c + off[1] });
            });
        } else if (currentWeapon === 'SONAR') {
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    cellsToHighlight.push({ r: r + i, c: c + j });
                }
            }
        }
    }

    // ... é«˜äº®æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜ ...
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] AP æ­¦å™¨ä½¿ç”¨æ–°è·¯å¾„ï¼ŒåŠŸèƒ½æ­£å¸¸
- [ ] HE å’Œ SONAR ä½¿ç”¨æ—§è·¯å¾„ï¼ŒåŠŸèƒ½æ­£å¸¸
- [ ] æ‚¬åœé«˜äº®æ­£å¸¸å·¥ä½œ
- [ ] æ²‰èˆ¹æ—¶ `revealSingleEnemyShip` è¢«æ­£ç¡®è°ƒç”¨
- [ ] ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢æ—¶åºæ­£ç¡®

---

### Step 6ï¼šå®ç° HE æ­¦å™¨ï¼ˆç©ºè¢­ï¼‰

**ç›®æ ‡**ï¼šå°†ç©ºè¢­é€»è¾‘è¿ç§»åˆ°æ–°æ¶æ„

#### 6.1 åˆ›å»º HEWeapon.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/HEWeapon.js`

```javascript
// src/game/weapons/HEWeapon.js

import { WeaponBase } from './WeaponBase.js';
import { resolveMultiHit } from '../battle/HitResolver.js';
import { createLogEvent, isInBounds } from './WeaponTypes.js';

/**
 * ç©ºè¢­æ­¦å™¨
 * - X å‹ 5 æ ¼æ”»å‡»ï¼ˆä¸­å¿ƒ + å››è§’ï¼‰
 * - æ¯æ ¼ä¼¤å®³ 1
 * - éœ€è¦ CVï¼ˆèˆªç©ºæ¯èˆ°ï¼‰å­˜æ´»
 */
export class HEWeapon extends WeaponBase {
    constructor() {
        super({ id: 'HE', label: 'ç©ºè¢­', icon: 'âœˆï¸' });
    }
    
    canUse(context) {
        return context.attackerShips.some(s => s.code === 'CV' && !s.sunk);
    }
    
    previewArea(target) {
        const { r, c } = target;
        const offsets = [[0, 0], [-1, -1], [-1, 1], [1, -1], [1, 1]];
        const cells = offsets
            .map(([dr, dc]) => ({ r: r + dr, c: c + dc }))
            .filter(cell => isInBounds(cell.r, cell.c));
        return { cells };
    }
    
    isValidTarget(target, context) {
        // ç©ºè¢­å…è®¸ä¸­å¿ƒç‚¹æ˜¯å·²æ‘§æ¯çš„ï¼ˆç”¨äºæ‰“å‡»å‘¨å›´ï¼‰
        return isInBounds(target.r, target.c);
    }
    
    resolve(target, context) {
        const { r, c } = target;
        const cells = this.previewArea(target).cells;
        
        // è¿‡æ»¤æ‰å·²ç¡®è®¤ miss å’Œå·²æ‘§æ¯çš„æ ¼å­
        const validCells = cells.filter(cell => {
            const gridCell = context.defenderGrid[cell.r][cell.c];
            // å·² miss è·³è¿‡
            if (gridCell.hit && gridCell.shipId === -1) return false;
            // å·²æ‘§æ¯è·³è¿‡
            if (gridCell.hit && gridCell.shipId !== -1) {
                const ship = context.defenderShips[gridCell.shipId];
                if (ship.hp[gridCell.segmentIndex] <= 0) return false;
            }
            return true;
        });
        
        // æ‰¹é‡ç»“ç®—
        const result = resolveMultiHit(
            validCells,
            1,  // ç©ºè¢­æ¯æ ¼ä¼¤å®³ 1
            context.defenderGrid,
            context.defenderShips,
            context.isPlayer
        );
        
        // æ·»åŠ æ”»å‡»æ—¥å¿—
        const logClass = context.isPlayer ? 'c-p' : 'c-e';
        const prefix = context.isPlayer ? 'å‘¼å«' : 'æ•Œæ–¹å‘åŠ¨';
        result.events.unshift(createLogEvent(
            `${prefix}ç©ºè¢­è¦†ç›– (${r + 1},${c + 1}) å‘¨è¾¹ï¼Œæ‰“å‡»ç‚¹æ•°: ${validCells.length}`,
            logClass
        ));
        
        return result;
    }
}
```

#### 6.2 æ³¨å†Œ HE æ­¦å™¨

```javascript
// åœ¨ initWeaponSystem() ä¸­æ·»åŠ 
import { HEWeapon } from './weapons/HEWeapon.js';

weaponRegistry.register(new HEWeapon());
```

#### 6.3 ä¿®æ”¹ clickEnemy æ¥å…¥ HE

```javascript
function clickEnemy(r, c) {
    // ...
    
    // æ›´æ–°ï¼šHE ä¹Ÿä½¿ç”¨æ–°è·¯å¾„
    if ((currentWeapon === 'AP' || currentWeapon === 'HE') && weaponService) {
        weaponService.setCurrentWeapon(currentWeapon);
        const context = buildPlayerWeaponContext();
        const result = weaponService.executePlayerAction({ r, c }, context);
        
        if (!result.success) return;
        
        // æ£€æŸ¥èƒœè´Ÿ
        if (result.shipsSunk?.length > 0) {
            checkWin("ç©å®¶");
        }
    }
    // SONAR ä»ä½¿ç”¨æ—§è·¯å¾„
    else if (currentWeapon === 'SONAR') {
        // ... ä¿ç•™ç°æœ‰é€»è¾‘ ...
    }
    
    // ...
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ç©ºè¢­ X å‹èŒƒå›´æ­£ç¡®
- [ ] éœ€è¦ CV å­˜æ´»æ‰èƒ½ä½¿ç”¨
- [ ] æ¯æ ¼ä¼¤å®³ 1
- [ ] è·³è¿‡å·² miss å’Œå·²æ‘§æ¯çš„æ ¼å­
- [ ] æ²‰èˆ¹æ£€æµ‹æ­£å¸¸

---

### Step 7ï¼šå®ç° SONAR æ­¦å™¨ï¼ˆæ°´å¬ï¼‰

**ç›®æ ‡**ï¼šå°†æ°´å¬é€»è¾‘è¿ç§»åˆ°æ–°æ¶æ„

#### 7.1 åˆ›å»º SonarWeapon.js

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/game/weapons/SonarWeapon.js`

```javascript
// src/game/weapons/SonarWeapon.js

import { WeaponBase } from './WeaponBase.js';
import { resolveSonar } from '../battle/SonarResolver.js';
import { isInBounds } from './WeaponTypes.js';

/**
 * æ°´å¬æ­¦å™¨
 * - 3x3 æ‰«æåŒºåŸŸ
 * - ä¸é€ æˆä¼¤å®³
 * - éœ€è¦ DDï¼ˆé©±é€èˆ°ï¼‰å­˜æ´»
 */
export class SonarWeapon extends WeaponBase {
    constructor() {
        super({ id: 'SONAR', label: 'æ°´å¬', icon: 'ğŸ“¡' });
    }
    
    canUse(context) {
        return context.attackerShips.some(s => s.code === 'DD' && !s.sunk);
    }
    
    previewArea(target) {
        const { r, c } = target;
        const cells = [];
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const nr = r + i;
                const nc = c + j;
                if (isInBounds(nr, nc)) {
                    cells.push({ r: nr, c: nc });
                }
            }
        }
        return { cells };
    }
    
    isValidTarget(target, context) {
        // å£°çº³ä¼˜å…ˆæ‰«ææœªçŸ¥åŒºåŸŸ
        const { r, c } = target;
        if (!isInBounds(r, c)) return false;
        
        // ä¸­å¿ƒç‚¹åº”è¯¥æ˜¯æœªæš´éœ²çš„
        const centerCell = context.defenderGrid[r][c];
        // å…è®¸ä¸­å¿ƒç‚¹å·²æš´éœ²ï¼Œä½†è‡³å°‘å‘¨å›´åº”è¯¥æœ‰æœªæš´éœ²çš„æ ¼å­
        return true;
    }
    
    resolve(target, context) {
        const { r, c } = target;
        
        // è°ƒç”¨å£°çº³ç»“ç®—å™¨
        const result = resolveSonar(
            r, c,
            context.defenderGrid,
            context.defenderShips,
            context.isPlayer
        );
        
        return result;
    }
}
```

#### 7.2 æ³¨å†Œ SONAR æ­¦å™¨

```javascript
// åœ¨ initWeaponSystem() ä¸­æ·»åŠ 
import { SonarWeapon } from './weapons/SonarWeapon.js';

weaponRegistry.register(new SonarWeapon());
```

#### 7.3 ä¿®æ”¹ clickEnemy å®Œå…¨ä½¿ç”¨æ–°è·¯å¾„

```javascript
function clickEnemy(r, c) {
    if (gameState !== 'PLAYING') return;
    if (document.getElementById('enemy-grid').style.pointerEvents === 'none') return;

    // å®Œå…¨ä½¿ç”¨æ–°è·¯å¾„
    if (weaponService) {
        weaponService.setCurrentWeapon(currentWeapon);
        const context = buildPlayerWeaponContext();
        const result = weaponService.executePlayerAction({ r, c }, context);
        
        if (!result.success) {
            // å¯é€‰ï¼šç»™ç”¨æˆ·åé¦ˆ
            return;
        }
        
        // æ£€æŸ¥èƒœè´Ÿï¼ˆä»…å¯¹æ”»å‡»ç±»æ­¦å™¨ï¼‰
        if (currentWeapon !== 'SONAR' && result.shipsSunk?.length > 0) {
            checkWin("ç©å®¶");
        }
    }

    // åç»­å¤„ç†
    updateStatus();
    document.getElementById('enemy-grid').style.pointerEvents = 'none';
    
    if (gameState === 'PLAYING') {
        const timing = getTiming();
        if (timing.VIEW_SWITCH_DELAY > 0) {
            setTimeout(() => {
                if (gameState === 'PLAYING') switchMobileView('player');
            }, timing.VIEW_SWITCH_DELAY);
        }
        scheduleAiTurn(timing.AI_ACTION_DELAY);
    }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ°´å¬ 3x3 æ‰«æèŒƒå›´æ­£ç¡®
- [ ] éœ€è¦ DD å­˜æ´»æ‰èƒ½ä½¿ç”¨
- [ ] æœ‰ä¿¡å·æ—¶ï¼šä¸­å¿ƒç‚¹æ˜¾å½¢ + å‘¨å›´æ ‡è®°ç–‘ä¼¼
- [ ] æ— ä¿¡å·æ—¶ï¼šå…¨éƒ¨æ ‡è®° miss
- [ ] ä¸é€ æˆä¼¤å®³ï¼Œä¸è§¦å‘æ²‰èˆ¹

---

### Step 8ï¼šè¿ç§» AI é€»è¾‘

**ç›®æ ‡**ï¼šè®© AI ä¹Ÿä½¿ç”¨æ­¦å™¨ç³»ç»Ÿï¼Œåˆ é™¤é‡å¤ä»£ç 

#### 8.1 ä¿®æ”¹ aiStrategy.js ä½¿ç”¨æ­¦å™¨ç³»ç»Ÿè·å–èŒƒå›´

åœ¨ `aiStrategy.js` ä¸­ï¼Œ`_getWeaponCoverage` æ–¹æ³•ä¸æ­¦å™¨çš„ `previewArea` é‡å¤å®šä¹‰ã€‚éœ€è¦ç»Ÿä¸€ã€‚

**æ–¹æ¡ˆ Aï¼šä»æ­¦å™¨æ³¨å†Œä¸­å¿ƒè·å–ï¼ˆæ¨èï¼‰**

```javascript
// åœ¨ aiStrategy.js ä¸­

// å¯¼å…¥æ­¦å™¨æ³¨å†Œä¸­å¿ƒçš„å¼•ç”¨ï¼ˆéœ€è¦ä» game.js æš´éœ²ï¼‰
// æˆ–è€…ç›´æ¥å¯¼å…¥æ­¦å™¨ç±»

import { APWeapon } from '../game/weapons/APWeapon.js';
import { HEWeapon } from '../game/weapons/HEWeapon.js';
import { SonarWeapon } from '../game/weapons/SonarWeapon.js';

// åˆ›å»ºä¸´æ—¶å®ä¾‹ç”¨äºè·å–èŒƒå›´
const weaponInstances = {
    AP: new APWeapon(),
    HE: new HEWeapon(),
    SONAR: new SonarWeapon()
};

// ä¿®æ”¹ _getWeaponCoverage
_getWeaponCoverage(weapon, r, c) {
    const instance = weaponInstances[weapon];
    if (instance) {
        return instance.previewArea({ r, c }).cells;
    }
    return [{ r, c }];
}
```

#### 8.2 ä¿®æ”¹ game.js ä¸­çš„ aiTurn

```javascript
function aiTurn() {
    if (gameState !== 'PLAYING') return;
    
    // æ¸…é™¤ä¸Šä¸€æ¬¡çš„æ”»å‡»æ ‡è®°
    clearLastEnemyAttacks();

    // 1. AI å†³ç­–
    const decision = makeAIDecision({
        viewGrid: getAiViewGrid(),
        myShips,
        enemyShips,
        difficultyConfig: AI_PROB_CONFIG
    });

    // 2. ä½¿ç”¨æ­¦å™¨ç³»ç»Ÿæ‰§è¡Œ
    if (weaponService) {
        const context = buildAIWeaponContext();
        const result = weaponService.executeAIAction(decision, context);
        
        // 3. æ£€æŸ¥èƒœè´Ÿ
        if (decision.weapon !== 'SONAR' && result.shipsSunk?.length > 0) {
            checkWin("ç”µè„‘");
        }
    }

    // 4. æ›´æ–°çŠ¶æ€
    updateStatus();
    if (showAiDebug) updateAiHeatmapVisuals();
    
    // 5. å›åˆç»“æŸå¤„ç†
    const enemyGridEl = document.getElementById('enemy-grid');
    if (gameState === 'PLAYING') {
        enemyGridEl.style.pointerEvents = 'auto';
        const timing = getTiming();
        if (timing.TURN_BACK_DELAY > 0) {
            setTimeout(() => {
                if (gameState === 'PLAYING') switchMobileView('enemy');
            }, timing.TURN_BACK_DELAY);
        }
    } else {
        enemyGridEl.style.pointerEvents = 'none';
    }
}
```

#### 8.3 æ„å»º AI ä¸“ç”¨çš„ defenderGrid

AI æ”»å‡»ç©å®¶æ—¶ï¼Œéœ€è¦ä¸€ä¸ªä¸ `enemyGridMap` ç»“æ„ç›¸åŒçš„ç©å®¶ç½‘æ ¼ã€‚å½“å‰ `myGridMap` æ˜¯ç®€å•çš„ 0/1 çŸ©é˜µï¼Œéœ€è¦æ‰©å±•ï¼š

```javascript
// æ–°å¢ï¼šåˆ›å»º AI è§†è§’çš„ç©å®¶ç½‘æ ¼ï¼ˆä»…åœ¨ AI å›åˆæ—¶æ„å»ºï¼‰
function buildPlayerGridForAI() {
    const grid = [];
    for (let r = 0; r < BOARD_SIZE; r++) {
        grid[r] = [];
        for (let c = 0; c < BOARD_SIZE; c++) {
            // æŸ¥æ‰¾è¯¥ä½ç½®æ˜¯å¦æœ‰èˆ¹
            let shipId = -1;
            let segmentIndex = -1;
            
            for (const ship of myShips) {
                if (ship.vertical) {
                    if (c === ship.c && r >= ship.r && r < ship.r + ship.len) {
                        shipId = ship.id;
                        segmentIndex = r - ship.r;
                        break;
                    }
                } else {
                    if (r === ship.r && c >= ship.c && c < ship.c + ship.len) {
                        shipId = ship.id;
                        segmentIndex = c - ship.c;
                        break;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²è¢«æ”»å‡»ï¼ˆä» UI çŠ¶æ€æ¨æ–­ï¼‰
            const cell = document.querySelector(`#player-grid .cell[data-r="${r}"][data-c="${c}"]`);
            const hit = cell && (cell.classList.contains('hit') || 
                                  cell.classList.contains('destroyed') || 
                                  cell.classList.contains('miss'));
            
            grid[r][c] = { hit, shipId, segmentIndex };
        }
    }
    return grid;
}

function buildAIWeaponContext() {
    return {
        attackerShips: enemyShips.map(s => new ShipState(s)),
        defenderGrid: buildPlayerGridForAI(),
        defenderShips: myShips,
        isPlayer: false
    };
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] AI ä½¿ç”¨ `weaponService.executeAIAction` æ‰§è¡Œæ”»å‡»
- [ ] `aiStrategy.js` ä¸å†é‡å¤å®šä¹‰æ­¦å™¨èŒƒå›´
- [ ] AI æ”»å‡»çš„æ²‰èˆ¹æ£€æµ‹æ­£å¸¸
- [ ] AI æ”»å‡»å `last-enemy-attack` æ ·å¼æ­£ç¡®æ·»åŠ 

---

### Step 9ï¼šæ¸…ç†æ—§ä»£ç 

**ç›®æ ‡**ï¼šåˆ é™¤æ‰€æœ‰è¢«æ–°æ¶æ„æ›¿ä»£çš„ä»£ç ï¼Œç²¾ç®€ game.js

#### 9.1 åˆ é™¤ processHit å‡½æ•°

```javascript
// åˆ é™¤æ•´ä¸ª processHit å‡½æ•°ï¼ˆçº¦ 30 è¡Œï¼‰
// function processHit(r, c, dmg) { ... }
```

#### 9.2 åˆ é™¤ aiProcessHit å‡½æ•°

```javascript
// åˆ é™¤æ•´ä¸ª aiProcessHit å‡½æ•°ï¼ˆçº¦ 40 è¡Œï¼‰
// function aiProcessHit(r, c, dmg) { ... }
```

#### 9.3 ç®€åŒ– clickEnemy

åˆ é™¤æ‰€æœ‰æ­¦å™¨åˆ†æ”¯ï¼Œåªä¿ç•™å¯¹ `weaponService` çš„è°ƒç”¨ï¼š

```javascript
function clickEnemy(r, c) {
    if (gameState !== 'PLAYING') return;
    if (document.getElementById('enemy-grid').style.pointerEvents === 'none') return;

    weaponService.setCurrentWeapon(currentWeapon);
    const context = buildPlayerWeaponContext();
    const result = weaponService.executePlayerAction({ r, c }, context);
    
    if (!result.success) return;
    
    if (currentWeapon !== 'SONAR' && result.shipsSunk?.length > 0) {
        checkWin("ç©å®¶");
    }

    updateStatus();
    document.getElementById('enemy-grid').style.pointerEvents = 'none';
    
    if (gameState === 'PLAYING') {
        const timing = getTiming();
        if (timing.VIEW_SWITCH_DELAY > 0) {
            setTimeout(() => {
                if (gameState === 'PLAYING') switchMobileView('player');
            }, timing.VIEW_SWITCH_DELAY);
        }
        scheduleAiTurn(timing.AI_ACTION_DELAY);
    }
}
```

#### 9.4 ç®€åŒ– aiTurn

åˆ é™¤æ‰€æœ‰æ­¦å™¨åˆ†æ”¯ï¼š

```javascript
function aiTurn() {
    if (gameState !== 'PLAYING') return;
    clearLastEnemyAttacks();

    const decision = makeAIDecision({
        viewGrid: getAiViewGrid(),
        myShips,
        enemyShips,
        difficultyConfig: AI_PROB_CONFIG
    });

    const context = buildAIWeaponContext();
    const result = weaponService.executeAIAction(decision, context);
    
    if (decision.weapon !== 'SONAR' && result.shipsSunk?.length > 0) {
        checkWin("ç”µè„‘");
    }

    updateStatus();
    if (showAiDebug) updateAiHeatmapVisuals();
    
    const enemyGridEl = document.getElementById('enemy-grid');
    if (gameState === 'PLAYING') {
        enemyGridEl.style.pointerEvents = 'auto';
        const timing = getTiming();
        if (timing.TURN_BACK_DELAY > 0) {
            setTimeout(() => {
                if (gameState === 'PLAYING') switchMobileView('enemy');
            }, timing.TURN_BACK_DELAY);
        }
    } else {
        enemyGridEl.style.pointerEvents = 'none';
    }
}
```

#### 9.5 ç®€åŒ– handleEnemyGridHover

```javascript
function handleEnemyGridHover(r, c) {
    if (gameState !== 'PLAYING') return;
    if (document.getElementById('enemy-grid').style.pointerEvents === 'none') return;

    clearAttackHighlights();

    weaponService.setCurrentWeapon(currentWeapon);
    const preview = weaponService.getPreviewArea({ r, c });
    
    const eGrid = document.getElementById('enemy-grid');
    for (const pos of preview.cells) {
        if (isInBounds(pos.r, pos.c)) {
            const cell = eGrid.querySelector(`.cell[data-r="${pos.r}"][data-c="${pos.c}"]`);
            if (cell) cell.classList.add('attack-range-highlight');
        }
    }
}
```

#### 9.6 åˆ é™¤ AI ä¾§çš„è¾…åŠ©å‡½æ•°

```javascript
// åˆ é™¤ hasAlivePlayerSegmentï¼ˆå·²æ•´åˆåˆ° buildPlayerGridForAIï¼‰
// åˆ é™¤ markAiDetectionAreaï¼ˆç”± SonarResolver å¤„ç†ï¼‰
```

#### 9.7 æ¸…ç†å¯¼å…¥

åˆ é™¤ä¸å†éœ€è¦çš„ç›´æ¥ä¾èµ–ï¼Œä¿ç•™é€šè¿‡æ­¦å™¨ç³»ç»Ÿé—´æ¥ä½¿ç”¨çš„ï¼š

```javascript
// ä¿ç•™
import { WeaponRegistry } from './weapons/WeaponRegistry.js';
import { WeaponService } from './weapons/WeaponService.js';
import { BattleRenderer } from './battle/BattleRenderer.js';
import { APWeapon } from './weapons/APWeapon.js';
import { HEWeapon } from './weapons/HEWeapon.js';
import { SonarWeapon } from './weapons/SonarWeapon.js';
import { ShipState, isInBounds } from './weapons/WeaponTypes.js';
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `processHit` å’Œ `aiProcessHit` å·²åˆ é™¤
- [ ] `clickEnemy` ä¸å†æœ‰æ­¦å™¨åˆ†æ”¯
- [ ] `aiTurn` ä¸å†æœ‰æ­¦å™¨åˆ†æ”¯
- [ ] æ¸¸æˆæ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- [ ] ä»£ç è¡Œæ•°æ˜¾è‘—å‡å°‘ï¼ˆé¢„è®¡ game.js å‡å°‘ 150+ è¡Œï¼‰

---

### Step 10ï¼šæ–‡æ¡£æ›´æ–°ä¸å›å½’æµ‹è¯•

**ç›®æ ‡**ï¼šç¡®ä¿æ–‡æ¡£ä¸ä»£ç åŒæ­¥ï¼Œè¿›è¡Œå…¨é¢æµ‹è¯•

#### 10.1 æ›´æ–° docs/è®¾å®š.md

åœ¨é™„å½•çš„ AI æ™ºèƒ½é€»è¾‘éƒ¨åˆ†ï¼Œæ›´æ–°ä»£ç å¼•ç”¨ï¼š

```markdown
- **å…¬å¼å¼•ç”¨**ï¼šæ­¦å™¨ç³»ç»Ÿé‡æ„åï¼Œæ­¦å™¨èŒƒå›´å®šä¹‰é›†ä¸­åœ¨ `src/game/weapons/*.js`ï¼Œ
  AI é€šè¿‡å¯¼å…¥æ­¦å™¨ç±»è·å–èŒƒå›´ï¼Œä¸å†è‡ªè¡Œç»´æŠ¤ã€‚
- **æ‰©å±•æ–¹å¼**ï¼šæ–°å¢æ­¦å™¨ä»…éœ€å®ç° `WeaponBase` æ¥å£å¹¶æ³¨å†Œåˆ° `WeaponRegistry`ã€‚
```

#### 10.2 å›å½’æµ‹è¯•æ¸…å•

**åŸºç¡€åŠŸèƒ½**ï¼š
- [ ] éƒ¨ç½²é˜¶æ®µï¼šæ‹–æ‹½æ”¾ç½®ã€æ—‹è½¬ã€è‡ªåŠ¨éƒ¨ç½²
- [ ] æ­¦å™¨åˆ‡æ¢ï¼šAP/HE/SONAR æŒ‰é’®åˆ‡æ¢æ­£å¸¸
- [ ] æ­¦å™¨å¯ç”¨æ€§ï¼šCV æ²‰æ²¡å HE ç¦ç”¨ï¼ŒDD æ²‰æ²¡å SONAR ç¦ç”¨
- [ ] æ‚¬åœé«˜äº®ï¼šä¸‰ç§æ­¦å™¨çš„èŒƒå›´é«˜äº®æ­£ç¡®

**ä¸»ç‚®æ”»å‡»**ï¼š
- [ ] å•ç‚¹å‘½ä¸­/æœªå‘½ä¸­æ˜¾ç¤ºæ­£ç¡®
- [ ] ä¼¤å®³è®¡ç®—æ­£ç¡®ï¼ˆ3/2/1ï¼‰
- [ ] æ²‰èˆ¹åˆ¤å®šå’Œæ˜¾ç¤ºæ­£ç¡®

**ç©ºè¢­æ”»å‡»**ï¼š
- [ ] X å‹ 5 æ ¼æ”»å‡»èŒƒå›´æ­£ç¡®
- [ ] è·³è¿‡å·²å‘½ä¸­/å·²æ‘§æ¯æ ¼å­
- [ ] æ‰¹é‡æ²‰èˆ¹åˆ¤å®šæ­£ç¡®

**æ°´å¬æ‰«æ**ï¼š
- [ ] æœ‰ä¿¡å·æ—¶ä¸­å¿ƒç‚¹æ˜¾å½¢
- [ ] æœ‰ä¿¡å·æ—¶å‘¨å›´æ ‡è®°ç–‘ä¼¼
- [ ] æ— ä¿¡å·æ—¶å…¨éƒ¨æ ‡è®° miss

**AI è¡Œä¸º**ï¼š
- [ ] AI èƒ½æ­£ç¡®ä½¿ç”¨ä¸‰ç§æ­¦å™¨
- [ ] AI æ”»å‡»ä½ç½®æ ‡è®° `last-enemy-attack`
- [ ] AI æ²‰èˆ¹åˆ¤å®šæ­£ç¡®
- [ ] éš¾åº¦è®¾ç½®ç”Ÿæ•ˆ

**èƒœè´Ÿåˆ¤å®š**ï¼š
- [ ] ç©å®¶å…¨æ­¼æ•Œæ–¹è§¦å‘èƒœåˆ©
- [ ] AI å…¨æ­¼ç©å®¶è§¦å‘å¤±è´¥
- [ ] æ¸¸æˆç»“æŸå¼¹çª—æ­£å¸¸

**ç§»åŠ¨ç«¯**ï¼š
- [ ] è§†å›¾åˆ‡æ¢æ­£å¸¸
- [ ] æ­¦å™¨æ æ”¶èµ·/å±•å¼€æ­£å¸¸
- [ ] è§¦æ‘¸æ“ä½œæ­£å¸¸

#### 10.3 ç¼–å†™æ–°å¢æ­¦å™¨æ¨¡æ¿

åœ¨æ–‡æ¡£æœ«å°¾æä¾›å®Œæ•´çš„æ­¦å™¨æ¨¡æ¿ï¼Œæ–¹ä¾¿åç»­æ‰©å±•ï¼š

```javascript
// src/game/weapons/TemplateWeapon.js
import { WeaponBase } from './WeaponBase.js';
import { resolveHit } from '../battle/HitResolver.js';
import { createLogEvent, isInBounds } from './WeaponTypes.js';

export class TemplateWeapon extends WeaponBase {
    constructor() {
        super({ id: 'TEMPLATE', label: 'æ¨¡æ¿', icon: 'ğŸ”§' });
    }
    
    canUse(context) {
        // æ£€æŸ¥æ‰€éœ€èˆ¹åªæ˜¯å¦å­˜æ´»
        return context.attackerShips.some(s => s.code === 'XX' && !s.sunk);
    }
    
    previewArea(target) {
        // è¿”å›æ”»å‡»èŒƒå›´
        return { cells: [{ r: target.r, c: target.c }] };
    }
    
    isValidTarget(target, context) {
        // æ£€æŸ¥ç›®æ ‡æ˜¯å¦æœ‰æ•ˆ
        return super.isValidTarget(target, context);
    }
    
    resolve(target, context) {
        // æ‰§è¡Œæ”»å‡»é€»è¾‘
        const events = [];
        // ... å®ç°ç»†èŠ‚ ...
        return { events, shipsSunk: [] };
    }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `docs/è®¾å®š.md` å·²æ›´æ–°
- [ ] æ‰€æœ‰å›å½’æµ‹è¯•é€šè¿‡
- [ ] æ­¦å™¨æ¨¡æ¿ä»£ç å¯ç”¨

---

## 4. å…³é”®å®ç°ç»†èŠ‚

### 4.1 grid å­—æ®µæ³¨å…¥æœºåˆ¶

æ­¦å™¨çš„ `resolve` æ–¹æ³•è¿”å›çš„äº‹ä»¶**ä¸åº”åŒ…å« `grid` å­—æ®µ**ï¼Œè¿™æ˜¯ä¸ºäº†è®©æ­¦å™¨é€»è¾‘ä¸å…·ä½“çš„æ”»å‡»æ–¹å‘è§£è€¦ã€‚`grid` å­—æ®µç”± `WeaponService` åœ¨æ‰§è¡Œæ—¶ç»Ÿä¸€æ³¨å…¥ï¼š

```javascript
// WeaponService._injectGrid
_injectGrid(events, grid, markClass = null) {
    for (const event of events) {
        if (event.payload) {
            event.payload.grid = grid;  // 'PLAYER' æˆ– 'ENEMY'
            if (markClass && event.type === 'CELL_UPDATE') {
                event.payload.markClass = markClass;
            }
        }
    }
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
- ç©å®¶æ”»å‡»ï¼š`grid = 'ENEMY'`ï¼ˆæ”»å‡»æ•Œæ–¹ç½‘æ ¼ï¼‰
- AI æ”»å‡»ï¼š`grid = 'PLAYER'`ï¼Œ`markClass = 'last-enemy-attack'`

### 4.2 æ²‰èˆ¹å›è°ƒä¸ revealSingleEnemyShip

`BattleRenderer` é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¶ `onShipSunk` å›è°ƒï¼Œåœ¨æ¸²æŸ“ `SHIP_UPDATE` äº‹ä»¶ä¸” `sunk=true` æ—¶è§¦å‘ï¼š

```javascript
// game.js ä¸­çš„åˆå§‹åŒ–
battleRenderer = new BattleRenderer({
    logFn: log,
    onShipSunk: (shipId, grid) => {
        if (grid === 'ENEMY') {
            const ship = enemyShips.find(s => s.id === shipId);
            if (ship) revealSingleEnemyShip(ship);
        }
        // ç©å®¶èˆ¹åªæ²‰æ²¡æ—¶ï¼Œå·²ç»åœ¨ UI ä¸Šæ˜¾ç¤ºï¼Œæ— éœ€é¢å¤–å¤„ç†
    }
});
```

### 4.3 AI ä¸“ç”¨çš„ defenderGrid æ„å»º

ç”±äºç°æœ‰ `myGridMap` æ˜¯ç®€å•çš„ 0/1 çŸ©é˜µï¼Œä¸åŒ…å« `shipId` å’Œ `segmentIndex`ï¼Œéœ€è¦åœ¨ AI æ”»å‡»å‰åŠ¨æ€æ„å»ºï¼š

```javascript
function buildPlayerGridForAI() {
    const grid = [];
    for (let r = 0; r < BOARD_SIZE; r++) {
        grid[r] = [];
        for (let c = 0; c < BOARD_SIZE; c++) {
            let shipId = -1;
            let segmentIndex = -1;
            
            // éå†ç©å®¶èˆ¹åªæŸ¥æ‰¾ä½ç½®
            for (const ship of myShips) {
                const cells = [];
                for (let i = 0; i < ship.len; i++) {
                    cells.push(ship.vertical 
                        ? { r: ship.r + i, c: ship.c, idx: i }
                        : { r: ship.r, c: ship.c + i, idx: i }
                    );
                }
                const match = cells.find(cell => cell.r === r && cell.c === c);
                if (match) {
                    shipId = ship.id;
                    segmentIndex = match.idx;
                    break;
                }
            }
            
            // ä» DOM æ¨æ–­ hit çŠ¶æ€
            const cell = document.querySelector(
                `#player-grid .cell[data-r="${r}"][data-c="${c}"]`
            );
            const hit = cell && (
                cell.classList.contains('hit') || 
                cell.classList.contains('destroyed') || 
                cell.classList.contains('miss')
            );
            
            grid[r][c] = { hit, shipId, segmentIndex };
        }
    }
    return grid;
}
```

### 4.4 èƒœè´Ÿæ£€æŸ¥çš„ç»Ÿä¸€å¤„ç†

ç”±äº `SHIP_UPDATE` äº‹ä»¶å¯èƒ½åŒ…å«å¤šæ¬¡æ²‰èˆ¹ï¼ˆå¦‚ HE ä¸€æ¬¡å‡»æ²‰å¤šè‰˜ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ `shipsSunk` æ•°ç»„ï¼š

```javascript
// åœ¨ resolveMultiHit ä¸­æ”¶é›†
return { events: allEvents, shipsSunk: totalSunk };

// åœ¨è°ƒç”¨å¤„æ£€æŸ¥
if (result.shipsSunk?.length > 0) {
    checkWin(isPlayer ? "ç©å®¶" : "ç”µè„‘");
}
```

`checkWin` å‡½æ•°ä¿æŒä¸å˜ï¼Œä»ç„¶æ£€æŸ¥**æ‰€æœ‰èˆ¹åª**æ˜¯å¦æ²‰æ²¡ï¼Œè€Œéä»…çœ‹æœ¬æ¬¡äº‹ä»¶ã€‚

---

## 5. é£é™©è¯„ä¼°ä¸åº”å¯¹

| é£é™©é¡¹ | ç­‰çº§ | åº”å¯¹ç­–ç•¥ |
|--------|------|---------|
| æ¸²æŸ“é”™è¯¯ | ğŸ”´ é«˜ | åŒè·¯å¾„å¹¶è¡Œï¼Œé€æ­¦å™¨è¿ç§»ï¼Œå……åˆ†æµ‹è¯• |
| æ•°æ®ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­ | ä½¿ç”¨ ShipState å¿«ç…§ï¼Œé¿å…æ„å¤–ä¿®æ”¹åŸå¯¹è±¡ |
| AI é€»è¾‘å¤±æ•ˆ | ğŸŸ¡ ä¸­ | AI æœ€åè¿ç§»ï¼Œå…ˆç¡®ä¿ç©å®¶ä¾§ 3 ç§æ­¦å™¨ç¨³å®š |
| AI æ­¦å™¨èŒƒå›´é‡å¤å®šä¹‰ | ğŸŸ¡ ä¸­ | Step 8 ä¸­åŒæ­¥ä¿®æ”¹ aiStrategy.jsï¼Œç»Ÿä¸€ä»æ­¦å™¨ç±»è·å– |
| ç§»åŠ¨ç«¯æ—¶åºé”™ä¹± | ğŸŸ¡ ä¸­ | æ—¶åºæ§åˆ¶ä»£ç ä¿ç•™åœ¨ game.jsï¼Œä¸ä¸‹æ²‰åˆ°æ­¦å™¨å±‚ |
| æ€§èƒ½ä¸‹é™ | ğŸŸ¢ ä½ | å›åˆåˆ¶æ¸¸æˆï¼Œå¯¹è±¡åˆ›å»ºå¼€é”€å¯å¿½ç•¥ |

---

## 6. å®Œæ•´æ–‡ä»¶æ¸…å•

é‡æ„å®Œæˆåçš„æ–‡ä»¶ç»“æ„ï¼š

```
src/
â”œâ”€â”€ main.js
â”œâ”€â”€ ai/
â”‚   â””â”€â”€ aiStrategy.js              # ä¿®æ”¹ï¼šå¯¼å…¥æ­¦å™¨ç±»è·å–èŒƒå›´
â”œâ”€â”€ config/
â”‚   â””â”€â”€ constants.js
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ difficulties.js
â”‚   â””â”€â”€ ships.js
â”œâ”€â”€ game/
â”‚   â”œâ”€â”€ game.js                    # ä¿®æ”¹ï¼šç²¾ç®€ 150+ è¡Œ
â”‚   â”œâ”€â”€ weapons/
â”‚   â”‚   â”œâ”€â”€ WeaponTypes.js         # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ WeaponBase.js          # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ WeaponRegistry.js      # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ WeaponService.js       # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ APWeapon.js            # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ HEWeapon.js            # æ–°å¢
â”‚   â”‚   â””â”€â”€ SonarWeapon.js         # æ–°å¢
â”‚   â””â”€â”€ battle/
â”‚       â”œâ”€â”€ BattleRenderer.js      # æ–°å¢
â”‚       â”œâ”€â”€ HitResolver.js         # æ–°å¢
â”‚       â””â”€â”€ SonarResolver.js       # æ–°å¢
â””â”€â”€ styles/
    â”œâ”€â”€ base.css
    â””â”€â”€ ships.css
```

**æ–°å¢æ–‡ä»¶æ•°**ï¼š10  
**ä¿®æ”¹æ–‡ä»¶æ•°**ï¼š2 (game.js, aiStrategy.js)

---

## 7. æ–°å¢æ­¦å™¨ç¤ºä¾‹

é‡æ„å®Œæˆåï¼Œæ–°å¢æ­¦å™¨ä»…éœ€ï¼š

```javascript
// src/game/weapons/MissileWeapon.js
import { WeaponBase } from './WeaponBase.js';

export class MissileWeapon extends WeaponBase {
    constructor() {
        super({ id: 'MISSILE', label: 'å¯¼å¼¹', icon: 'ğŸš€' });
    }
    
    canUse(context) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å·¡æ´‹èˆ°
        return context.attackerShips.some(s => s.code === 'CL' && !s.sunk);
    }
    
    previewArea(target) {
        // 2x2 æ–¹å½¢åŒºåŸŸ
        const { r, c } = target;
        return {
            cells: [
                { r, c }, { r, c: c+1 },
                { r: r+1, c }, { r: r+1, c: c+1 }
            ]
        };
    }
    
    resolve(target, context) {
        // å®ç°æ”»å‡»é€»è¾‘...
    }
}

// åœ¨ game.js ä¸­æ³¨å†Œ
weaponRegistry.register(new MissileWeapon());
```

**æˆæœ¬å¯¹æ¯”**ï¼š
- æ—§æ¶æ„ï¼š~150è¡Œï¼Œæ”¹5å¤„
- æ–°æ¶æ„ï¼š~50è¡Œï¼Œæ”¹1å¤„

---

## 7. åç»­æ‰©å±•æ–¹å‘

- æ­¦å™¨å†·å´ç³»ç»Ÿ
- ä¼¤å®³ç±»å‹ä¸æŠ¤ç”²
- è¿å‡»æœºåˆ¶
- ç‰¹æ®Šæ•ˆæœï¼ˆDOTã€æ§åˆ¶ï¼‰
- æ­¦å™¨å‡çº§ç³»ç»Ÿ

ä»¥ä¸Šæ‰©å±•åœ¨æ–°æ¶æ„ä¸‹å‡å¯è½»æ¾å®ç°ã€‚

---

## é™„å½• Aï¼šStep éªŒæ”¶æ£€æŸ¥æ¸…å•æ±‡æ€»

### Step 1 éªŒæ”¶
- [ ] `WeaponTypes.js` åˆ›å»ºå®Œæˆ
- [ ] `CellState`ã€`EventType` æšä¸¾å®šä¹‰
- [ ] `ShipState` ç±»èƒ½æ­£ç¡®æ·±æ‹·è´
- [ ] å·¥å‚å‡½æ•°èƒ½åˆ›å»ºæ­£ç¡®æ ¼å¼çš„äº‹ä»¶

### Step 2 éªŒæ”¶
- [ ] `HitResolver.js` åˆ›å»ºå®Œæˆ
- [ ] `SonarResolver.js` åˆ›å»ºå®Œæˆ
- [ ] ä¸¤ä¸ªç»“ç®—å™¨ä¸åŒ…å«ä»»ä½• DOM æ“ä½œ
- [ ] è¿”å›äº‹ä»¶æ ¼å¼æ­£ç¡®

### Step 3 éªŒæ”¶
- [ ] `BattleRenderer.js` åˆ›å»ºå®Œæˆ
- [ ] èƒ½æ­£ç¡®æ¸²æŸ“ CELL_UPDATE äº‹ä»¶
- [ ] èƒ½æ­£ç¡®æ¸²æŸ“ LOG äº‹ä»¶
- [ ] `onShipSunk` å›è°ƒæ­£ç¡®è§¦å‘

### Step 4 éªŒæ”¶
- [ ] `WeaponBase.js` åˆ›å»ºå®Œæˆ
- [ ] `APWeapon.js` åˆ›å»ºå®Œæˆ
- [ ] `WeaponRegistry.js` åˆ›å»ºå®Œæˆ
- [ ] `WeaponService.js` åˆ›å»ºå®Œæˆ
- [ ] AP æ­¦å™¨ä¼¤å®³è®¡ç®—æ­£ç¡®

### Step 5 éªŒæ”¶
- [ ] game.js å¯¼å…¥æ­¦å™¨ç³»ç»Ÿ
- [ ] `initWeaponSystem()` åˆå§‹åŒ–æ­£ç¡®
- [ ] `buildPlayerWeaponContext()` æ„å»ºæ­£ç¡®
- [ ] AP æ­¦å™¨ä½¿ç”¨æ–°è·¯å¾„ï¼ŒåŠŸèƒ½æ­£å¸¸
- [ ] HE/SONAR ä½¿ç”¨æ—§è·¯å¾„ï¼ŒåŠŸèƒ½æ­£å¸¸
- [ ] æ‚¬åœé«˜äº®æ­£å¸¸

### Step 6 éªŒæ”¶
- [ ] `HEWeapon.js` åˆ›å»ºå®Œæˆ
- [ ] ç©ºè¢­èŒƒå›´æ­£ç¡®ï¼ˆX å‹ 5 æ ¼ï¼‰
- [ ] CV æ²‰æ²¡åç¦ç”¨
- [ ] è·³è¿‡æ— æ•ˆæ ¼å­
- [ ] æ²‰èˆ¹æ£€æµ‹æ­£å¸¸

### Step 7 éªŒæ”¶
- [ ] `SonarWeapon.js` åˆ›å»ºå®Œæˆ
- [ ] æ‰«æèŒƒå›´æ­£ç¡®ï¼ˆ3x3ï¼‰
- [ ] DD æ²‰æ²¡åç¦ç”¨
- [ ] æœ‰ä¿¡å·/æ— ä¿¡å·å¤„ç†æ­£ç¡®
- [ ] ä¸è§¦å‘æ²‰èˆ¹ï¼ˆ0 ä¼¤å®³ï¼‰

### Step 8 éªŒæ”¶
- [ ] `buildPlayerGridForAI()` æ„å»ºæ­£ç¡®
- [ ] AI ä½¿ç”¨ `executeAIAction` æ‰§è¡Œ
- [ ] `aiStrategy.js` ä½¿ç”¨æ­¦å™¨ç±»è·å–èŒƒå›´
- [ ] AI æ”»å‡»æ ‡è®°æ­£ç¡®
- [ ] AI æ²‰èˆ¹æ£€æµ‹æ­£å¸¸

### Step 9 éªŒæ”¶
- [ ] `processHit` å·²åˆ é™¤
- [ ] `aiProcessHit` å·²åˆ é™¤
- [ ] `clickEnemy` æ— æ­¦å™¨åˆ†æ”¯
- [ ] `aiTurn` æ— æ­¦å™¨åˆ†æ”¯
- [ ] æ¸¸æˆåŠŸèƒ½æ­£å¸¸

### Step 10 éªŒæ”¶
- [ ] `docs/è®¾å®š.md` å·²æ›´æ–°
- [ ] å›å½’æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ­¦å™¨æ¨¡æ¿å¯ç”¨

---

## é™„å½• Bï¼šå¸¸è§é—®é¢˜æ’æŸ¥

### Q1ï¼šæ­¦å™¨æ‰§è¡Œå UI ä¸æ›´æ–°

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ `BattleRenderer` æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
2. æ£€æŸ¥äº‹ä»¶çš„ `grid` å­—æ®µæ˜¯å¦è¢«æ­£ç¡®æ³¨å…¥
3. æ£€æŸ¥ DOM é€‰æ‹©å™¨ `#enemy-grid` / `#player-grid` æ˜¯å¦æ­£ç¡®

### Q2ï¼šæ²‰èˆ¹å `revealSingleEnemyShip` æœªè§¦å‘

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ `onShipSunk` å›è°ƒæ˜¯å¦ä¼ å…¥ `BattleRenderer`
2. æ£€æŸ¥ `SHIP_UPDATE` äº‹ä»¶çš„ `sunk` å­—æ®µæ˜¯å¦ä¸º `true`
3. æ£€æŸ¥ `grid` å­—æ®µæ˜¯å¦ä¸º `'ENEMY'`

### Q3ï¼šAI æ”»å‡»æ—¶ `last-enemy-attack` æ ·å¼æœªæ·»åŠ 

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ `_injectGrid` æ˜¯å¦ä¼ å…¥ `markClass` å‚æ•°
2. æ£€æŸ¥ `BattleRenderer._renderCellUpdate` æ˜¯å¦å¤„ç† `markClass`

### Q4ï¼šä¼¤å®³è®¡ç®—é”™è¯¯

**æ’æŸ¥**ï¼š
1. æ£€æŸ¥ `APWeapon._calculateDamage` é€»è¾‘
2. æ£€æŸ¥ `context.attackerShips` æ˜¯å¦æ­£ç¡®ä¼ å…¥
3. æ£€æŸ¥ `ShipState` æ˜¯å¦æ­£ç¡®å¤åˆ¶äº† `sunk` çŠ¶æ€

### Q5ï¼šAI å†³ç­–æ—¶æ­¦å™¨èŒƒå›´ä¸ä¸€è‡´

**æ’æŸ¥**ï¼š
1. ç¡®è®¤ `aiStrategy.js` å·²ä¿®æ”¹ä¸ºä½¿ç”¨æ­¦å™¨ç±»
2. ç¡®è®¤æ­¦å™¨å®ä¾‹å·²æ­£ç¡®åˆ›å»º
3. å¯¹æ¯” `previewArea` è¿”å›å€¼ä¸é¢„æœŸ
