<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÊåáÊå•ÂÆòÔºöÂÜ≥ÊàòÂ§ßÊ¥ã</title>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const g=8,ze=40,St="Êµ∑ÊùÉ:ÂÜ≥ÊàòÊ∑±Ëìù",At="v3.1Œ±",J={MOBILE_BREAKPOINT:768,MOBILE:{VIEW_SWITCH_DELAY:750,AI_ACTION_DELAY:800,TURN_BACK_DELAY:1e3},DESKTOP:{VIEW_SWITCH_DELAY:0,AI_ACTION_DELAY:0,TURN_BACK_DELAY:0}},j=[{name:"Ëà™Á©∫ÊØçËà∞",len:4,maxHp:2,code:"CV",type:"carrier"},{name:"ÊàòÂàóËà∞",len:4,maxHp:3,code:"BB",type:"battleship"},{name:"ËΩªÂ∑°Ê¥ãËà∞",len:3,maxHp:1,code:"CL",type:"cruiser"},{name:"ÊΩúËâá",len:1,maxHp:2,code:"SS",type:"sub"},{name:"È©±ÈÄêËà∞",len:2,maxHp:1,code:"DD",type:"destroyer"}],Ye={EASY:{alpha:.25,randomness:.6,riskAwareness:.05},NORMAL:{alpha:.5,randomness:.3,riskAwareness:.1},HARD:{alpha:.85,randomness:0,riskAwareness:.5}},Fe="EASY";class fe{constructor({id:e,label:t,icon:n}){this.id=e,this.label=t,this.icon=n}canUse(e){throw new Error("Â≠êÁ±ªÂøÖÈ°ªÂÆûÁé∞ canUse ÊñπÊ≥ï")}isValidTarget(e,t){const{r:n,c:i}=e,r=t.defenderGrid[n]?.[i];return!(!r||r.hit&&r.shipId===-1)}previewArea(e){throw new Error("Â≠êÁ±ªÂøÖÈ°ªÂÆûÁé∞ previewArea ÊñπÊ≥ï")}resolve(e,t){throw new Error("Â≠êÁ±ªÂøÖÈ°ªÂÆûÁé∞ resolve ÊñπÊ≥ï")}}const C={CELL_UPDATE:"CELL_UPDATE",SHIP_UPDATE:"SHIP_UPDATE",LOG:"LOG",EFFECT:"EFFECT"};class Ke{constructor(e){this.id=e.id,this.code=e.code,this.name=e.name,this.len=e.len,this.maxHp=e.maxHp,this.hp=[...e.hp],this.sunk=e.sunk,this.r=e.r??-1,this.c=e.c??-1,this.vertical=e.vertical??!1}}function $(s,e,t,n=null){return{type:C.CELL_UPDATE,payload:{r:s,c:e,state:t,markClass:n}}}function De(s,e,t,n){return{type:C.SHIP_UPDATE,payload:{shipId:s,segmentIndex:e,newHp:t,sunk:n}}}function X(s,e){return{type:C.LOG,payload:{message:s,className:e}}}function H(s,e){return s>=0&&s<g&&e>=0&&e<g}function Ve(s,e,t,n,i,r){const o=[];if(!H(s,e))return{events:[],hitShip:null,sunk:!1};const a=n[s][e];if(a.hit&&a.shipId===-1)return{events:[],hitShip:null,sunk:!1};if(a.hit=!0,a.shipId!==-1){const l=i[a.shipId],c=a.segmentIndex;if(l.hp[c]<=0)return{events:[],hitShip:l,sunk:!1};t>0&&(l.hp[c]-=t);const d=l.hp[c]<=0?"DESTROYED":"HIT";o.push($(s,e,d)),o.push(De(l.id,c,l.hp[c],!1));const u=l.hp.every(f=>f<=0)&&!l.sunk;if(u){l.sunk=!0,o.push(De(l.id,-1,0,!0));const f=r?"c-warn":"c-e",m=r?`ÊàòÊä•ÔºöÊïåÊñπ„Äê${l.name}„ÄëÁ°ÆËÆ§Ê≤âÊ≤°ÔºÅ`:`‰∏•ÈáçË≠¶Êä•ÔºöÊàëÊñπ„Äê${l.name}„ÄëÊ≤âÊ≤°ÔºÅ`;o.push(X(m,f))}return{events:o,hitShip:l,sunk:u}}else return o.push($(s,e,"MISS")),{events:o,hitShip:null,sunk:!1}}function wt(s,e,t,n,i){const r=[],o=[];for(const{r:a,c:l}of s){const c=Ve(a,l,e,t,n,i);r.push(...c.events),c.sunk&&o.push(c.hitShip.id)}return{events:r,shipsSunk:o}}class ge extends fe{constructor(){super({id:"AP",label:"‰∏ªÁÇÆ",icon:"üí•"})}canUse(e){return!0}isValidTarget(e,t){if(!super.isValidTarget(e,t))return!1;const{r:n,c:i}=e,r=t.defenderGrid[n][i];return!(r.hit&&r.shipId!==-1&&t.defenderShips[r.shipId].hp[r.segmentIndex]<=0)}previewArea(e){return{cells:[{r:e.r,c:e.c}]}}resolve(e,t){const{r:n,c:i}=e,r=this._calculateDamage(t.attackerShips),o=Ve(n,i,r,t.defenderGrid,t.defenderShips,t.isPlayer),a=t.isPlayer?"c-p":"c-e",l=t.isPlayer?"‰ΩøÁî®":"ÊïåÊñπ‰ΩøÁî®";o.events.unshift(X(`${l}‰∏ªÁÇÆÊîªÂáª (${n+1},${i+1})Ôºå‰º§ÂÆ≥: ${r}`,a));const c=o.sunk?[o.hitShip.id]:[];return{events:o.events,shipsSunk:c}}_calculateDamage(e){const t=e.some(r=>r.code==="BB"&&!r.sunk),n=e.some(r=>r.code==="SS"&&!r.sunk),i=e.some(r=>r.code==="CL"&&!r.sunk);return t?3:n||i?2:1}}class me extends fe{constructor(){super({id:"HE",label:"Á©∫Ë¢≠",icon:"‚úàÔ∏è"})}canUse(e){return e.attackerShips.some(t=>t.code==="CV"&&!t.sunk)}previewArea(e){const{r:t,c:n}=e;return{cells:[[0,0],[-1,-1],[-1,1],[1,-1],[1,1]].map(([o,a])=>({r:t+o,c:n+a})).filter(o=>H(o.r,o.c))}}isValidTarget(e,t){return H(e.r,e.c)}resolve(e,t){const{r:n,c:i}=e,o=this.previewArea(e).cells.filter(d=>{const u=t.defenderGrid[d.r][d.c];return!(u.hit&&u.shipId===-1||u.hit&&u.shipId!==-1&&t.defenderShips[u.shipId].hp[u.segmentIndex]<=0)}),a=wt(o,1,t.defenderGrid,t.defenderShips,t.isPlayer),l=t.isPlayer?"c-p":"c-e",c=t.isPlayer?"ÂëºÂè´":"ÊïåÊñπÂèëÂä®";return a.events.unshift(X(`${c}Á©∫Ë¢≠Ë¶ÜÁõñ (${n+1},${i+1}) Âë®ËæπÔºåÊâìÂáªÁÇπÊï∞: ${o.length}`,l)),{events:a.events,shipsSunk:a.shipsSunk}}}function xt(s,e,t,n,i){const r=[];let o=0;const a=[];for(let c=-1;c<=1;c++)for(let d=-1;d<=1;d++){const u=s+c,f=e+d;if(!H(u,f))continue;a.push({r:u,c:f,isCenter:c===0&&d===0});const m=t[u][f];m.shipId!==-1&&!m.hit&&o++}const l=i?"":"ÊïåÊñπ";if(o===0){for(const{r:c,c:d}of a){const u=t[c][d];u.hit||(u.hit=!0,r.push($(c,d,"MISS")))}return r.push(X(`${l}Â£∞Á∫≥Êâ´Êèè (${s+1},${e+1}) Âå∫ÂüüÔºöÊó†ÂèçÂ∫î„ÄÇ`,"c-sys")),{events:r,hasSignal:!1}}else{const c=t[s][e];c.hit||(c.hit=!0,c.shipId!==-1?r.push($(s,e,"HIT")):r.push($(s,e,"MISS")));for(const{r:d,c:u,isCenter:f}of a){if(f)continue;t[d][u].hit||r.push($(d,u,"SUSPECT"))}return r.push(X(`${l}Â£∞Á∫≥Êâ´Êèè (${s+1},${e+1}) Âå∫ÂüüÔºöÂèëÁé∞‰ø°Âè∑ÔºÅÂë®ËæπÊ†áËÆ∞‰∏∫Áñë‰ºº„ÄÇ`,"c-warn")),{events:r,hasSignal:!0}}}class pe extends fe{constructor(){super({id:"SONAR",label:"Ê∞¥Âê¨",icon:"üì°"})}canUse(e){return e.attackerShips.some(t=>(t.code==="DD"||t.code==="SS")&&!t.sunk)}previewArea(e){const{r:t,c:n}=e,i=[];for(let r=-1;r<=1;r++)for(let o=-1;o<=1;o++){const a=t+r,l=n+o;H(a,l)&&i.push({r:a,c:l})}return{cells:i}}isValidTarget(e,t){return H(e.r,e.c)}resolve(e,t){const{r:n,c:i}=e;return{events:xt(n,i,t.defenderGrid,t.defenderShips,t.isPlayer).events,shipsSunk:[]}}}const qe={AP:new ge,HE:new me,SONAR:new pe},b={UNKNOWN:0,MISS:1,HIT:2,DESTROYED:3,SUSPECT:4,SUNK:5},It=700,kt=50,Xe=5,D=1e-10;let M=null;function he(){return Array(g).fill(0).map(()=>Array(g).fill(0))}function Bt(){M=he()}function Tt(s,e){M||(M=he());const{weapon:t,r:n,c:i}=s;if(t!=="SONAR"){if(t==="AP")n>=0&&n<g&&i>=0&&i<g&&(M[n][i]+=e.apDamage);else if(t==="HE"){const r=[[0,0],[-1,-1],[-1,1],[1,-1],[1,1]];for(const[o,a]of r){const l=n+o,c=i+a;l>=0&&l<g&&c>=0&&c<g&&(M[l][c]+=1)}}}}function Lt(s){const{viewGrid:e,myShips:t,enemyShips:n,difficultyConfig:i,playerViewGrid:r}=s,{alpha:o=.5,randomness:a=0,riskAwareness:l=0}=i,c=ve(n),d=t.filter(w=>!w.sunk);if(d.length===0)return Ne(e);if(Math.random()<a)return Ct(e,c);const u=new ye(d,e),f=je(e,c);if(f.length===0)return Ne(e);let m=null;l>0&&r&&(m=_t(r,n,t,o,Xe));let p=null,h=-1/0;const v=[];for(const w of f){const I=K(u,w,c,o);let E=I;if(m&&l>0){const A=Ut(w,m,u,c,n,o);E=I*(1+l*A)}E>h+1e-9?(h=E,v.length=0,v.push(w)):Math.abs(E-h)<1e-9&&v.push(w)}return p=v[Math.floor(Math.random()*v.length)],Tt(p,c),p}class ye{constructor(e,t,n=It){this.ships=e,this.viewGrid=t,this.boardSize=g,this.constraints=this._buildConstraints(),this.samples=this._sampleConfigurations(n),this._probabilityGrid=null,this._entropy=null}_buildConstraints(){const e=[],t=[],n=[];for(let i=0;i<this.boardSize;i++)for(let r=0;r<this.boardSize;r++){const o=this.viewGrid[i][r];o===b.HIT||o===b.DESTROYED?e.push({r:i,c:r}):o===b.MISS||o===b.SUNK?t.push({r:i,c:r}):o===b.SUSPECT&&n.push({r:i,c:r})}return{mustHit:e,mustAvoid:t,suspect:n}}_sampleConfigurations(e){const t=[];let n=0;const i=e*20;for(;t.length<e&&n<i;){n++;const r=this._sampleOneConfiguration();r&&t.push(r)}for(;t.length<e&&t.length>0;)t.push(t[Math.floor(Math.random()*t.length)]);return t}_sampleOneConfiguration(){const e=new Set,t=[],n=[...this.ships].sort((i,r)=>r.len-i.len);for(const i of n){const r=this._sampleShipPlacement(i,e);if(!r)return null;t.push(r),r.cells.forEach(o=>e.add(`${o.r},${o.c}`))}return this._validateMustHit(t)?t:null}_sampleShipPlacement(e,t){const n=[];for(let o=0;o<=1;o++){const a=o===1,l=a?this.boardSize-e.len:this.boardSize-1,c=a?this.boardSize-1:this.boardSize-e.len;for(let d=0;d<=l;d++)for(let u=0;u<=c;u++){const f=[];let m=!0,p=0,h=0;for(let v=0;v<e.len;v++){const w=a?d+v:d,I=a?u:u+v,E=`${w},${I}`;if(t.has(E)){m=!1;break}const A=this.viewGrid[w][I];if(A===b.MISS||A===b.SUNK){m=!1;break}f.push({r:w,c:I}),(A===b.HIT||A===b.DESTROYED)&&p++,A===b.SUSPECT&&h++}if(m){const v=1+p*10+h*2;n.push({cells:f,weight:v,shipId:e.id})}}}if(n.length===0)return null;const i=n.reduce((o,a)=>o+a.weight,0);let r=Math.random()*i;for(const o of n)if(r-=o.weight,r<=0)return o;return n[n.length-1]}_validateMustHit(e){const t=new Set;for(const n of e)for(const i of n.cells){const r=this.viewGrid[i.r][i.c];(r===b.HIT||r===b.DESTROYED)&&t.add(`${i.r},${i.c}`)}for(const n of this.constraints.mustHit)if(!t.has(`${n.r},${n.c}`))return!1;return!0}getProbabilityGrid(){if(this._probabilityGrid)return this._probabilityGrid;const e=Array(this.boardSize).fill(0).map(()=>Array(this.boardSize).fill(0));if(this.samples.length===0)return e;for(const n of this.samples)for(const i of n)for(const r of i.cells)e[r.r][r.c]++;const t=this.samples.length;for(let n=0;n<this.boardSize;n++)for(let i=0;i<this.boardSize;i++)e[n][i]/=t;for(let n=0;n<this.boardSize;n++)for(let i=0;i<this.boardSize;i++){const r=this.viewGrid[n][i];r===b.HIT?e[n][i]=1:(r===b.MISS||r===b.DESTROYED||r===b.SUNK)&&(e[n][i]=0)}return this._probabilityGrid=e,e}getEntropy(){if(this._entropy!==null)return this._entropy;const e=this.getProbabilityGrid();let t=0;for(let n=0;n<this.boardSize;n++)for(let i=0;i<this.boardSize;i++){const r=this.viewGrid[n][i];if(r===b.UNKNOWN||r===b.SUSPECT){const o=e[n][i];o>D&&o<1-D&&(t-=o*Math.log2(o)+(1-o)*Math.log2(1-o))}}return this._entropy=t,t}getConditionalEntropy(e){const{weapon:t,r:n,c:i}=e,r=this.getProbabilityGrid();return t==="SONAR"?this._getSonarConditionalEntropy(n,i,r):this._getAttackConditionalEntropy(e,r)}_getSonarConditionalEntropy(e,t,n){const i=e>=0&&e<this.boardSize&&t>=0&&t<this.boardSize?n[e][t]:0;let r=0,o=0;for(let d=-1;d<=1;d++)for(let u=-1;u<=1;u++){const f=e+d,m=t+u;if(f>=0&&f<this.boardSize&&m>=0&&m<this.boardSize){const p=this.viewGrid[f][m];if(p===b.UNKNOWN||p===b.SUSPECT){const h=n[f][m];h>D&&h<1-D&&(r+=-h*Math.log2(h)-(1-h)*Math.log2(1-h),o++)}}}if(o===0)return this.getEntropy();const a=this.getEntropy(),l=this._cellEntropy(i),c=i*(a-l)+(1-i)*(a-r);return Math.max(0,a-Math.max(0,a-c))}_getAttackConditionalEntropy(e,t){const{weapon:n,r:i,c:r}=e,o=this.getEntropy(),a=this._getWeaponCoverage(n,i,r);let l=0;for(const c of a)if(c.r>=0&&c.r<this.boardSize&&c.c>=0&&c.c<this.boardSize){const d=this.viewGrid[c.r][c.c];if(d===b.UNKNOWN||d===b.SUSPECT){const u=t[c.r][c.c];l+=this._cellEntropy(u)}}return Math.max(0,o-l)}_cellEntropy(e){return e<D||e>1-D?0:-e*Math.log2(e)-(1-e)*Math.log2(1-e)}_getWeaponCoverage(e,t,n){const i=qe[e];return i?i.previewArea({r:t,c:n}).cells:[{r:t,c:n}]}}function K(s,e,t,n){const{weapon:i,r,c:o}=e,a=s.getProbabilityGrid(),l=s.getEntropy(),c=s.getConditionalEntropy(e),d=Math.max(0,l-c),u=l>D?d/l:0,f=Math.max(...s.ships.map(v=>v.maxHp??1)),m=Pt(e,a,t,f),p=i==="HE"?5:i==="AP"?t.apDamage:0,h=p>0?m/p:0;return i==="SONAR"?n*u:n*u+(1-n)*h}function Pt(s,e,t,n){const{weapon:i,r,c:o}=s;if(i==="SONAR")return 0;M||(M=he());let a=0;const l=i==="AP"?t.apDamage:1;if(i==="AP"){if(r>=0&&r<g&&o>=0&&o<g){const c=Ge(r,o,l,n);a=e[r][o]*c}}else if(i==="HE"){const c=[[0,0],[-1,-1],[-1,1],[1,-1],[1,1]];for(const[d,u]of c){const f=r+d,m=o+u;if(f>=0&&f<g&&m>=0&&m<g){const p=Ge(f,m,1,n);a+=e[f][m]*p}}}return a}function Ge(s,e,t,n){const i=M[s][e],r=Math.max(0,n-i);return Math.min(t,r)}function je(s,e){const t=[];for(let n=0;n<g;n++)for(let i=0;i<g;i++){const r=s[n][i];if(!(r===b.MISS||r===b.SUNK)){if(r===b.DESTROYED){e.canUseAir&&t.push({weapon:"HE",r:n,c:i});continue}t.push({weapon:"AP",r:n,c:i}),e.canUseAir&&t.push({weapon:"HE",r:n,c:i}),e.canUseSonar&&(r===b.UNKNOWN||r===b.SUSPECT)&&t.push({weapon:"SONAR",r:n,c:i})}}return t}function ve(s){const e=s.some(a=>a.code==="CV"&&!a.sunk),t=s.some(a=>a.code==="CL"&&!a.sunk),n=s.some(a=>a.code==="BB"&&!a.sunk),i=s.some(a=>a.code==="SS"&&!a.sunk),r=s.some(a=>a.code==="DD"&&!a.sunk);let o=1;return n?o=3:(i||t)&&(o=2),{canUseAir:e,canUseSonar:r||i,apDamage:o}}function Ct(s,e){let t,n,i=0;do t=Math.floor(Math.random()*g),n=Math.floor(Math.random()*g),i++;while((s[t][n]===b.MISS||s[t][n]===b.DESTROYED||s[t][n]===b.SUNK)&&i<200);return e.canUseAir&&Math.random()<.1?{r:t,c:n,weapon:"HE"}:e.canUseSonar&&Math.random()<.1?{r:t,c:n,weapon:"SONAR"}:{r:t,c:n,weapon:"AP"}}function Ne(s){for(let e=0;e<g;e++)for(let t=0;t<g;t++){const n=s[e][t];if(n!==b.MISS&&n!==b.DESTROYED&&n!==b.SUNK)return{r:e,c:t,weapon:"AP"}}return{r:0,c:0,weapon:"AP"}}function Qe(s,e,t){const n=qe[s];return n?n.previewArea({r:e,c:t}).cells:[{r:e,c:t}]}function Mt(s){const e=[],t=s.v??s.vertical??!1;for(let n=0;n<s.len;n++)e.push({r:t?s.r+n:s.r,c:t?s.c:s.c+n});return e}function _t(s,e,t,n,i=Xe){const r=ve(t),o=e.filter(c=>!c.sunk);if(o.length===0)return new Map;const a=new Map;for(const c of o){const d=Array.isArray(c.hp)?c.hp.reduce((u,f)=>u+f,0):c.hp??c.len;a.set(c.id,{totalExpectedDamage:0,remainingHp:d})}let l=s.map(c=>[...c]);for(let c=0;c<i;c++){const d=new ye(o,l,kt),u=d.getProbabilityGrid(),f=je(l,r);if(f.length===0)break;let m=null,p=-1/0;for(const h of f){const v=K(d,h,r,n);v>p&&(p=v,m=h)}if(!m)break;Dt(m,u,r,e,a),Gt(l,m,r,u)}for(const[c,d]of a){const u=e.find(f=>f.id===c);if(u){const f=Array.isArray(u.hp)?u.hp.reduce((m,p)=>m+p,0):u.hp??u.len;d.sinkProbability=Math.min(1,d.totalExpectedDamage/Math.max(1,f))}}return a}function Dt(s,e,t,n,i){const{weapon:r,r:o,c:a}=s;if(r==="SONAR")return;const l=Qe(r,o,a),c=r==="AP"?t.apDamage:1;for(const d of l)if(!(d.r<0||d.r>=g||d.c<0||d.c>=g))for(const u of n){if(u.sunk)continue;if(Mt(u).some(p=>p.r===d.r&&p.c===d.c)){const p=i.get(u.id);p&&(p.totalExpectedDamage+=e[d.r][d.c]*c)}}}function Gt(s,e,t,n){const{weapon:i,r,c:o}=e,a=Qe(i,r,o);for(const l of a)l.r>=0&&l.r<g&&l.c>=0&&l.c<g&&(s[l.r][l.c]===b.UNKNOWN||s[l.r][l.c]===b.SUSPECT)&&(n[l.r][l.c]>.5?s[l.r][l.c]=b.HIT:s[l.r][l.c]=b.MISS)}function Nt(s,e){return s.weapon==="HE"?e.canUseAir:s.weapon==="SONAR"?e.canUseSonar:!0}function Rt(s,e,t,n,i){if(!Nt(s,n))return K(e,s,t,i);const o=K(e,s,t,i),a=K(e,s,n,i);return Math.max(0,o-a)}function $t(s,e){const t=s.filter(n=>n.id!==e.id&&!n.sunk);return ve(t)}function Ut(s,e,t,n,i,r){let o=0,a=0;for(const l of i){if(l.sunk)continue;const c=e.get(l.id);if(!c||c.sinkProbability<.2)continue;a++;const d=$t(i,l),u=Rt(s,t,n,d,r);o+=c.sinkProbability*u}return a>0?o/a:0}function Ht(s,e,t=null){if(!e||e.length===0)return Array(g).fill(0).map(()=>Array(g).fill(0));const n=e.filter(r=>!r.sunk);return n.length===0?Array(g).fill(0).map(()=>Array(g).fill(0)):new ye(n,s).getProbabilityGrid()}const Ot=5,Wt=1.5;function be(s,e=g){const t=[],n=Yt(e),i=zt([...s]);for(const r of i){const o=Kt(r,n,t,e);o?(Ft(n,o.r,o.c,r.len,o.v),t.push({...r,r:o.r,c:o.c,v:o.v})):console.error("AI ÈÉ®ÁΩ≤Â§±Ë¥•ÔºöÊó†Ê≥ïÊîæÁΩÆËàπÂè™",r.name)}return t}function zt(s){for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[s[e],s[t]]=[s[t],s[e]]}return s}function Yt(s){return Array(s).fill(0).map(()=>Array(s).fill(0))}function Ft(s,e,t,n,i){for(let r=0;r<n;r++){const o=i?e+r:e,a=i?t:t+r;s[o][a]=1}}function Kt(s,e,t,n){const i=[];for(let a=0;a<=1;a++){const l=a===1,c=l?n-s.len:n-1,d=l?n-1:n-s.len;for(let u=0;u<=c;u++)for(let f=0;f<=d;f++)if(Vt(e,u,f,s.len,l,n)){const m=qt(u,f,s.len,l,t);i.push({r:u,c:f,v:l,minDist:m})}}if(i.length===0)return null;if(t.length===0)return i[Math.floor(Math.random()*i.length)];for(let a=Ot;a>=Wt;a-=.5){const l=i.filter(c=>c.minDist>=a);if(l.length>0)return l[Math.floor(Math.random()*l.length)]}i.sort((a,l)=>l.minDist-a.minDist);const r=Math.min(5,i.length),o=i.slice(0,r);return o[Math.floor(Math.random()*o.length)]}function Vt(s,e,t,n,i,r){for(let o=0;o<n;o++){const a=i?e+o:e,l=i?t:t+o;if(a>=r||l>=r||s[a][l]===1)return!1}return!0}function qt(s,e,t,n,i){if(i.length===0)return 1/0;let r=1/0;const o=[];for(let a=0;a<t;a++)o.push({r:n?s+a:s,c:n?e:e+a});for(const a of i)for(let l=0;l<a.len;l++){const c=a.v?a.r+l:a.r,d=a.v?a.c:a.c+l;for(const u of o){const f=Math.sqrt(Math.pow(u.r-c,2)+Math.pow(u.c-d,2));r=Math.min(r,f)}}return r}class Xt{constructor(){this._weapons=new Map}register(e){this._weapons.set(e.id,e)}get(e){return this._weapons.get(e)}getAll(){return Array.from(this._weapons.values())}has(e){return this._weapons.has(e)}}class jt{constructor(e,t){this.registry=e,this.renderer=t,this.currentWeaponId="AP"}setCurrentWeapon(e){this.registry.has(e)&&(this.currentWeaponId=e)}getCurrentWeapon(){return this.registry.get(this.currentWeaponId)}getPreviewArea(e){const t=this.getCurrentWeapon();return t?t.previewArea(e):{cells:[]}}executePlayerAction(e,t){const n=this.getCurrentWeapon();if(!n)return{success:!1,events:[],shipsSunk:[],reason:"Ê≠¶Âô®‰∏çÂ≠òÂú®"};if(!n.canUse(t))return{success:!1,events:[],shipsSunk:[],reason:"Ê≠¶Âô®‰∏çÂèØÁî®"};if(!n.isValidTarget(e,t))return{success:!1,events:[],shipsSunk:[],reason:"ÁõÆÊ†áÊó†Êïà"};const i=n.resolve(e,t);return this._injectGrid(i.events,"ENEMY"),this.renderer.render(i.events),{success:!0,events:i.events,shipsSunk:i.shipsSunk||[]}}executeAIAction(e,t){const{r:n,c:i,weapon:r}=e,o=this.registry.get(r);if(!o)return{success:!1,events:[],shipsSunk:[],reason:"Ê≠¶Âô®‰∏çÂ≠òÂú®"};if(!o.canUse(t))return console.warn(`[AI] Ê≠¶Âô® ${r} ‰∏çÂèØÁî®ÔºåË∑≥ËøáÊîªÂáª`),{success:!1,events:[],shipsSunk:[],reason:"Ê≠¶Âô®‰∏çÂèØÁî®"};if(!o.isValidTarget({r:n,c:i},t))return console.warn(`[AI] ÁõÆÊ†á (${n},${i}) Êó†ÊïàÔºåË∑≥ËøáÊîªÂáª`),{success:!1,events:[],shipsSunk:[],reason:"ÁõÆÊ†áÊó†Êïà"};const a=o.resolve({r:n,c:i},t);return this._injectGrid(a.events,"PLAYER","last-enemy-attack"),this.renderer.render(a.events),{success:!0,events:a.events,shipsSunk:a.shipsSunk||[]}}_injectGrid(e,t,n=null){for(const i of e)i.payload&&(i.payload.grid=t,n&&i.type===C.CELL_UPDATE&&(i.payload.markClass=n))}}class Qt{constructor(e={}){this.logFn=e.logFn||((t,n)=>console.log(`[${n}] ${t}`)),this.onShipSunk=e.onShipSunk||(()=>{})}render(e){if(!(!e||!Array.isArray(e)))for(const t of e)this._renderOne(t)}_renderOne(e){switch(e.type){case C.CELL_UPDATE:this._renderCellUpdate(e.payload);break;case C.SHIP_UPDATE:this._renderShipUpdate(e.payload);break;case C.LOG:this._renderLog(e.payload);break;case C.EFFECT:this._renderEffect(e.payload);break}}_renderCellUpdate(e){const{grid:t,r:n,c:i,state:r,markClass:o}=e,a=t==="PLAYER"?"player-grid":"enemy-grid",l=document.querySelector(`#${a} .cell[data-r="${n}"][data-c="${i}"]`);if(l){switch(l.classList.remove("hit","destroyed","miss"),r){case"HIT":l.classList.remove("detect","ai-detect"),l.classList.add("hit");break;case"DESTROYED":l.classList.remove("detect","ai-detect"),l.classList.add("destroyed");break;case"MISS":l.classList.remove("detect","ai-detect"),l.classList.add("miss");break;case"SUSPECT":!l.classList.contains("hit")&&!l.classList.contains("destroyed")&&!l.classList.contains("miss")&&l.classList.add(t==="PLAYER"?"ai-detect":"detect");break}o&&l.classList.add(o)}}_renderShipUpdate(e){const{grid:t,shipId:n,sunk:i}=e;i&&this.onShipSunk(n,t)}_renderLog(e){const{message:t,className:n}=e;this.logFn(t,n)}_renderEffect(e){}}function z(){const s=document.querySelector(".cell");let e=s?s.getBoundingClientRect().width:0;if(!e||e===0)if(window.innerWidth<=768){const t=window.innerWidth*.085;e=Math.max(26,Math.min(t,34))}else e=ze;return e}function Ee(){return window.innerWidth<=J.MOBILE_BREAKPOINT?J.MOBILE:J.DESKTOP}function Se(s){let e="";return s==="BB"?e=`
                <div class="hull-scale-wrapper" data-original-width="240">
                    <div class="hull-bb">
                        <div class="turret-base facing-left" style="left: 25px;"><div class="turret-bb"></div></div>
                        <div class="turret-base facing-left" style="left: 52px; z-index: 11;"><div class="turret-bb"></div></div>
                        <div class="bb-bridge-complex">
                            <div class="bb-tower"></div>
                            <div class="bb-funnel"></div>
                        </div>
                        <div class="turret-base facing-right" style="right: 60px; z-index: 11;"><div class="turret-bb"></div></div>
                        <div class="bb-stern-equipment">
                            <div class="bb-catapult-rail"></div>
                            <div class="bb-floatplane"></div>
                            <div class="bb-crane"></div>
                        </div>
                    </div>
                </div>`:s==="CV"?e=`
                <div class="hull-scale-wrapper" data-original-width="240">
                    <div class="hull-cv">
                        <div class="cv-arrow"></div>
                        <div class="cv-elevator"></div>
                        <div class="cv-island"></div>
                        <div class="cv-sponson"></div>
                    </div>
                </div>`:s==="CL"?e=`
                <div class="hull-scale-wrapper" data-original-width="170">
                    <div class="hull-cl">
                        <div class="turret-base facing-left" style="left: 15px;"><div class="turret-cl"></div></div>
                        <div class="turret-base facing-left" style="left: 35px; z-index:11"><div class="turret-cl"></div></div>
                        <div class="cl-bridge-area">
                            <div class="cl-block"></div>
                            <div class="cl-funnel" style="left: 25px;"></div>
                            <div class="cl-funnel" style="left: 45px;"></div>
                        </div>
                        <div class="turret-base facing-right" style="right: 35px; z-index:11"><div class="turret-cl"></div></div>
                        <div class="turret-base facing-right" style="right: 15px;"><div class="turret-cl"></div></div>
                    </div>
                </div>`:s==="DD"?e=`
                <div class="hull-scale-wrapper" data-original-width="120">
                    <div class="hull-dd">
                        <div class="turret-base facing-left" style="left: 10px;"><div class="turret-dd"></div></div>
                        <div class="turret-base facing-left" style="left: 24px; z-index:11"><div class="turret-dd"></div></div>
                        <div class="dd-mid">
                            <div class="dd-structure" style="left: 0px;"></div>
                            <div class="dd-torpedo" style="left: 12px;"></div>
                            <div class="dd-structure" style="left: 28px;"></div>
                            <div class="dd-torpedo" style="left: 40px;"></div>
                        </div>
                        <div class="turret-base facing-right" style="right: 10px;"><div class="turret-dd"></div></div>
                    </div>
                </div>`:s==="SS"&&(e=`
                <div class="hull-scale-wrapper" data-original-width="60">
                    <div class="hull-ss">
                        <div class="ss-tower">
                            <div class="ss-periscope"></div>
                        </div>
                    </div>
                </div>`),e}let x="SETUP",S=[],T=[],ae=le(),ee=[],R="horizontal",O="AP",te="PLAYER",N=!1,ne=null,V=null,F=null,Re=null,P=null;function Zt(){Je(),B("player"),on(),sn(),Jt(),document.addEventListener("mouseup",it),document.addEventListener("mousemove",st),document.addEventListener("touchend",un,{passive:!1}),document.addEventListener("touchmove",dn,{passive:!1}),window.addEventListener("resize",()=>{Ze(),S.forEach(s=>Y(s)),document.querySelectorAll(".revealed-enemy-ship").forEach(s=>{const e=parseInt(s.dataset.id),t=T.find(n=>n.id===e);t&&xn(s,t)})}),Tn(),ct(lt,{silent:!0}),B("player")}function Jt(){Re=new Qt({logFn:W,onShipSunk:(s,e)=>{if(e==="ENEMY"){const t=T.find(n=>n.id===s);t&&gt(t)}}}),F=new Xt,F.register(new ge),F.register(new me),F.register(new pe),P=new jt(F,Re)}function en(){return{attackerShips:S.map(s=>new Ke(s)),defenderGrid:ee,defenderShips:T,isPlayer:!0}}function tn(){return{attackerShips:T.map(s=>new Ke(s)),defenderGrid:nn(),defenderShips:S,isPlayer:!1}}function nn(){const s=[];for(let e=0;e<g;e++){s[e]=[];for(let t=0;t<g;t++){let n=-1,i=-1;for(const a of S){const l=[];for(let d=0;d<a.len;d++)l.push(a.vertical?{r:a.r+d,c:a.c,idx:d}:{r:a.r,c:a.c+d,idx:d});const c=l.find(d=>d.r===e&&d.c===t);if(c){n=a.id,i=c.idx;break}}const r=document.querySelector(`#player-grid .cell[data-r="${e}"][data-c="${t}"]`),o=r&&(r.classList.contains("hit")||r.classList.contains("destroyed")||r.classList.contains("miss"));s[e][t]={hit:o,shipId:n,segmentIndex:i}}}return s}function le(){return Array(g).fill(0).map(()=>Array(g).fill(0))}function Ze(){const s=document.documentElement,n=(J.MOBILE_BREAKPOINT-8)*.5,i=Math.floor(n/g),r=Math.min(ze,i);s.style.setProperty("--board-size",g),s.style.setProperty("--cell-size",`${r}px`)}function Je(){Ze();const s=document.getElementById("player-grid"),e=document.getElementById("enemy-grid");s.innerHTML="",e.innerHTML="";for(let t=0;t<g;t++)for(let n=0;n<g;n++){let i=document.createElement("div");i.className="cell",i.dataset.r=t,i.dataset.c=n,s.appendChild(i);let r=document.createElement("div");r.className="cell",r.dataset.r=t,r.dataset.c=n,r.onclick=()=>bn(t,n),r.onmouseenter=()=>rn(t,n),r.onmouseleave=()=>et(),e.appendChild(r)}}function sn(){const s=document.getElementById("help-btn");s&&(localStorage.getItem("hasClickedHelp")||s.classList.add("pulse-highlight"),s.addEventListener("click",E=>{E.stopPropagation(),s.classList.remove("pulse-highlight"),localStorage.setItem("hasClickedHelp","true"),Z()}));const e=document.getElementById("btn-menu-toggle"),t=document.getElementById("settings-modal");e&&t&&e.addEventListener("click",()=>{t.style.display="block"});const n=document.getElementById("help-modal");if(n){n.addEventListener("click",A=>{A.target===n&&(A.stopPropagation(),Z())});const E=n.querySelector(".close-btn");E&&E.addEventListener("click",A=>{A.stopPropagation(),Z()})}document.querySelectorAll("[data-weapon]").forEach(E=>{E.addEventListener("click",()=>{oe(E.dataset.weapon),window.innerWidth<=768&&document.getElementById("weapon-bar").classList.remove("show")})}),document.querySelectorAll("[data-difficulty]").forEach(E=>{E.addEventListener("click",()=>ct(E.dataset.difficulty))});const i=document.getElementById("rotate-toggle");i&&i.addEventListener("click",an);const r=document.getElementById("first-turn-toggle");r&&r.addEventListener("click",$e),document.querySelectorAll("[data-panel-toggle]").forEach(E=>{E.addEventListener("click",()=>Bn(E.dataset.panelToggle))});const o=document.getElementById("btn-debug");o&&o.addEventListener("click",Ue);const a=document.getElementById("btn-reset");a&&a.addEventListener("click",q);const l=document.getElementById("btn-random");l&&l.addEventListener("click",He);const c=document.getElementById("start-btn");c&&c.addEventListener("click",Oe);const d=document.querySelector('[data-action="view-battlefield"]');d&&d.addEventListener("click",In);const u=document.querySelector('[data-action="restart-game"]');u&&u.addEventListener("click",kn);const f=document.getElementById("btn-settings");if(f&&t){f.addEventListener("click",()=>{t.style.display="block"}),t.addEventListener("click",Et=>{Et.target===t&&(t.style.display="none")});const E=t.querySelector(".close-btn");E&&E.addEventListener("click",()=>t.style.display="none");const A=document.getElementById("mobile-first-turn");A&&A.addEventListener("click",$e);const Te=document.getElementById("mobile-debug");Te&&Te.addEventListener("click",Ue);const Le=document.getElementById("mobile-reset");Le&&Le.addEventListener("click",()=>{q(),t.style.display="none"});const Pe=document.getElementById("mobile-menu-restart");Pe&&Pe.addEventListener("click",()=>{x==="PLAYING"||x==="END"?confirm("Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÂêóÔºü")&&(re(),t.style.display="none"):(re(),t.style.display="none")});const Ce=document.getElementById("mobile-menu-random");Ce&&Ce.addEventListener("click",()=>{He(),t.style.display="none"});const Me=document.getElementById("mobile-menu-reset");Me&&Me.addEventListener("click",()=>{q(),t.style.display="none"});const _e=document.getElementById("mobile-menu-help");_e&&_e.addEventListener("click",()=>{t.style.display="none",Z()})}const m=document.getElementById("tab-view-player"),p=document.getElementById("tab-view-enemy");m&&m.addEventListener("click",()=>B("player")),p&&p.addEventListener("click",()=>B("enemy"));const h=document.getElementById("mb-tab-player"),v=document.getElementById("mb-tab-enemy");h&&h.addEventListener("click",()=>B("player")),v&&v.addEventListener("click",()=>B("enemy"));const w=document.getElementById("mb-btn-start");w&&w.addEventListener("click",Oe);const I=document.getElementById("mb-btn-weapon");I&&I.addEventListener("click",()=>{document.getElementById("weapon-bar").classList.toggle("show")})}function B(s){const e=document.getElementById("player-board-box"),t=document.getElementById("enemy-board-box"),n=document.getElementById("tab-view-player"),i=document.getElementById("tab-view-enemy"),r=document.getElementById("mb-tab-player"),o=document.getElementById("mb-tab-enemy");e.classList.remove("active-view"),t.classList.remove("active-view"),n&&n.classList.remove("active"),i&&i.classList.remove("active"),r&&r.classList.remove("active"),o&&o.classList.remove("active"),s==="player"?(e.classList.add("active-view"),n&&n.classList.add("active"),r&&r.classList.add("active")):(t.classList.add("active-view"),i&&i.classList.add("active"),o&&o.classList.add("active"))}function rn(s,e){if(x==="PLAYING"&&document.getElementById("enemy-grid").style.pointerEvents!=="none"&&(et(),P)){P.setCurrentWeapon(O);const t=P.getPreviewArea({r:s,c:e}),n=document.getElementById("enemy-grid");t.cells.forEach(i=>{if(i.r>=0&&i.r<g&&i.c>=0&&i.c<g){const r=n.querySelector(`.cell[data-r="${i.r}"][data-c="${i.c}"]`);r&&r.classList.add("attack-range-highlight")}})}}function et(){document.getElementById("enemy-grid").querySelectorAll(".attack-range-highlight").forEach(e=>{e.classList.remove("attack-range-highlight")})}function on(){const s=document.getElementById("dock");S=[],s.innerHTML="",j.forEach((e,t)=>{const n=document.createElement("div");n.className="ship ship-visuals-root",n.title=`${e.name} (ÈïøÂ∫¶:${e.len})`,n.style.position="relative";const i=document.createElement("div");i.className="ship-inner",i.innerHTML=Se(e.code),n.appendChild(i);const r={id:t,name:e.name,len:e.len,maxHp:e.maxHp,code:e.code,hp:Array(e.len).fill(e.maxHp),el:n,inDock:!0,vertical:!1,r:-1,c:-1,sunk:!1};Y(r),n.onclick=o=>{ce||x==="SETUP"&&!r.inDock&&gn(r)},n.onmousedown=o=>nt(o,r),n.ontouchstart=o=>cn(o,r),s.appendChild(n),S.push(r)})}function Ae(s,e,t){const n=s.querySelector(".hull-scale-wrapper");if(!n)return;const i=parseFloat(n.dataset.originalWidth);if(!i)return;const o=e*t/i*.95;n.style.transform=`scale(${o})`}function Y(s,e=!1){const t=z(),n=s.len*t+"px",i=t+"px";s.el.style.setProperty("--w",n),s.el.style.setProperty("--h",i),Ae(s.el,s.len,t),s.vertical&&(!s.inDock||e)?(s.el.classList.add("vertical"),s.el.style.width=t+"px",s.el.style.height=n):(s.el.classList.remove("vertical"),s.el.style.width=n,s.el.style.height=t+"px"),!s.inDock&&!e&&(s.el.style.left=s.c*t+"px",s.el.style.top=s.r*t+"px")}function an(){R=R==="horizontal"?"vertical":"horizontal";const s=document.getElementById("rotate-toggle");s.innerText=R==="horizontal"?"ÈÉ®ÁΩ≤ÊñπÂêë:Ê∞¥Âπ≥‚Æï":"ÈÉ®ÁΩ≤ÊñπÂêë:ÂûÇÁõ¥‚¨á",S.forEach(e=>{e.inDock&&(e.vertical=R==="vertical")})}function $e(){te=te==="PLAYER"?"AI":"PLAYER";const s=te==="PLAYER"?"ÂÖàÊâãÔºöÁé©ÂÆ∂ üë§":"ÂÖàÊâãÔºöÁîµËÑë ü§ñ",e=document.getElementById("first-turn-toggle");e&&(e.innerText=s);const t=document.getElementById("mobile-first-turn");t&&(t.innerText=s)}function Ue(){N=!N;const s=N?"üß† AI ËßÜËßí: ÂºÄÂêØ":"üß† AI ËßÜËßí: ÂÖ≥Èó≠",e=N?"#ed8936":"",t=document.getElementById("btn-debug");t&&(t.innerText=s,t.style.background=e);const n=document.getElementById("mobile-debug");n&&(n.innerText=s,n.style.background=e),N?tt():ln()}function tt(s=null){if(!N)return;const e=ut(),t=S.filter(r=>!r.sunk),n=s||(t.length>0?Ht(e,t,Be):Array(g).fill(0).map(()=>Array(g).fill(0))),i=document.getElementById("player-grid");for(let r=0;r<g;r++)for(let o=0;o<g;o++){const a=i.querySelector(`.cell[data-r="${r}"][data-c="${o}"]`),l=n[r][o]||0;a.classList.remove("debug-heat"),a.removeAttribute("data-heat"),a.style.removeProperty("--heat-bg");const c=Math.min(1,Math.max(0,l));if(c>0){a.setAttribute("data-heat",`${(c*100).toFixed(1)}%`),a.classList.add("debug-heat");const d=.1+c*.6,u=Math.floor(255*c),f=Math.floor(255*(1-c));a.style.setProperty("--heat-bg",`rgba(${u}, 0, ${f}, ${d})`)}}}function ln(){document.getElementById("player-grid").querySelectorAll(".debug-heat").forEach(e=>{e.classList.remove("debug-heat"),e.removeAttribute("data-heat"),e.style.removeProperty("--heat-bg")})}let _=null,k={x:0,y:0},ce=!1,L=null;function we(s){return s.touches&&s.touches.length>0?{x:s.touches[0].clientX,y:s.touches[0].clientY}:s.changedTouches&&s.changedTouches.length>0?{x:s.changedTouches[0].clientX,y:s.changedTouches[0].clientY}:{x:s.clientX,y:s.clientY}}function cn(s,e){if(s.touches.length>1)return;s.cancelable&&s.preventDefault();const t=we(s),n={button:0,preventDefault:()=>{},clientX:t.x,clientY:t.y,target:s.target};nt(n,e)}function nt(s,e){if(x!=="SETUP"||s.button!==0)return;s.preventDefault(),_=e,ce=!1,L=null;const t=e.el.getBoundingClientRect();let n=s.clientX-t.left,i=s.clientY-t.top;e.el.classList.add("dragging");const r=e.inDock&&R==="vertical";e.inDock&&(e.vertical=R==="vertical"),Y(e,!0),r?(k.x=i,k.y=n):(k.x=n,k.y=i),e.el.style.left=s.clientX-k.x+"px",e.el.style.top=s.clientY-k.y+"px",document.body.appendChild(e.el),e.inDock||at(e)}function dn(s){if(!_)return;s.cancelable&&s.preventDefault();const e=we(s),t={clientX:e.x,clientY:e.y};st(t)}function st(s){if(!_)return;ce=!0;const e=_;e.el.style.left=s.clientX-k.x+"px",e.el.style.top=s.clientY-k.y+"px",rt();const t=document.elementFromPoint(s.clientX,s.clientY);if(!t){L=null;return}const n=t.closest(".cell"),i=document.getElementById("player-grid"),r=z();if(n&&i.contains(n)){const o=i.getBoundingClientRect(),a=s.clientX-k.x,l=s.clientY-k.y,c=a-o.left+r/2,d=l-o.top+r/2,u=Math.floor(c/r),f=Math.floor(d/r);fn(e,f,u)}else L=null}function un(s){if(!_)return;const e=we(s),t={clientX:e.x,clientY:e.y};it(t)}function it(s){if(!_)return;const e=_;e.el.classList.remove("dragging");const n=document.getElementById("player-grid").getBoundingClientRect(),i=z(),r=s.clientX>=n.left&&s.clientX<=n.right&&s.clientY>=n.top&&s.clientY<=n.bottom,o=L&&L.shipId===e.id?L:null;rt(),L=null;let a=!1;if(o&&ie(o.r,o.c,e.len,o.vertical))se(e,o.r,o.c,o.vertical),a=!0;else if(r){const l=s.clientX-k.x,c=s.clientY-k.y,d=l-n.left+i/2,u=c-n.top+i/2,f=Math.floor(d/i),m=Math.floor(u/i);ie(m,f,e.len,e.vertical)&&(se(e,m,f,e.vertical),a=!0)}a||(ot(e),r&&W("Êó†Êïà‰ΩçÁΩÆÔºöÈáçÂè†ÊàñË∂äÁïå","c-warn")),_=null,setTimeout(()=>ce=!1,50),Ie()}function fn(s,e,t){const n=s.len,i=s.vertical,r=ie(e,t,n,i),o=r?"highlight-valid":"highlight-invalid";let a=!1;for(let l=0;l<n;l++){const c=i?e+l:e,d=i?t:t+l,u=document.querySelector(`#player-grid .cell[data-r="${c}"][data-c="${d}"]`);u&&(u.classList.add(o),a=!0)}r&&a?L={shipId:s.id,r:e,c:t,vertical:i}:L=null}function rt(){document.querySelectorAll(".highlight-valid, .highlight-invalid").forEach(s=>{s.classList.remove("highlight-valid"),s.classList.remove("highlight-invalid")})}function se(s,e,t,n){const i=document.getElementById("player-grid"),r=z();s.inDock=!1,s.r=e,s.c=t,s.vertical=n,s.el.style.transition="none",s.el.style.position="absolute",s.el.style.margin="0",i.appendChild(s.el),Y(s),s.el.style.left=t*r+"px",s.el.style.top=e*r+"px",s.el.offsetWidth,s.el.style.transition="",xe(s,1)}function ot(s){const e=document.getElementById("dock");s.el.style.transition="none",s.inDock=!0,s.r=-1,s.c=-1,s.sunk=!1,s.hp=Array(s.len).fill(s.maxHp),s.el.classList.remove("sunk"),s.vertical=R==="vertical",s.el.style.position="relative",s.el.style.left="auto",s.el.style.top="auto",s.el.style.margin="0",Y(s),e.appendChild(s.el),s.el.offsetWidth,s.el.style.transition=""}function gn(s){const e=!s.vertical;at(s),ie(s.r,s.c,s.len,e)?se(s,s.r,s.c,e):(xe(s,1),mn(s.el),W("ÊóãËΩ¨Á©∫Èó¥‰∏çË∂≥","c-warn"))}function mn(s){s.classList.remove("shake"),s.offsetWidth,s.classList.add("shake")}function ie(s,e,t,n,i){if(s<0||e<0)return!1;if(n){if(s+t>g||e>=g)return!1}else if(e+t>g||s>=g)return!1;for(let r=0;r<t;r++){let o=n?s+r:s,a=n?e:e+r;if(ae[o][a]===1)return!1}return!0}function xe(s,e){for(let t=0;t<s.len;t++){let n=s.vertical?s.r+t:s.r,i=s.vertical?s.c:s.c+t;n<g&&i<g&&(ae[n][i]=e)}}function at(s){xe(s,0)}function q(){ae=le(),S.forEach(s=>ot(s)),Ie()}function He(){q(),setTimeout(()=>{be(j,g).forEach(e=>{const t=S.find(n=>n.code===e.code);t&&se(t,e.r,e.c,e.v)}),Ie()},50)}function Ie(){const s=S.every(n=>!n.inDock),e=document.getElementById("start-btn"),t=document.getElementById("mb-btn-start");x==="SETUP"&&(e.disabled=!s,t&&(t.disabled=!s),s?e.className="btn-orange":e.disabled=!0)}function Oe(){document.getElementById("start-btn"),x==="PLAYING"||x==="END"?confirm("Á°ÆÂÆöË¶ÅÁªìÊùüÂΩìÂâçÊàòÊñóÂπ∂ÈáçÊñ∞ÂºÄÂßãÂêóÔºü")&&re():pn()}function re(){document.body.classList.remove("game-playing"),de(),ne=null,x="SETUP",document.getElementById("dock").style.display="flex",document.getElementById("battle-panel").style.display="none";const s=document.getElementById("mb-deploy-group"),e=document.getElementById("mb-combat-group");s&&(s.style.display="flex"),e&&(e.style.display="none"),document.getElementById("dock").style.pointerEvents="auto",document.getElementById("dock").style.opacity=1,["rotate-toggle","first-turn-toggle","btn-debug","btn-reset","btn-random","mobile-first-turn","mobile-debug","mobile-reset","mobile-menu-random","mobile-menu-reset"].forEach(r=>{const o=document.getElementById(r);o&&(o.disabled=!1)});const n=document.getElementById("start-btn");n.innerText="üöÄ ÂºÄÂßãÊàòÊñó",n.className="btn-orange",n.disabled=!0;const i=document.getElementById("mb-btn-start");i&&(i.disabled=!0),Je(),document.getElementById("enemy-grid").style.pointerEvents="none",ae=le(),q(),document.getElementById("log").innerHTML='<div class="log-line c-sys">Ê∏∏ÊàèÂ∑≤ÈáçÁΩÆ„ÄÇ</div>',B("player")}function pn(){document.body.classList.add("game-playing"),de(),ne=null,x="PLAYING",document.getElementById("dock").style.display="none",document.getElementById("battle-panel").style.display="flex";const s=document.getElementById("mb-deploy-group"),e=document.getElementById("mb-combat-group");s&&(s.style.display="none"),e&&(e.style.display="flex"),["rotate-toggle","first-turn-toggle","btn-reset","btn-random","mobile-first-turn","mobile-reset","mobile-menu-random","mobile-menu-reset"].forEach(i=>{const r=document.getElementById(i);r&&(r.disabled=!0)}),S.forEach(i=>i.el.style.cursor="default");const n=document.getElementById("start-btn");n.innerText="üîÑ ÈáçÊñ∞ÂºÄÂßã",n.className="btn-restart",Bt(),hn(),ke(),oe("AP"),te==="PLAYER"?(W("ÊàòÊñóÂºÄÂßãÔºÅÁé©ÂÆ∂ÂÖàÊâãÔºåÁÇπÂáªÊïåÊñπÊµ∑ÂüüÂºÄÁÅ´„ÄÇ","c-warn"),document.getElementById("enemy-grid").style.pointerEvents="auto",B("enemy")):(W("ÊàòÊñóÂºÄÂßãÔºÅÁîµËÑëÂÖàÊâã„ÄÇ","c-warn"),document.getElementById("enemy-grid").style.pointerEvents="none",B("player"),dt(Ee().AI_ACTION_DELAY))}function hn(){const s=document.getElementById("enemy-grid");s.querySelectorAll(".wreck").forEach(t=>t.remove()),s.querySelectorAll(".revealed-enemy-ship").forEach(t=>t.remove()),s.querySelectorAll(".cell").forEach(t=>{for(t.className="cell";t.firstChild;)t.removeChild(t.firstChild)});const e=be(j,g);T=[],ee=le().map(t=>t.map(n=>({hit:!1,shipId:-1,segmentIndex:-1}))),e.forEach((t,n)=>{const{r:i,c:r,v:o,len:a,name:l,maxHp:c,code:d}=t;for(let u=0;u<a;u++){const f=o?i+u:i,m=o?r:r+u;ee[f][m].shipId=n,ee[f][m].segmentIndex=u}T.push({id:n,name:l,len:a,maxHp:c,code:d,hp:Array(a).fill(c),sunk:!1,r:i,c:r,v:o})})}function oe(s){O=s,document.querySelectorAll(".weapon-btn").forEach(i=>i.classList.remove("active"));const e=s==="AP"?"btn-ap":s==="HE"?"btn-he":"btn-sonar";document.getElementById(e).classList.add("active");const t=document.getElementById("mb-weapon-name"),n=document.getElementById("mb-weapon-icon");t&&n&&(s==="AP"?(t.innerText="‰∏ªÁÇÆ",n.innerText="üí•"):s==="HE"?(t.innerText="Á©∫Ë¢≠",n.innerText="‚úàÔ∏è"):s==="SONAR"&&(t.innerText="Ê∞¥Âê¨",n.innerText="üì°"))}function yn(){const s=S.some(a=>a.code==="CV"&&!a.sunk);S.some(a=>a.code==="CL"&&!a.sunk);const e=S.some(a=>a.code==="DD"&&!a.sunk),t=S.some(a=>a.code==="SS"&&!a.sunk),n=s,i=e||t;document.getElementById("btn-he").disabled=!n,document.getElementById("btn-sonar").disabled=!i,O==="HE"&&!n&&oe("AP"),O==="SONAR"&&!i&&oe("AP");const r=vn(),o=document.getElementById("ap-desc");o&&(o.innerText=`ÂçïÁÇπ ${r}‰º§`)}function vn(){const s=S.some(n=>n.code==="BB"&&!n.sunk),e=S.some(n=>n.code==="SS"&&!n.sunk),t=S.some(n=>n.code==="CL"&&!n.sunk);return s?3:e||t?2:1}function ke(){const s=document.getElementById("ship-status-list");s.innerHTML="",S.forEach(e=>{const t=document.createElement("div");t.className="ship-status-row";const n=document.createElement("span");n.innerText=e.name,e.sunk&&(n.style.textDecoration="line-through",n.style.color="#fc8181");const i=document.createElement("div");i.className="hp-blocks",e.hp.forEach(r=>{const o=document.createElement("div");o.className="hp-block",r<=0?o.classList.add("lost"):r<e.maxHp&&o.classList.add("dmg"),i.appendChild(o)}),t.appendChild(n),t.appendChild(i),s.appendChild(t)}),yn()}function bn(s,e){if(x==="PLAYING"&&document.getElementById("enemy-grid").style.pointerEvents!=="none"){if(P){P.setCurrentWeapon(O);const t=en(),n=P.executePlayerAction({r:s,c:e},t);if(!n.success)return;O!=="SONAR"&&n.shipsSunk&&n.shipsSunk.length>0&&ft("Áé©ÂÆ∂")}if(ke(),document.getElementById("enemy-grid").style.pointerEvents="none",x==="PLAYING"){const t=Ee();t.VIEW_SWITCH_DELAY>0&&setTimeout(()=>{x==="PLAYING"&&B("player")},t.VIEW_SWITCH_DELAY),dt(t.AI_ACTION_DELAY)}}}let Be={...Ye[Fe]},lt=Fe;function ct(s,e={}){const{silent:t=!1}=e;lt=s,Be={...Ye[s]},document.querySelectorAll(".diff-btn").forEach(n=>{n.dataset.difficulty===s?n.classList.add("active"):n.classList.remove("active")}),t||W(`AI ÈöæÂ∫¶Â∑≤Ë∞ÉÊï¥‰∏∫: ${s==="EASY"?"Êñ∞ÂÖµ (ÁÆÄÂçï)":s==="NORMAL"?"Ëà∞Èïø (Âõ∞Èöæ)":"ÊèêÁù£ (ÂÜ∑ÈÖ∑)"}`,"c-sys")}function de(){V!==null&&(clearTimeout(V),V=null)}function dt(s){de(),V=setTimeout(()=>{V=null,Sn()},s)}function En(){document.getElementById("player-grid").querySelectorAll(".last-enemy-attack").forEach(e=>{e.classList.remove("last-enemy-attack")})}function Sn(){if(x!=="PLAYING")return;En();const s=ut(),e=An(),n=Lt({viewGrid:s,myShips:S,enemyShips:T,difficultyConfig:Be,playerViewGrid:e});if(P){const r=tn(),o=P.executeAIAction(n,r);if(n.weapon!=="SONAR"&&o.shipsSunk&&o.shipsSunk.length>0){for(const a of o.shipsSunk){const l=S.find(c=>c.id===a);l&&l.el&&l.el.classList.add("sunk")}ft("ÁîµËÑë")}}ke(),N&&tt();const i=document.getElementById("enemy-grid");if(x==="PLAYING"){i.style.pointerEvents="auto";const r=Ee();r.TURN_BACK_DELAY>0&&setTimeout(()=>{x==="PLAYING"&&B("enemy")},r.TURN_BACK_DELAY)}else i.style.pointerEvents="none"}function ut(){let s=Array(g).fill(0).map(()=>Array(g).fill(0));return document.querySelectorAll("#player-grid .cell").forEach(e=>{const t=parseInt(e.dataset.r),n=parseInt(e.dataset.c);e.classList.contains("destroyed")?s[t][n]=3:e.classList.contains("hit")?s[t][n]=2:e.classList.contains("miss")?s[t][n]=1:e.classList.contains("ai-detect")&&(s[t][n]=4)}),S.forEach(e=>{if(e.sunk)for(let t=0;t<e.len;t++){let n=e.vertical?e.r+t:e.r,i=e.vertical?e.c:e.c+t;n>=0&&n<g&&i>=0&&i<g&&(s[n][i]=5)}}),s}function An(){const s=Array(g).fill(0).map(()=>Array(g).fill(0));return document.querySelectorAll("#enemy-grid .cell").forEach(e=>{const t=parseInt(e.dataset.r),n=parseInt(e.dataset.c);e.classList.contains("destroyed")?s[t][n]=3:e.classList.contains("hit")?s[t][n]=2:e.classList.contains("miss")?s[t][n]=1:e.classList.contains("suspect")&&(s[t][n]=4)}),T.forEach(e=>{if(e.sunk)for(let t=0;t<e.len;t++){const n=e.vertical?e.r+t:e.r,i=e.vertical?e.c:e.c+t;n>=0&&n<g&&i>=0&&i<g&&(s[n][i]=5)}}),s}function ft(s){if(ne)return;const e=S.every(a=>a.sunk),t=T.every(a=>a.sunk);if(!(e||t))return;ne=s,x="END",de();const n=document.getElementById("enemy-grid");n&&(n.style.pointerEvents="none"),wn();const i=document.getElementById("game-over-modal"),r=document.getElementById("game-over-title"),o=document.getElementById("game-over-msg");s==="Áé©ÂÆ∂"?(r.innerText="VICTORY",r.className="game-over-title win-text",o.innerText="ÊÅ≠ÂñúÊåáÊå•ÂÆòÔºÅÊïåÊñπËà∞ÈòüÂ∑≤Ë¢´ÂÖ®Ê≠ºÔºÅ"):(r.innerText="DEFEAT",r.className="game-over-title lose-text",o.innerText="ÂæàÈÅóÊÜæÔºåÊàëÊñπËà∞ÈòüÂ∑≤ÂÖ®ÂÜõË¶ÜÊ≤°..."),setTimeout(()=>{i.style.display="block"},500)}function wn(){T.forEach(s=>{gt(s)})}function gt(s){const e=document.getElementById("enemy-grid"),t=z();if(e.querySelector(`.revealed-enemy-ship[data-id="${s.id}"]`))return;const n=document.createElement("div");n.className="ship revealed-enemy-ship ship-visuals-root",n.dataset.id=s.id,n.style.position="absolute",n.style.left=s.c*t+"px",n.style.top=s.r*t+"px",n.style.pointerEvents="none";const i=document.createElement("div");i.className="ship-inner",i.innerHTML=Se(s.code),n.appendChild(i);const r=s.len*t+"px",o=t+"px";n.style.setProperty("--w",r),n.style.setProperty("--h",o),s.v?(n.classList.add("vertical"),n.style.width=t+"px",n.style.height=r):(n.style.width=r,n.style.height=t+"px"),s.sunk?n.classList.add("sunk"):(n.style.opacity="0.9",n.style.filter="drop-shadow(0 0 5px white)"),Ae(n,s.len,t),e.appendChild(n)}function xn(s,e){const t=z(),n=e.len*t+"px",i=t+"px";s.style.left=e.c*t+"px",s.style.top=e.r*t+"px",s.style.setProperty("--w",n),s.style.setProperty("--h",i),Ae(s,e.len,t),e.v?(s.style.width=t+"px",s.style.height=n):(s.style.width=n,s.style.height=t+"px")}function In(){document.getElementById("game-over-modal").style.display="none"}function kn(){document.getElementById("game-over-modal").style.display="none",re()}function W(s,e){const t=document.getElementById("log"),n=document.createElement("div");n.className=`log-line ${e}`,n.innerHTML=`[${new Date().toLocaleTimeString().split(" ")[0]}] ${s}`,t.prepend(n)}function Z(){const s=document.getElementById("help-modal");requestAnimationFrame(()=>{s.style.display=s.style.display==="block"?"none":"block"})}function Bn(s){const e=s==="left",t=document.querySelector(e?".dock-panel":".log-panel"),n=document.querySelector(e?".toggle-left":".toggle-right");t.classList.toggle("panel-collapsed");const i=t.classList.contains("panel-collapsed");e?n.innerText=i?"‚ñ∂":"‚óÄ":n.innerText=i?"‚óÄ":"‚ñ∂"}function Tn(){const s=document.getElementById("rules-ship-table-body");s&&(s.innerHTML="",j.forEach(e=>{const t=document.createElement("tr"),n=document.createElement("td"),i=document.createElement("div");i.className="ship-preview";const r=document.createElement("div");r.className="ship ship-visuals-root";const o=document.createElement("div");o.className="ship-inner",o.innerHTML=Se(e.code),r.appendChild(o),Y({len:e.len,el:r,vertical:!1,inDock:!1});const a=r.querySelector(".hull-scale-wrapper");a&&(a.style.transform="scale(0.4)"),i.appendChild(r),n.appendChild(i),t.appendChild(n);const l=document.createElement("td");l.innerText=e.code,t.appendChild(l);const c=document.createElement("td");c.innerText=e.name,t.appendChild(c);const d=document.createElement("td");d.innerText=e.len,t.appendChild(d);const u=document.createElement("td");u.innerText=e.maxHp,t.appendChild(u);const f=document.createElement("td");e.code==="CV"?f.innerHTML="Ëß£ÈîÅ <b>Á©∫Ë¢≠</b>":e.code==="DD"?f.innerHTML="Ëß£ÈîÅ <b>Ê∞¥Âê¨</b>":e.code==="BB"?f.innerHTML="‰∏ªÁÇÆ‰º§ÂÆ≥‰∏äÈôê 3":e.code==="SS"?f.innerHTML="‰∏ªÁÇÆ‰º§ÂÆ≥‰∏äÈôê 2<br>Ëß£ÈîÅ <b>Ê∞¥Âê¨</b>":e.code==="CL"?f.innerHTML="‰∏ªÁÇÆ‰º§ÂÆ≥‰∏äÈôê 2 ":f.innerText="-",t.appendChild(f),s.appendChild(t)}))}const y={UNKNOWN:0,MISS:1,HIT:2,DESTROYED:3,SUSPECT:4,SUNK:5},Ln=200,mt=200,G=1e-10,pt={AP:new ge,HE:new me,SONAR:new pe};class ht{constructor(e,t,n={}){this.configA={alpha:.5,randomness:0,riskAwareness:0,...e},this.configB={alpha:.5,randomness:0,riskAwareness:0,...t},this.verbose=n.verbose||!1,this.maxTurns=n.maxTurns||Ln,this.reset()}reset(){this.shipsA=this._deployShips(),this.shipsB=this._deployShips(),this.gridA=this._createGrid(this.shipsA),this.gridB=this._createGrid(this.shipsB),this.viewGridA=this._createViewGrid(),this.viewGridB=this._createViewGrid(),this.damageGridA=this._createDamageGrid(),this.damageGridB=this._createDamageGrid(),this.stats={turns:0,hitsA:0,hitsB:0,damageA:0,damageB:0,winner:null}}run(){let e="A";for(;this.stats.turns<this.maxTurns;)if(this.stats.turns++,e==="A"){if(this._executeTurn(this.configA,this.shipsA,this.shipsB,this.gridB,this.viewGridA,this.damageGridA,"A"),this._isAllSunk(this.shipsB)){this.stats.winner="A";break}e="B"}else{if(this._executeTurn(this.configB,this.shipsB,this.shipsA,this.gridA,this.viewGridB,this.damageGridB,"B"),this._isAllSunk(this.shipsA)){this.stats.winner="B";break}e="A"}return this.stats.winner||(this.stats.winner="DRAW"),{winner:this.stats.winner,stats:{...this.stats}}}_deployShips(){return be(j,g).map((t,n)=>({id:n,name:t.name,code:t.code,len:t.len,maxHp:t.maxHp,hp:Array(t.len).fill(t.maxHp),r:t.r,c:t.c,v:t.v,vertical:t.v,sunk:!1}))}_createGrid(e){const t=Array(g).fill(null).map(()=>Array(g).fill(null).map(()=>({hit:!1,shipId:-1,segmentIndex:-1})));for(const n of e)for(let i=0;i<n.len;i++){const r=n.v?n.r+i:n.r,o=n.v?n.c:n.c+i;t[r][o].shipId=n.id,t[r][o].segmentIndex=i}return t}_createViewGrid(){return Array(g).fill(null).map(()=>Array(g).fill(y.UNKNOWN))}_createDamageGrid(){return Array(g).fill(null).map(()=>Array(g).fill(0))}_executeTurn(e,t,n,i,r,o,a){const l=this._checkAbilities(t),c=n.filter(h=>!h.sunk);if(c.length===0)return;if(Math.random()<e.randomness){const h=this._makeRandomDecision(r,l);this._executeAction(h,l,i,n,r,o,a);return}const d=new Pn(c,r,mt),u=this._enumerateActions(r,l);if(u.length===0){const h=this._findFallbackTarget(r);this._executeAction(h,l,i,n,r,o,a);return}let f=null,m=-1/0;const p=Math.max(...c.map(h=>h.maxHp??1));for(const h of u){const v=this._evaluateAction(d,h,l,e.alpha,o,p);v>m+1e-9?(m=v,f=h):Math.abs(v-m)<1e-9&&Math.random()<.3&&(f=h)}this._executeAction(f,l,i,n,r,o,a)}_checkAbilities(e){const t=e.some(l=>l.code==="CV"&&!l.sunk),n=e.some(l=>l.code==="CL"&&!l.sunk),i=e.some(l=>l.code==="BB"&&!l.sunk),r=e.some(l=>l.code==="SS"&&!l.sunk),o=e.some(l=>l.code==="DD"&&!l.sunk);let a=1;return i?a=3:(r||n)&&(a=2),{canUseAir:t,canUseSonar:o||r,apDamage:a}}_enumerateActions(e,t){const n=[];for(let i=0;i<g;i++)for(let r=0;r<g;r++){const o=e[i][r];if(!(o===y.MISS||o===y.SUNK)){if(o===y.DESTROYED){t.canUseAir&&n.push({weapon:"HE",r:i,c:r});continue}n.push({weapon:"AP",r:i,c:r}),t.canUseAir&&n.push({weapon:"HE",r:i,c:r}),t.canUseSonar&&(o===y.UNKNOWN||o===y.SUSPECT)&&n.push({weapon:"SONAR",r:i,c:r})}}return n}_evaluateAction(e,t,n,i,r,o){const{weapon:a,r:l,c}=t,d=e.getProbabilityGrid(),u=e.getEntropy(),f=e.getConditionalEntropy(t),m=Math.max(0,u-f),p=u>G?m/u:0,h=this._calculateExpectedDamage(t,d,n,r,o),v=a==="HE"?5:a==="AP"?n.apDamage:0,w=v>0?h/v:0;return a==="SONAR"?i*p:i*p+(1-i)*w}_calculateExpectedDamage(e,t,n,i,r){const{weapon:o,r:a,c:l}=e;if(o==="SONAR")return 0;let c=0;const d=o==="AP"?n.apDamage:1,u=this._getWeaponCoverage(o,a,l);for(const f of u)if(f.r>=0&&f.r<g&&f.c>=0&&f.c<g){const m=i[f.r][f.c],p=Math.max(0,r-m),h=Math.min(d,p);c+=t[f.r][f.c]*h}return c}_getWeaponCoverage(e,t,n){const i=pt[e];return i?i.previewArea({r:t,c:n}).cells:[{r:t,c:n}]}_executeAction(e,t,n,i,r,o,a){const{weapon:l,r:c,c:d}=e;if(l==="SONAR")this._executeSonar(c,d,n,r);else{const u=this._getWeaponCoverage(l,c,d),f=l==="AP"?t.apDamage:1;for(const m of u)if(m.r>=0&&m.r<g&&m.c>=0&&m.c<g){const p=this._resolveHit(m.r,m.c,f,n,i);p.cellState&&(r[m.r][m.c]=p.cellState),o[m.r][m.c]+=f,p.hit&&(a==="A"?(this.stats.hitsA++,this.stats.damageA+=p.damage):(this.stats.hitsB++,this.stats.damageB+=p.damage)),p.sunk&&this._markSunkShip(p.ship,r)}}}_resolveHit(e,t,n,i,r){const o=i[e][t];if(o.hit&&o.shipId===-1)return{hit:!1,cellState:null,damage:0};if(o.hit=!0,o.shipId!==-1){const a=r[o.shipId],l=o.segmentIndex;if(a.hp[l]<=0)return{hit:!0,cellState:y.DESTROYED,damage:0,ship:a};const c=Math.min(n,a.hp[l]);a.hp[l]-=n;const d=a.hp[l]<=0?y.DESTROYED:y.HIT,u=a.hp.every(f=>f<=0)&&!a.sunk;return u&&(a.sunk=!0),{hit:!0,cellState:d,damage:c,sunk:u,ship:a}}else return{hit:!1,cellState:y.MISS,damage:0}}_executeSonar(e,t,n,i){let r=!1;for(let o=-1;o<=1;o++){for(let a=-1;a<=1;a++){const l=e+o,c=t+a;if(l>=0&&l<g&&c>=0&&c<g&&n[l][c].shipId!==-1&&i[l][c]===y.UNKNOWN){r=!0;break}}if(r)break}if(r&&i[e][t]===y.UNKNOWN)i[e][t]=y.SUSPECT;else if(!r)for(let o=-1;o<=1;o++)for(let a=-1;a<=1;a++){const l=e+o,c=t+a;l>=0&&l<g&&c>=0&&c<g&&i[l][c]===y.UNKNOWN&&(i[l][c]=y.MISS)}}_markSunkShip(e,t){for(let n=0;n<e.len;n++){const i=e.v?e.r+n:e.r,r=e.v?e.c:e.c+n;t[i][r]=y.SUNK}}_makeRandomDecision(e,t){let n,i,r=0;do n=Math.floor(Math.random()*g),i=Math.floor(Math.random()*g),r++;while((e[n][i]===y.MISS||e[n][i]===y.DESTROYED||e[n][i]===y.SUNK)&&r<200);return t.canUseAir&&Math.random()<.1?{r:n,c:i,weapon:"HE"}:t.canUseSonar&&Math.random()<.1?{r:n,c:i,weapon:"SONAR"}:{r:n,c:i,weapon:"AP"}}_findFallbackTarget(e){for(let t=0;t<g;t++)for(let n=0;n<g;n++){const i=e[t][n];if(i!==y.MISS&&i!==y.DESTROYED&&i!==y.SUNK)return{r:t,c:n,weapon:"AP"}}return{r:0,c:0,weapon:"AP"}}_isAllSunk(e){return e.every(t=>t.sunk)}}class Pn{constructor(e,t,n=mt){this.ships=e,this.viewGrid=t,this.boardSize=g,this.constraints=this._buildConstraints(),this.samples=this._sampleConfigurations(n),this._probabilityGrid=null,this._entropy=null}_buildConstraints(){const e=[],t=[],n=[];for(let i=0;i<this.boardSize;i++)for(let r=0;r<this.boardSize;r++){const o=this.viewGrid[i][r];o===y.HIT||o===y.DESTROYED?e.push({r:i,c:r}):o===y.MISS||o===y.SUNK?t.push({r:i,c:r}):o===y.SUSPECT&&n.push({r:i,c:r})}return{mustHit:e,mustAvoid:t,suspect:n}}_sampleConfigurations(e){const t=[];let n=0;const i=e*20;for(;t.length<e&&n<i;){n++;const r=this._sampleOneConfiguration();r&&t.push(r)}for(;t.length<e&&t.length>0;)t.push(t[Math.floor(Math.random()*t.length)]);return t}_sampleOneConfiguration(){const e=new Set,t=[],n=[...this.ships].sort((i,r)=>r.len-i.len);for(const i of n){const r=this._sampleShipPlacement(i,e);if(!r)return null;t.push(r),r.cells.forEach(o=>e.add(`${o.r},${o.c}`))}return this._validateMustHit(t)?t:null}_sampleShipPlacement(e,t){const n=[];for(let o=0;o<=1;o++){const a=o===1,l=a?this.boardSize-e.len:this.boardSize-1,c=a?this.boardSize-1:this.boardSize-e.len;for(let d=0;d<=l;d++)for(let u=0;u<=c;u++){const f=[];let m=!0,p=0,h=0;for(let v=0;v<e.len;v++){const w=a?d+v:d,I=a?u:u+v,E=`${w},${I}`;if(t.has(E)){m=!1;break}const A=this.viewGrid[w][I];if(A===y.MISS||A===y.SUNK){m=!1;break}f.push({r:w,c:I}),(A===y.HIT||A===y.DESTROYED)&&p++,A===y.SUSPECT&&h++}if(m){const v=1+p*10+h*2;n.push({cells:f,weight:v,shipId:e.id})}}}if(n.length===0)return null;const i=n.reduce((o,a)=>o+a.weight,0);let r=Math.random()*i;for(const o of n)if(r-=o.weight,r<=0)return o;return n[n.length-1]}_validateMustHit(e){const t=new Set;for(const n of e)for(const i of n.cells){const r=this.viewGrid[i.r][i.c];(r===y.HIT||r===y.DESTROYED)&&t.add(`${i.r},${i.c}`)}for(const n of this.constraints.mustHit)if(!t.has(`${n.r},${n.c}`))return!1;return!0}getProbabilityGrid(){if(this._probabilityGrid)return this._probabilityGrid;const e=Array(this.boardSize).fill(0).map(()=>Array(this.boardSize).fill(0));if(this.samples.length===0)return e;for(const n of this.samples)for(const i of n)for(const r of i.cells)e[r.r][r.c]++;const t=this.samples.length;for(let n=0;n<this.boardSize;n++)for(let i=0;i<this.boardSize;i++)e[n][i]/=t;for(let n=0;n<this.boardSize;n++)for(let i=0;i<this.boardSize;i++){const r=this.viewGrid[n][i];r===y.HIT?e[n][i]=1:(r===y.MISS||r===y.DESTROYED||r===y.SUNK)&&(e[n][i]=0)}return this._probabilityGrid=e,e}getEntropy(){if(this._entropy!==null)return this._entropy;const e=this.getProbabilityGrid();let t=0;for(let n=0;n<this.boardSize;n++)for(let i=0;i<this.boardSize;i++){const r=this.viewGrid[n][i];if(r===y.UNKNOWN||r===y.SUSPECT){const o=e[n][i];o>G&&o<1-G&&(t-=o*Math.log2(o)+(1-o)*Math.log2(1-o))}}return this._entropy=t,t}getConditionalEntropy(e){const{weapon:t,r:n,c:i}=e,r=this.getProbabilityGrid(),o=this.getEntropy();if(t==="SONAR"){const a=n>=0&&n<this.boardSize&&i>=0&&i<this.boardSize?r[n][i]:0;let l=0;for(let u=-1;u<=1;u++)for(let f=-1;f<=1;f++){const m=n+u,p=i+f;if(m>=0&&m<this.boardSize&&p>=0&&p<this.boardSize){const h=this.viewGrid[m][p];if(h===y.UNKNOWN||h===y.SUSPECT){const v=r[m][p];v>G&&v<1-G&&(l+=-v*Math.log2(v)-(1-v)*Math.log2(1-v))}}}const c=this._cellEntropy(a),d=a*(o-c)+(1-a)*(o-l);return Math.max(0,o-Math.max(0,o-d))}else{const a=this._getWeaponCoverage(t,n,i);let l=0;for(const c of a)if(c.r>=0&&c.r<this.boardSize&&c.c>=0&&c.c<this.boardSize){const d=this.viewGrid[c.r][c.c];if(d===y.UNKNOWN||d===y.SUSPECT){const u=r[c.r][c.c];l+=this._cellEntropy(u)}}return Math.max(0,o-l)}}_cellEntropy(e){return e<G||e>1-G?0:-e*Math.log2(e)-(1-e)*Math.log2(1-e)}_getWeaponCoverage(e,t,n){const i=pt[e];return i?i.previewArea({r:t,c:n}).cells:[{r:t,c:n}]}}function Cn(s,e,t={}){return new ht(s,e,t).run()}function We(s,e,t,n={}){let i=0,r=0,o=0,a=0;for(let l=0;l<t;l++){const c=Cn(s,e,n);c.winner==="A"?i++:c.winner==="B"?r++:o++,a+=c.stats.turns}return{winsA:i,winsB:r,draws:o,avgTurns:a/t,winRateA:i/t}}async function Mn(s,e,t={}){const{onTurn:n,yieldInterval:i=10}=t,r=new ht(s,e,t);let o="A";for(;r.stats.turns<r.maxTurns;){if(r.stats.turns++,n&&n(r.stats.turns),o==="A"){if(r._executeTurn(r.configA,r.shipsA,r.shipsB,r.gridB,r.viewGridA,r.damageGridA,"A"),r._isAllSunk(r.shipsB)){r.stats.winner="A";break}o="B"}else{if(r._executeTurn(r.configB,r.shipsB,r.shipsA,r.gridA,r.viewGridB,r.damageGridB,"B"),r._isAllSunk(r.shipsA)){r.stats.winner="B";break}o="A"}r.stats.turns%i===0&&await new Promise(a=>{typeof requestAnimationFrame<"u"?requestAnimationFrame(()=>setTimeout(a,0)):setTimeout(a,0)})}return r.stats.winner||(r.stats.winner="DRAW"),{winner:r.stats.winner,stats:{...r.stats}}}const yt={alphaRange:[.3,.7,.1],riskRange:[0,.4,.1],gamesPerPair:20,testRandomness:0,verbose:!0},vt={alphaRange:[.3,.7,.2],riskRange:[0,.4,.2],gamesPerPair:10,verbose:!0},bt={alphaRange:[.1,.9,.1],riskRange:[0,.6,.1],gamesPerPair:30,verbose:!0};class Q{constructor(e={}){this.config={...yt,...e},this.grid=[],this.results=new Map,this.matchResults=[],this.isRunning=!1,this.shouldStop=!1,this.progress={current:0,total:0,phase:"",currentMatch:null,currentGame:0,currentTurn:0,totalGames:0},this.onProgress=null,this.onComplete=null}_generateGrid(){const{alphaRange:e,riskRange:t,testRandomness:n}=this.config,[i,r,o]=e,[a,l,c]=t,d=[];for(let u=i;u<=r+1e-9;u+=o)for(let f=a;f<=l+1e-9;f+=c)d.push({alpha:Math.round(u*100)/100,riskAwareness:Math.round(f*100)/100,randomness:n});return d}_configKey(e){return`Œ±${e.alpha.toFixed(2)}_r${e.riskAwareness.toFixed(2)}`}_generateMatchups(){const e=[];for(let t=0;t<this.grid.length;t++)for(let n=t+1;n<this.grid.length;n++)e.push({configA:this.grid[t],configB:this.grid[n],keyA:this._configKey(this.grid[t]),keyB:this._configKey(this.grid[n])});return e}_initResults(){this.results.clear();for(const e of this.grid){const t=this._configKey(e);this.results.set(t,{config:e,wins:0,losses:0,draws:0,games:0,totalTurns:0})}}async start(){if(this.isRunning){console.warn("‚ö†Ô∏è ÁΩëÊ†ºÊêúÁ¥¢Â∑≤Âú®ËøêË°å‰∏≠");return}this.isRunning=!0,this.shouldStop=!1,this.matchResults=[],this.grid=this._generateGrid();const e=this._generateMatchups();this._initResults();const t=e.length,n=this.config.gamesPerPair,i=t*n;this.progress={current:0,total:t,phase:"ÂáÜÂ§á‰∏≠",currentMatch:null,currentGame:0,currentTurn:0,totalGames:i},console.log(""),console.log("üîç ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("   ÂèÇÊï∞ÁΩëÊ†ºÊêúÁ¥¢ - Âæ™ÁéØËµõÊ®°ÂºèÔºàÂçïÁ∫øÁ®ãÔºâ"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log(`üìä ÂèÇÊï∞ÁªÑÂêàÊï∞: ${this.grid.length}`),console.log(`‚öîÔ∏è  ÂØπÊàòÈÖçÂØπÊï∞: ${t}`),console.log(`üéÆ ÊØèÂØπÂØπÊàòÂú∫Ê¨°: ${n}`),console.log(`üìà ÊÄªÂØπÊàòÂú∫Ê¨°: ${i}`),console.log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"),console.log("");const r=Date.now();this.progress.phase="ÂØπÊàò‰∏≠";for(let l=0;l<e.length;l++){if(this.shouldStop){console.log("‚èπÔ∏è ÊêúÁ¥¢Â∑≤‰∏≠Ê≠¢");break}const c=e[l];this.progress.currentMatch={configA:`Œ±=${c.configA.alpha}, r=${c.configA.riskAwareness}`,configB:`Œ±=${c.configB.alpha}, r=${c.configB.riskAwareness}`};const d=await this._runMatchupWithProgress(c);if(this._recordMatchResult(d),this.progress.current=l+1,this.onProgress&&this.onProgress(this.getProgressInfo()),await this._yieldToUI(),this.config.verbose&&this.progress.current%Math.max(1,Math.floor(t/20))===0){const u=Math.round(this.progress.current/this.progress.total*100),f=((Date.now()-r)/1e3).toFixed(1),m=this.progress.current>0?((Date.now()-r)/this.progress.current*(t-this.progress.current)/1e3).toFixed(0):"?";console.log(`üìà ËøõÂ∫¶: ${this.progress.current}/${t} (${u}%) | Â∑≤Áî® ${f}s | È¢ÑËÆ°Ââ©‰Ωô ${m}s`)}}const o=((Date.now()-r)/1e3).toFixed(1);this.progress.phase="ÂÆåÊàê",console.log(""),console.log(`‚úÖ ÊêúÁ¥¢ÂÆåÊàêÔºÅÊÄªËÄóÊó∂ ${o} Áßí`);const a=this._getSortedResults();return this._printResults(a),this.onComplete&&this.onComplete(a),this.isRunning=!1,a}async _yieldToUI(){return new Promise(e=>{typeof requestAnimationFrame<"u"?requestAnimationFrame(()=>setTimeout(e,0)):setTimeout(e,0)})}stop(){this.shouldStop=!0,console.log("üõë Ê≠£Âú®ÂÅúÊ≠¢ÊêúÁ¥¢...")}async _runMatchupWithProgress(e){const{configA:t,configB:n,keyA:i,keyB:r}=e,o=Math.floor(this.config.gamesPerPair/2);let a=0,l=0,c=0,d=0;for(let u=0;u<o&&!this.shouldStop;u++){this.progress.currentGame=u+1,this.progress.currentTurn=0;const f=await this._runSingleGameWithProgress(t,n);f.winner==="A"?a++:f.winner==="B"?l++:c++,d+=f.stats.turns,this.onProgress&&this.onProgress(this.getProgressInfo()),await this._yieldToUI()}for(let u=0;u<o&&!this.shouldStop;u++){this.progress.currentGame=o+u+1,this.progress.currentTurn=0;const f=await this._runSingleGameWithProgress(n,t);f.winner==="A"?l++:f.winner==="B"?a++:c++,d+=f.stats.turns,this.onProgress&&this.onProgress(this.getProgressInfo()),await this._yieldToUI()}return{keyA:i,keyB:r,winsA:a,winsB:l,draws:c,totalGames:a+l+c,totalTurns:d}}async _runSingleGameWithProgress(e,t){const n=this;return await Mn(e,t,{onTurn:i=>{n.progress.currentTurn=i},yieldInterval:10})}_recordMatchResult(e){const{keyA:t,keyB:n,winsA:i,winsB:r,draws:o,totalGames:a,totalTurns:l}=e,c=this.results.get(t);c.wins+=i,c.losses+=r,c.draws+=o,c.games+=a,c.totalTurns+=l;const d=this.results.get(n);d.wins+=r,d.losses+=i,d.draws+=o,d.games+=a,d.totalTurns+=l,this.matchResults.push(e)}_getSortedResults(){return Array.from(this.results.values()).map(t=>({...t,winRate:t.games>0?t.wins/t.games:0,avgTurns:t.games>0?t.totalTurns/t.games:0})).sort((t,n)=>n.winRate-t.winRate)}_printResults(e){if(e.length===0){console.log("‚ö†Ô∏è Ê≤°ÊúâÁªìÊûú");return}console.log(""),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("üìä Âæ™ÁéØËµõÁªìÊûúÊéíÂêçÔºàÊåâÁªºÂêàËÉúÁéáÔºâ"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log(""),console.log("ÊéíÂêç ‚îÇ Alpha ‚îÇ Risk ‚îÇ  ËÉúÁéá  ‚îÇ   ËÉú   ‚îÇ   Ë¥ü   ‚îÇ  Âπ≥  ‚îÇ Âπ≥ÂùáÂõûÂêà"),console.log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");const t=Math.min(20,e.length);for(let i=0;i<t;i++){const r=e[i],o=String(i+1).padStart(3," "),a=r.config.alpha.toFixed(2),l=r.config.riskAwareness.toFixed(2),c=(r.winRate*100).toFixed(1).padStart(5," ")+"%",d=String(r.wins).padStart(6," "),u=String(r.losses).padStart(6," "),f=String(r.draws).padStart(4," "),m=r.avgTurns.toFixed(1).padStart(8," ");console.log(`${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":"  "}${o} ‚îÇ ${a}  ‚îÇ ${l} ‚îÇ ${c} ‚îÇ ${d} ‚îÇ ${u} ‚îÇ ${f} ‚îÇ ${m}`)}console.log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"),console.log("");const n=e[0];console.log("üèÜ ÊúÄ‰ºòÂèÇÊï∞ÁªÑÂêà:"),console.log(`   alpha: ${n.config.alpha}`),console.log(`   riskAwareness: ${n.config.riskAwareness}`),console.log(`   ÁªºÂêàËÉúÁéá: ${(n.winRate*100).toFixed(2)}%`),console.log(`   ÊÄªÂØπÂ±Ä: ${n.games} Âú∫`),console.log(""),window.gridSearchResults={sorted:e,heatmap:this._generateHeatmapData(e),matchResults:this.matchResults},console.log("üìà ÂÆåÊï¥Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞ window.gridSearchResults")}_generateHeatmapData(e){const t={};for(const n of e){const i=`${n.config.alpha},${n.config.riskAwareness}`;t[i]=n.winRate}return t}getProgressInfo(){const e=this._getSortedResults();return{...this.progress,percent:this.progress.total>0?this.progress.current/this.progress.total:0,results:e.slice(0,10),isRunning:this.isRunning,gamesPerPair:this.config.gamesPerPair}}}async function _n(){return await new Q(vt).start()}async function Dn(){return await new Q(bt).start()}async function Gn(s){return await new Q(s).start()}function Nn(s,e,t=100){console.log("‚öîÔ∏è ÈÖçÁΩÆÂØπÊØîÊµãËØï..."),console.log(`   ÈÖçÁΩÆ A: alpha=${s.alpha}, risk=${s.riskAwareness||0}`),console.log(`   ÈÖçÁΩÆ B: alpha=${e.alpha}, risk=${e.riskAwareness||0}`),console.log(`   ÂØπÊàòÊ¨°Êï∞: ${t}`),console.log("");const n={alpha:.5,randomness:0,riskAwareness:0,...s},i={alpha:.5,randomness:0,riskAwareness:0,...e},r=We(n,i,Math.floor(t/2)),o=We(i,n,Math.floor(t/2)),a=r.winsA+o.winsB,l=r.winsB+o.winsA,c=r.draws+o.draws,d=a+l+c;return console.log("üìä ÁªìÊûú:"),console.log(`   ÈÖçÁΩÆ A ËÉú: ${a} (${(a/d*100).toFixed(1)}%)`),console.log(`   ÈÖçÁΩÆ B ËÉú: ${l} (${(l/d*100).toFixed(1)}%)`),console.log(`   Âπ≥Â±Ä: ${c}`),console.log(`   Âπ≥ÂùáÂõûÂêà: ${((r.avgTurns+o.avgTurns)/2).toFixed(1)}`),{winsA:a,winsB:l,draws:c,winRateA:a/d,winRateB:l/d}}function Rn(){if(document.getElementById("grid-search-modal")){document.getElementById("grid-search-modal").style.display="flex";return}const s=document.createElement("div");if(s.id="grid-search-modal",s.innerHTML=$n(),document.body.appendChild(s),!document.getElementById("grid-search-styles")){const e=document.createElement("style");e.id="grid-search-styles",e.textContent=Un(),document.head.appendChild(e)}Hn()}function $n(){return`
        <div class="gs-overlay" onclick="GridSearch.closeUI()"></div>
        <div class="gs-container">
            <div class="gs-header">
                <h2>üîç AI ÂèÇÊï∞ÁΩëÊ†ºÊêúÁ¥¢</h2>
                <button class="gs-close" onclick="GridSearch.closeUI()">√ó</button>
            </div>
            
            <div class="gs-body">
                \x3C!-- ÂèÇÊï∞ÈÖçÁΩÆÂå∫ -->
                <div class="gs-section">
                    <h3>üìä ÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆ</h3>
                    <div class="gs-config-grid">
                        <div class="gs-config-group">
                            <label>Alpha ËåÉÂõ¥</label>
                            <div class="gs-range-inputs">
                                <input type="number" id="gs-alpha-min" value="0.3" min="0" max="1" step="0.1">
                                <span>~</span>
                                <input type="number" id="gs-alpha-max" value="0.7" min="0" max="1" step="0.1">
                                <span>Ê≠•Èïø</span>
                                <input type="number" id="gs-alpha-step" value="0.1" min="0.05" max="0.5" step="0.05">
                            </div>
                        </div>
                        <div class="gs-config-group">
                            <label>Risk ËåÉÂõ¥</label>
                            <div class="gs-range-inputs">
                                <input type="number" id="gs-risk-min" value="0.0" min="0" max="1" step="0.1">
                                <span>~</span>
                                <input type="number" id="gs-risk-max" value="0.4" min="0" max="1" step="0.1">
                                <span>Ê≠•Èïø</span>
                                <input type="number" id="gs-risk-step" value="0.1" min="0.05" max="0.5" step="0.05">
                            </div>
                        </div>
                        <div class="gs-config-group">
                            <label>ÊØèÂØπÊàòÂú∫Ê¨°</label>
                            <input type="number" id="gs-games" value="20" min="4" max="200" step="2">
                        </div>
                    </div>
                    
                    <div class="gs-preset-buttons">
                        <button onclick="GridSearch.applyPreset('quick')">‚ö° Âø´ÈÄüÊêúÁ¥¢</button>
                        <button onclick="GridSearch.applyPreset('default')">üéØ ÈªòËÆ§ÈÖçÁΩÆ</button>
                        <button onclick="GridSearch.applyPreset('full')">üî¨ ÂÆåÊï¥ÊêúÁ¥¢</button>
                    </div>
                </div>
                
                \x3C!-- È¢Ñ‰º∞‰ø°ÊÅØ -->
                <div class="gs-section gs-estimate">
                    <div class="gs-estimate-item">
                        <span class="gs-estimate-label">ÂèÇÊï∞ÁªÑÂêà</span>
                        <span class="gs-estimate-value" id="gs-est-configs">-</span>
                    </div>
                    <div class="gs-estimate-item">
                        <span class="gs-estimate-label">ÂØπÊàòÈÖçÂØπ</span>
                        <span class="gs-estimate-value" id="gs-est-matches">-</span>
                    </div>
                    <div class="gs-estimate-item">
                        <span class="gs-estimate-label">ÊÄªÂú∫Ê¨°</span>
                        <span class="gs-estimate-value" id="gs-est-games">-</span>
                    </div>
                </div>
                
                \x3C!-- ÊéßÂà∂ÊåâÈíÆ -->
                <div class="gs-section gs-controls">
                    <button id="gs-start-btn" class="gs-btn-primary" onclick="GridSearch.startSearch()">
                        üöÄ ÂºÄÂßãÊêúÁ¥¢
                    </button>
                    <button id="gs-stop-btn" class="gs-btn-danger" onclick="GridSearch.stopSearch()" disabled>
                        ‚èπÔ∏è ÂÅúÊ≠¢
                    </button>
                </div>
                
                \x3C!-- ËøõÂ∫¶Âå∫ -->
                <div class="gs-section gs-progress-section" id="gs-progress-section" style="display:none">
                    <h3>‚è≥ ÊêúÁ¥¢ËøõÂ∫¶</h3>
                    <div class="gs-progress-bar">
                        <div class="gs-progress-fill" id="gs-progress-fill"></div>
                    </div>
                    <div class="gs-progress-text" id="gs-progress-text">ÂáÜÂ§á‰∏≠...</div>
                    <div class="gs-progress-detail" id="gs-progress-detail"></div>
                </div>
                
                \x3C!-- ÂÆûÊó∂ÁªìÊûú -->
                <div class="gs-section gs-results-section" id="gs-results-section" style="display:none">
                    <h3>üìà ÂÆûÊó∂ÊéíÂêç (Ââç10)</h3>
                    <div class="gs-results-table-wrapper">
                        <table class="gs-results-table" id="gs-results-table">
                            <thead>
                                <tr>
                                    <th>ÊéíÂêç</th>
                                    <th>Alpha</th>
                                    <th>Risk</th>
                                    <th>ËÉúÁéá</th>
                                    <th>ËÉú/Ë¥ü/Âπ≥</th>
                                </tr>
                            </thead>
                            <tbody id="gs-results-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                \x3C!-- ÁÉ≠ÂäõÂõæ -->
                <div class="gs-section gs-heatmap-section" id="gs-heatmap-section" style="display:none">
                    <h3>üå°Ô∏è ËÉúÁéáÁÉ≠ÂäõÂõæ</h3>
                    <div class="gs-heatmap" id="gs-heatmap"></div>
                </div>
            </div>
        </div>
    `}function Un(){return`
        #grid-search-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .gs-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }
        
        .gs-container {
            position: relative;
            background: #1a1a2e;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        
        .gs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #333;
            background: #16213e;
            border-radius: 12px 12px 0 0;
        }
        
        .gs-header h2 {
            margin: 0;
            color: #fff;
            font-size: 20px;
        }
        
        .gs-close {
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .gs-close:hover { color: #fff; }
        
        .gs-body { padding: 20px 24px; }
        
        .gs-section { margin-bottom: 20px; }
        
        .gs-section h3 {
            color: #4cc9f0;
            font-size: 14px;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .gs-config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .gs-config-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .gs-config-group label {
            color: #aaa;
            font-size: 12px;
        }
        
        .gs-range-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gs-range-inputs span { color: #666; }
        
        .gs-config-group input {
            background: #0f0f1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-size: 14px;
            width: 60px;
        }
        
        .gs-config-group input:focus {
            outline: none;
            border-color: #4cc9f0;
        }
        
        .gs-preset-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .gs-preset-buttons button {
            flex: 1;
            padding: 10px;
            background: #252540;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .gs-preset-buttons button:hover {
            background: #333355;
            border-color: #4cc9f0;
        }
        
        .gs-estimate {
            display: flex;
            justify-content: space-around;
            background: #0f0f1a;
            border-radius: 8px;
            padding: 16px;
        }
        
        .gs-estimate-item { text-align: center; }
        
        .gs-estimate-label {
            display: block;
            color: #666;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .gs-estimate-value {
            color: #4cc9f0;
            font-size: 20px;
            font-weight: bold;
        }
        
        .gs-controls {
            display: flex;
            gap: 12px;
        }
        
        .gs-btn-primary {
            flex: 2;
            padding: 14px 24px;
            background: linear-gradient(135deg, #4cc9f0, #7209b7);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .gs-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 201, 240, 0.4);
        }
        
        .gs-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .gs-btn-danger {
            flex: 1;
            padding: 14px 24px;
            background: #dc3545;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        
        .gs-btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .gs-progress-bar {
            height: 20px;
            background: #0f0f1a;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .gs-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4cc9f0, #7209b7);
            width: 0%;
            transition: width 0.3s;
        }
        
        .gs-progress-text {
            color: #fff;
            font-size: 14px;
            text-align: center;
            margin-bottom: 4px;
        }
        
        .gs-progress-detail {
            color: #888;
            font-size: 12px;
            text-align: center;
            font-family: monospace;
        }
        
        .gs-results-table-wrapper {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .gs-results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .gs-results-table th,
        .gs-results-table td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        
        .gs-results-table th {
            background: #16213e;
            color: #4cc9f0;
            font-size: 12px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
        }
        
        .gs-results-table td {
            color: #fff;
            font-size: 14px;
        }
        
        .gs-results-table tr:hover td { background: #252540; }
        
        .gs-rank-1 { color: #ffd700 !important; font-weight: bold; }
        .gs-rank-2 { color: #c0c0c0 !important; }
        .gs-rank-3 { color: #cd7f32 !important; }
        
        .gs-heatmap {
            display: grid;
            gap: 2px;
            padding: 10px;
            background: #0f0f1a;
            border-radius: 8px;
        }
        
        .gs-heatmap-cell {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .gs-heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 1;
        }
        
        .gs-heatmap-label {
            color: #666;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    `}function Hn(){["gs-alpha-min","gs-alpha-max","gs-alpha-step","gs-risk-min","gs-risk-max","gs-risk-step","gs-games"].forEach(e=>{document.getElementById(e).addEventListener("input",ue)}),ue()}function ue(){const s=parseFloat(document.getElementById("gs-alpha-min").value)||0,e=parseFloat(document.getElementById("gs-alpha-max").value)||1,t=parseFloat(document.getElementById("gs-alpha-step").value)||.1,n=parseFloat(document.getElementById("gs-risk-min").value)||0,i=parseFloat(document.getElementById("gs-risk-max").value)||1,r=parseFloat(document.getElementById("gs-risk-step").value)||.1,o=parseInt(document.getElementById("gs-games").value)||20,a=Math.floor((e-s)/t)+1,l=Math.floor((i-n)/r)+1,c=a*l,d=c*(c-1)/2,u=d*o;document.getElementById("gs-est-configs").textContent=c,document.getElementById("gs-est-matches").textContent=d,document.getElementById("gs-est-games").textContent=u.toLocaleString()}function On(s){let e;switch(s){case"quick":e=vt;break;case"full":e=bt;break;default:e=yt}document.getElementById("gs-alpha-min").value=e.alphaRange[0],document.getElementById("gs-alpha-max").value=e.alphaRange[1],document.getElementById("gs-alpha-step").value=e.alphaRange[2],document.getElementById("gs-risk-min").value=e.riskRange[0],document.getElementById("gs-risk-max").value=e.riskRange[1],document.getElementById("gs-risk-step").value=e.riskRange[2],document.getElementById("gs-games").value=e.gamesPerPair,ue()}let U=null;async function Wn(){const s={alphaRange:[parseFloat(document.getElementById("gs-alpha-min").value),parseFloat(document.getElementById("gs-alpha-max").value),parseFloat(document.getElementById("gs-alpha-step").value)],riskRange:[parseFloat(document.getElementById("gs-risk-min").value),parseFloat(document.getElementById("gs-risk-max").value),parseFloat(document.getElementById("gs-risk-step").value)],gamesPerPair:parseInt(document.getElementById("gs-games").value),verbose:!1};document.getElementById("gs-start-btn").disabled=!0,document.getElementById("gs-stop-btn").disabled=!1,document.getElementById("gs-progress-section").style.display="block",document.getElementById("gs-results-section").style.display="block",document.getElementById("gs-progress-fill").style.width="0%",document.getElementById("gs-progress-text").textContent="ÂáÜÂ§á‰∏≠...",document.getElementById("gs-progress-detail").textContent="",document.getElementById("gs-results-tbody").innerHTML="",U=new Q(s),U.onProgress=e=>{Yn(e)},U.onComplete=e=>{Fn(e)},await new Promise(e=>setTimeout(e,50)),await U.start()}function zn(){U&&U.stop(),document.getElementById("gs-start-btn").disabled=!1,document.getElementById("gs-stop-btn").disabled=!0}function Yn(s){const e=Math.round(s.percent*100);document.getElementById("gs-progress-fill").style.width=`${e}%`,document.getElementById("gs-progress-text").textContent=`${s.phase} - ÈÖçÂØπ ${s.current}/${s.total} (${e}%)`;let t="";s.currentMatch&&(t=`ÂΩìÂâç: ${s.currentMatch.configA} vs ${s.currentMatch.configB}`,t+=` | Á¨¨ ${s.currentGame}/${s.gamesPerPair||"?"} Âú∫`,t+=` | ÂõûÂêà ${s.currentTurn}`),document.getElementById("gs-progress-detail").textContent=t;const n=document.getElementById("gs-results-tbody");n.innerHTML="",s.results&&s.results.length>0&&s.results.forEach((i,r)=>{const o=document.createElement("tr"),a=r<3?`gs-rank-${r+1}`:"",l=r===0?"ü•á":r===1?"ü•à":r===2?"ü•â":`#${r+1}`;o.innerHTML=`
                <td class="${a}">${l}</td>
                <td>${i.config.alpha.toFixed(2)}</td>
                <td>${i.config.riskAwareness.toFixed(2)}</td>
                <td class="${a}">${(i.winRate*100).toFixed(1)}%</td>
                <td>${i.wins}/${i.losses}/${i.draws}</td>
            `,n.appendChild(o)})}function Fn(s){document.getElementById("gs-start-btn").disabled=!1,document.getElementById("gs-stop-btn").disabled=!0,document.getElementById("gs-progress-text").textContent="‚úÖ ÊêúÁ¥¢ÂÆåÊàêÔºÅ",document.getElementById("gs-progress-detail").textContent="",Kn(s)}function Kn(s){const e=document.getElementById("gs-heatmap-section"),t=document.getElementById("gs-heatmap");e.style.display="block";const n=[...new Set(s.map(c=>c.config.alpha))].sort((c,d)=>c-d),i=[...new Set(s.map(c=>c.config.riskAwareness))].sort((c,d)=>c-d),r=new Map;s.forEach(c=>{r.set(`${c.config.alpha},${c.config.riskAwareness}`,c)});const o=s.map(c=>c.winRate),a=Math.min(...o),l=Math.max(...o);t.innerHTML="",t.style.gridTemplateColumns=`40px repeat(${n.length}, 1fr)`,t.innerHTML+='<div class="gs-heatmap-label"></div>',n.forEach(c=>{t.innerHTML+=`<div class="gs-heatmap-label">Œ±${c}</div>`}),i.forEach(c=>{t.innerHTML+=`<div class="gs-heatmap-label">r${c}</div>`,n.forEach(d=>{const u=`${d},${c}`,f=r.get(u);if(f){const h=`hsl(${(f.winRate-a)/(l-a||1)*120}, 70%, 45%)`;t.innerHTML+=`
                    <div class="gs-heatmap-cell" 
                         style="background: ${h}"
                         title="Œ±=${d}, r=${c}
ËÉúÁéá: ${(f.winRate*100).toFixed(1)}%">
                        ${(f.winRate*100).toFixed(0)}
                    </div>
                `}else t.innerHTML+='<div class="gs-heatmap-cell" style="background: #333">-</div>'})})}function Vn(){const s=document.getElementById("grid-search-modal");s&&(s.style.display="none")}typeof window<"u"&&(window.GridSearch={GridSearchController:Q,runQuickSearch:_n,runFullSearch:Dn,runCustomSearch:Gn,compare:Nn,openUI:Rn,closeUI:Vn,applyPreset:On,startSearch:Wn,stopSearch:zn},console.log(""),console.log("üîß ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("   AI ÂèÇÊï∞Ë∞É‰ºòÂ∑•ÂÖ∑Â∑≤Âä†ËΩΩÔºàÂçïÁ∫øÁ®ãÁâàÔºâ"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log(""),console.log("üìå ÊâìÂºÄÂèØËßÜÂåñÁïåÈù¢:  GridSearch.openUI()"),console.log("‚ö° Âø´ÈÄüÊêúÁ¥¢:        GridSearch.runQuickSearch()"),console.log("üî¨ ÂÆåÊï¥ÊêúÁ¥¢:        GridSearch.runFullSearch()"),console.log("‚öîÔ∏è  ÈÖçÁΩÆÂØπÊØî:        GridSearch.compare({alpha: 0.5}, {alpha: 0.7})"),console.log(""));window.addEventListener("DOMContentLoaded",()=>{const s=document.querySelector("header h1");s&&(s.textContent=`${St} (${At})`),Zt()});</script>
  <style rel="stylesheet" crossorigin>:root{--bg-color: #1a202c;--panel-bg: #2d3748;--water: #2b6cb0;--accent: #ed8936;--text: #e2e8f0;--cell-size: 40px;--board-size: 10}*{box-sizing:border-box}body{font-family:Segoe UI,sans-serif;background-color:var(--bg-color);color:var(--text);margin:0;height:100vh;display:flex;flex-direction:column;-webkit-user-select:none;user-select:none}header{height:50px;background:#171923;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px #00000080;z-index:50}h1{margin:0;font-size:1.2rem;color:var(--accent);letter-spacing:2px}.layout{display:flex;flex:1;height:calc(100vh - 50px)}.center-area{flex:1;display:flex;flex-direction:column;background:radial-gradient(#2c3e50 1px,transparent 1px);background-size:20px 20px;position:relative;overflow:hidden}.scroll-view{flex:1;overflow:auto;width:100%;display:flex;flex-direction:column;position:relative}.dock-panel{width:260px;min-width:260px;background:var(--panel-bg);border-right:1px solid #4a5568;display:flex;flex-direction:column;padding:15px;z-index:30;transition:all .3s cubic-bezier(.4,0,.2,1);overflow:hidden;white-space:nowrap}.dock-header{font-weight:700;color:#90cdf4;margin-bottom:10px;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px}.dock-container{flex:1;background:#0003;border-radius:8px;padding:15px;display:flex;flex-direction:column;align-items:center;gap:15px;position:relative;overflow-y:auto}.battlefield{flex:0 0 auto;margin:auto;display:flex;justify-content:center;align-items:center;gap:40px;min-width:fit-content;padding:20px}.board-box{display:flex;flex-direction:column;align-items:center;flex-shrink:0}.board-title{margin-bottom:8px;font-weight:700}.bottom-controls{height:70px;background:#171923e6;border-top:1px solid #4a5568;display:flex;justify-content:center;align-items:center;gap:15px;padding:0 20px;z-index:40;box-shadow:0 -4px 10px #0000004d}.bottom-controls button{padding:10px 20px;font-size:14px;display:flex;align-items:center;gap:8px;min-width:120px;justify-content:center}@media(max-width:768px){.bottom-controls button{min-width:auto;padding:8px 12px}}.panel-collapsed{width:0!important;min-width:0!important;padding-left:0!important;padding-right:0!important;border:none!important;opacity:0}.toggle-btn{position:absolute;top:50%;transform:translateY(-50%);width:16px;height:40px;background:var(--panel-bg);border:1px solid #4a5568;color:var(--accent);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:90;transition:all .2s;font-size:10px;box-shadow:0 2px 8px #0000004d;opacity:.8}.toggle-btn:hover{background:#4a5568;color:#fff;width:20px;opacity:1}.toggle-left{left:0;border-left:none;border-radius:0 12px 12px 0}.toggle-right{right:0;border-right:none;border-radius:12px 0 0 12px}.grid{display:grid;grid-template-columns:repeat(var(--board-size),var(--cell-size));grid-template-rows:repeat(var(--board-size),var(--cell-size));background-color:var(--water);border:4px solid #2c5282;box-shadow:0 10px 20px #0006;position:relative}.cell{width:var(--cell-size);height:var(--cell-size);border:1px solid rgba(255,255,255,.1);box-sizing:border-box;transition:background .1s;position:relative}#enemy-grid .cell{z-index:5}#player-grid .cell{z-index:auto}.cell.highlight-valid{background-color:#48bb78b3!important;box-shadow:inset 0 0 0 2px #fff}.cell.highlight-invalid{background-color:#f56565b3!important;box-shadow:inset 0 0 0 2px red}#enemy-grid .cell:hover:not(.hit):not(.miss):not(.destroyed):not(.detect){background-color:#fff3;cursor:crosshair}.hit{background-color:#ecc94b66!important;position:relative}.hit:after{content:"üí•";position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:18px;z-index:102}.destroyed{background-color:#e53e3e66!important;position:relative}.destroyed:after{content:"‚ò†Ô∏è";position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:18px;z-index:102}.detect{background-color:#ecc94b4d!important;position:relative}.detect:after{content:"‚ùì";position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:18px;z-index:102}.ai-detect{background-color:#ecc94b4d!important;position:relative}.ai-detect:after{content:"‚ùì";position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:18px;z-index:102}.miss{background-color:#ffffff1a!important;position:relative}.miss:after{content:"";position:absolute;width:10px;height:10px;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);background:#ffffff80;z-index:102}.attack-range-highlight{box-shadow:inset 0 0 0 2px #fc8181,0 0 10px #fc818180;background-color:#fc818133!important;z-index:60}.last-enemy-attack{background-color:#fc81814d!important;box-shadow:inset 0 0 0 2px #fc8181;z-index:200}.weapon-bar{display:flex;gap:8px;width:100%}.weapon-btn{flex:1;padding:10px 6px;font-size:12px;background:linear-gradient(to bottom,#2d3748,#1a202c);color:#cbd5e0;border:1px solid #4a5568;border-radius:6px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all .2s;box-shadow:0 2px 4px #0003}.weapon-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 8px #0000004d;border-color:#718096}.weapon-btn.active{background:linear-gradient(to bottom,#3182ce,#2b6cb0);color:#fff;border-color:#63b3ed;box-shadow:0 0 12px #4299e180;transform:translateY(-1px)}.weapon-btn:disabled{opacity:.5;cursor:not-allowed;background:#1a202c;filter:grayscale(1);border-color:#2d3748}.status-panel{display:flex;flex-direction:column;gap:8px;width:100%;margin-top:10px}.ship-status-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#0003;border-radius:4px;border-bottom:none;font-size:12px;margin-bottom:2px}.hp-blocks{display:flex;gap:4px}.hp-block{width:12px;height:6px;background:#48bb78;border-radius:2px;box-shadow:0 0 4px #48bb7866}.hp-block.dmg{background:#ecc94b;box-shadow:0 0 4px #ecc94b66}.hp-block.lost{background:#e53e3e;box-shadow:none;opacity:.3}.top-hit-marker{position:absolute;z-index:102;pointer-events:none;width:var(--cell-size);height:var(--cell-size);display:flex;justify-content:center;align-items:center;font-size:28px;text-shadow:0 0 5px #000}.log-panel{width:260px;min-width:260px;background:var(--panel-bg);border-left:1px solid #4a5568;display:flex;flex-direction:column;z-index:20;transition:all .3s cubic-bezier(.4,0,.2,1);overflow:hidden;white-space:normal}.log-header{padding:10px;background:#232936;text-align:center;font-weight:700;color:#90cdf4}.log-content{flex:1;overflow-y:auto;padding:10px;font-family:Consolas,monospace;font-size:12px}.log-line{margin-bottom:4px;border-bottom:1px solid #3a4657;padding-bottom:2px}.c-sys{color:#a0aec0}.c-p{color:#68d391}.c-e{color:#fc8181}.c-warn{color:var(--accent);font-weight:700}.ship{position:relative;z-index:100;cursor:grab;display:block;transition:top .1s,left .1s;touch-action:none}.ship:not(.sunk):hover .ship-inner{filter:brightness(1.2) drop-shadow(0 0 5px rgba(255,255,255,.4))}.ship-inner{width:100%;height:100%;pointer-events:none;transform-origin:top left;transition:transform .2s}.ship.dragging{opacity:.7;cursor:grabbing;z-index:9999;position:fixed!important;pointer-events:none!important;transition:none!important;transform:scale(1.05);filter:drop-shadow(5px 5px 10px rgba(0,0,0,.5))}.ship.vertical{width:var(--cell-size)!important}.ship.vertical .ship-inner{width:var(--w)!important;height:var(--h)!important;transform:rotate(90deg) translateY(-100%)}.ship.sunk{filter:grayscale(100%) brightness(.8);border:1px solid red}@keyframes shake{0%,to{transform:translate(0)}25%{transform:translate(-5px)}75%{transform:translate(5px)}}.shake{animation:shake .2s ease-in-out 2}.wreck{position:absolute;border:2px solid #fc8181;background:#0000004d;pointer-events:none;z-index:10}.revealed-enemy-ship{z-index:1!important}.btn-area{margin-top:auto;display:flex;flex-direction:column;gap:8px}button{padding:10px;border:none;border-radius:4px;font-weight:700;cursor:pointer;transition:.2s;font-size:14px}.btn-mode{background:#805ad5;color:#fff;margin-bottom:5px}.btn-mode:hover{background:#6b46c1}.btn-mode:disabled{background:#553c9a;opacity:.5;cursor:not-allowed}.btn-blue{background:#4299e1;color:#fff}.btn-blue:hover{background:#3182ce}.btn-blue:disabled{background:#2c5282;opacity:.5;cursor:not-allowed}.btn-orange{background:var(--accent);color:#1a202c}.btn-orange:hover{background:#dd6b20}.btn-orange:disabled{background:#718096;cursor:not-allowed}.btn-restart{background:#9f7aea;color:#fff}.btn-restart:hover{background:#805ad5}.difficulty-bar{display:flex;gap:5px;margin-bottom:10px}.diff-btn{flex:1;padding:6px;font-size:12px;background:#2d3748;color:#a0aec0;border:1px solid #4a5568;cursor:pointer;transition:all .2s}.diff-btn:hover{background:#4a5568}.diff-btn.active{color:#1a202c;font-weight:700}.diff-btn.active[data-difficulty=EASY]{background:#38a169;border-color:#48bb78;color:#f0fff4;box-shadow:0 0 6px #38a16980}.diff-btn.active[data-difficulty=NORMAL]{background:#ecc94b;border-color:#f6e05e;color:#442a00;box-shadow:0 0 6px #ecc94b99}.diff-btn.active[data-difficulty=HARD]{background:#e53e3e;border-color:#fc8181;color:#fff5f5;box-shadow:0 0 6px #e53e3e99}.cell.debug-heat:before{content:attr(data-heat);position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:12px;font-weight:700;color:#fff;background:var(--heat-bg, rgba(255, 0, 0, .3));z-index:200;pointer-events:none;text-shadow:0 0 2px black}#help-btn{position:fixed;bottom:20px;right:20px;width:auto;height:50px;padding:0 20px;background:var(--accent);color:#1a202c;border-radius:25px;display:flex;justify-content:center;align-items:center;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 4px 10px #00000080;z-index:1000;transition:transform .2s;gap:8px}#help-btn:hover{transform:scale(1.05)}.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:#000c;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px);animation:fadeIn .3s ease-out}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.modal-content{background:linear-gradient(135deg,#2d3748,#1a202c);margin:5% auto;padding:25px;border:1px solid #4a5568;width:80%;max-width:600px;border-radius:16px;position:relative;color:var(--text);max-height:80vh;overflow-y:auto;box-shadow:0 20px 50px #00000080;animation:slideIn .3s ease-out}@keyframes slideIn{0%{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}.close-btn{position:absolute;top:15px;right:20px;color:#718096;font-size:28px;font-weight:700;cursor:pointer;transition:color .2s}.close-btn:hover{color:#fc8181}.rules-table{width:100%;border-collapse:collapse;margin-bottom:15px;font-size:14px}.rules-table th,.rules-table td{border:1px solid #4a5568;padding:10px;text-align:left;vertical-align:middle}.rules-table th{background-color:#0000004d;color:var(--accent);font-weight:600}.rules-table tr:nth-child(2n){background-color:#ffffff05}.ship-preview{width:80px;height:30px;display:flex;align-items:center;justify-content:center;overflow:hidden}.ship-preview .ship-inner{pointer-events:none}.ship-preview .hull-scale-wrapper{transform:scale(.4)!important}.game-over-content{text-align:center;max-width:400px;padding:40px}.game-over-title{font-size:3rem;margin:0 0 20px;text-shadow:0 0 20px currentColor}.win-text{color:#48bb78}.lose-text{color:#fc8181}.control-group{margin-top:auto;display:flex;flex-direction:column;gap:8px;padding-top:10px;border-top:1px solid #4a5568}.btn-row{display:flex;gap:5px}.btn-row>*{flex:1}.btn-icon{padding:8px;font-size:16px}.difficulty-bar{margin-bottom:0}@media(max-width:768px){:root{--cell-size: clamp(26px, 8.5vw, 34px)}body{height:auto;min-height:100vh;overflow-y:auto;padding-top:50px}.layout{flex-direction:column;height:auto;overflow:visible}.dock-panel{width:100%;min-width:100%;height:auto;max-height:none;border-right:none;border-bottom:1px solid #4a5568;order:1;padding:10px;overflow:visible}.center-area{order:2;height:auto;overflow:visible;flex:none;background-attachment:fixed}.log-panel{width:100%;min-width:100%;height:200px;border-left:none;border-top:1px solid #4a5568;order:3}.toggle-btn{display:none}.scroll-view{overflow:visible;padding-bottom:120px}.battlefield{display:grid;grid-template-areas:"stack";width:100%;flex:1;padding:0;margin:0;gap:0;position:relative}.board-box{grid-area:stack;width:100%;display:flex;flex:1;justify-content:center;padding-top:20px;visibility:visible;z-index:0;opacity:1;pointer-events:none}.board-box.active-view{z-index:10;pointer-events:auto}.board-box.active-view .board-title{animation:titleEnter .4s cubic-bezier(.2,.8,.2,1) forwards}.board-box:not(.active-view) .board-title{opacity:0;visibility:hidden;transition:opacity 0s}.board-box.active-view .grid{animation:gridEnter .4s cubic-bezier(.2,.8,.2,1) forwards;box-shadow:0 10px 25px #00000080}@keyframes titleEnter{0%{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}@keyframes gridEnter{0%{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}.bottom-controls{height:auto;flex-wrap:nowrap;padding:8px 10px;gap:8px;position:fixed;bottom:0;left:0;right:0;background:#1a202cfa;border-top:1px solid #4a5568;z-index:1000;box-shadow:0 -4px 20px #00000080;display:flex;justify-content:space-between}#btn-reset,#btn-debug{display:none}#btn-random,#btn-settings{display:flex!important}.dock-panel .difficulty-bar,.dock-panel #first-turn-toggle,.dock-panel .control-group>div:first-child{display:none}.dock-panel #rotate-toggle{display:flex;width:100%;justify-content:center;padding:12px;margin-top:8px;font-size:15px;background:linear-gradient(to right,#667eea,#764ba2);border:1px solid rgba(255,255,255,.2);box-shadow:0 4px 12px #764ba266;border-radius:8px;animation:pulse-guide 2s infinite}@keyframes pulse-guide{0%{box-shadow:0 0 #764ba2b3}70%{box-shadow:0 0 0 6px #764ba200}to{box-shadow:0 0 #764ba200}}.mobile-tab-btn{display:flex!important;flex-direction:column;align-items:center;justify-content:center;font-size:10px;background:transparent;border:none;color:#718096;padding:0 15px;min-width:60px;cursor:pointer}.mobile-tab-btn.active{color:#63b3ed;text-shadow:0 0 10px rgba(99,179,237,.5)}.mobile-tab-btn span{font-size:20px;margin-bottom:4px;display:block}#start-btn{flex:2;margin:0 10px;border-radius:20px;box-shadow:0 4px 10px #ed893666}.weapon-bar{position:fixed;bottom:70px;left:50%;transform:translate(-50%);width:90%;background:#2d3748e6;padding:8px;border-radius:12px;border:1px solid #4a5568;box-shadow:0 4px 15px #0006;z-index:999;display:none}.dock-panel{padding-bottom:20px}.log-panel{display:none}#help-btn{position:static;width:auto;height:24px;padding:0 8px;font-size:12px;box-shadow:0 2px 4px #0003;border:1px solid rgba(255,255,255,.3);transform:none;margin-left:8px;bottom:auto;right:auto;border-radius:12px;gap:4px}#help-btn:hover{transform:none}}.pulse-highlight{animation:pulse-orange 2s infinite;background-color:#f6ad55!important;border-color:#fff!important}@keyframes pulse-orange{0%{box-shadow:0 0 #ed8936b3;transform:scale(1)}70%{box-shadow:0 0 0 6px #ed893600;transform:scale(1.1)}to{box-shadow:0 0 #ed893600;transform:scale(1)}}.icon-btn{background:transparent;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:8px;display:none;position:absolute;right:15px;top:50%;transform:translateY(-50%);z-index:60;text-shadow:0 0 10px rgba(0,0,0,.5)}.icon-btn:hover{color:var(--accent);transform:translateY(-50%) rotate(90deg);transition:all .3s}.menu-modal-content{background:#1a202c;border:1px solid #2d3748;padding:20px}.menu-grid{display:flex;flex-direction:column;gap:15px}.menu-section{background:#2d3748;padding:15px;border-radius:12px}.menu-label{font-size:12px;color:#a0aec0;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;font-weight:700}.menu-row{display:flex;gap:10px}.menu-btn{flex:1;padding:12px;border-radius:8px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;border:none;cursor:pointer;transition:.2s}.mobile-bottom-bar{display:none;width:100%;height:65px;background:#1a202c;align-items:center;justify-content:space-between;padding:0 10px;box-shadow:0 -2px 10px #0000004d;position:relative;z-index:100}.nav-tab{flex:0 0 60px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:transparent;border:none;color:#718096;font-size:10px;padding:0;cursor:pointer;transition:color .2s}.nav-tab .icon{font-size:22px;margin-bottom:4px}.nav-tab.active{color:#63b3ed}.nav-tab.active .icon{transform:scale(1.1)}.action-center{flex:1;display:flex;justify-content:center;padding:0 15px}.deploy-actions,.combat-actions{display:flex;gap:10px;width:100%;justify-content:center}.action-btn{display:flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:16px;font-weight:700;transition:transform .1s,background .2s;cursor:pointer;box-shadow:0 2px 5px #0003}.action-btn:active{transform:scale(.95)}.action-btn.primary{background:var(--accent);color:#1a202c;flex:2;height:44px;font-size:16px}.action-btn.primary:disabled{background:#4a5568;color:#a0aec0;cursor:not-allowed;box-shadow:none}.action-btn.secondary{background:#2d3748;color:var(--text);flex:1;height:44px;border:1px solid #4a5568;font-size:18px}.weapon-selector{background:linear-gradient(135deg,#3182ce,#2b6cb0);color:#fff;width:100%;height:44px;border-radius:22px;font-size:16px;border:1px solid #4299e1}.desktop-controls{display:flex;gap:10px;align-items:center;width:100%;justify-content:center}@media(max-width:768px){header{justify-content:center;padding:0 15px;position:fixed;top:0;width:100%}.icon-btn{display:block}.bottom-controls{padding:0;background:#1a202c;height:auto;border-top:1px solid #2d3748}.mobile-bottom-bar{display:flex}.desktop-controls{display:none}.weapon-bar{bottom:75px!important;width:auto!important;left:15px!important;right:15px!important;transform:none!important;background:#1a202cf2!important;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:1px solid #4a5568;display:none}.weapon-bar.show{display:flex!important;animation:slideUp .2s ease-out}@keyframes slideUp{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.mobile-tab-btn,#btn-random,#btn-settings{display:none!important}.dock-panel{padding-bottom:10px}.scroll-view{padding-bottom:80px}}.ship-visuals-root{--color-sea: #1a2b3c;--color-steel-light: #cfd8dc;--color-steel-mid: #90a4ae;--color-steel-dark: #546e7a;--color-barrel: #263238;--deck-wood-bb: #8d6e63;--deck-flight: #455a64;--deck-dd: #607d8b;--hull-ss: #212121}.turret-base{position:absolute;top:50%;transform:translateY(-50%);z-index:10;display:flex;align-items:center;justify-content:center}.turret-bb{width:22px;height:20px;background:linear-gradient(to bottom,#eceff1,#90a4ae);border-radius:50% 4px 4px 50%;box-shadow:0 2px 3px #0006}.turret-bb:before{content:"";position:absolute;top:50%;transform:translateY(-50%);width:24px;height:3px;background:var(--color-barrel);box-shadow:0 -5px 0 var(--color-barrel),0 5px 0 var(--color-barrel);border-radius:0 2px 2px 0}.turret-bb:after{content:"";position:absolute;top:3px;bottom:3px;width:4px;background:#fff}.turret-cl{width:16px;height:14px;background:#b0bec5;border-radius:4px;box-shadow:0 1px 2px #0000004d}.turret-cl:before{content:"";position:absolute;top:4px;width:14px;height:2px;background:var(--color-barrel);box-shadow:0 4px 0 var(--color-barrel)}.turret-dd{width:12px;height:12px;background:#cfd8dc;border:1px solid #78909c;border-radius:50%}.turret-dd:before{content:"";position:absolute;top:50%;left:50%;width:10px;height:2px;background:var(--color-barrel);transform:translate(-100%,-50%)}.turret-bb:before{left:-20px}.turret-cl:before{left:-10px}.turret-bb:after{left:0}.facing-left .turret-bb,.facing-left .turret-cl,.facing-left .turret-dd{transform:rotate(0)}.facing-right .turret-bb,.facing-right .turret-cl,.facing-right .turret-dd{transform:rotate(180deg)}.hull-bb{width:240px;height:46px;background:repeating-linear-gradient(90deg,#795548 0px 4px,#5d4037 5px);border-radius:50% 15% 15% 50%;position:relative;overflow:hidden;box-shadow:inset 0 0 0 3px var(--color-steel-mid)}.bb-bridge-complex{position:absolute;left:85px;top:4px;bottom:4px;width:60px;background:#0003;border-radius:4px;z-index:5}.bb-tower{position:absolute;left:0;top:-2px;bottom:-2px;width:25px;background:var(--color-steel-light);border:1px solid var(--color-steel-dark);border-radius:4px;box-shadow:2px 2px 4px #0006}.bb-funnel{position:absolute;right:5px;top:8px;bottom:8px;width:18px;background:repeating-linear-gradient(to bottom,#37474f,#37474f 4px,#263238 5px);border-radius:6px;border:1px solid #fff}.bb-stern-equipment{position:absolute;right:10px;top:0;bottom:0;width:40px;z-index:1}.bb-catapult-rail{position:absolute;top:10px;bottom:10px;left:0;width:20px;border-top:2px solid #5d4037;border-bottom:2px solid #5d4037;opacity:.7}.bb-crane{position:absolute;right:5px;bottom:12px;width:25px;height:4px;background:var(--color-steel-dark);transform:rotate(-45deg);border-radius:2px;box-shadow:1px 1px 2px #00000080}.bb-floatplane{position:absolute;left:5px;top:50%;transform:translateY(-50%);width:12px;height:10px;background:#4caf50;clip-path:polygon(50% 0,100% 50%,50% 100%,0 50%)}.hull-cv{width:240px;height:50px;background:var(--deck-flight);border-radius:4px;position:relative;background-image:linear-gradient(90deg,transparent 20%,rgba(255,255,255,.9) 20%,rgba(255,255,255,.9) 80%,transparent 80%),linear-gradient(to bottom,transparent 5%,rgba(255,255,255,.1) 5%,rgba(255,255,255,.1) 95%,transparent 95%);background-size:30px 3px,100% 100%;background-repeat:repeat-x,no-repeat;background-position:center,center}.cv-island{position:absolute;right:55px;top:-6px;width:45px;height:14px;background:var(--color-steel-dark);border-radius:2px;z-index:20;box-shadow:3px 3px 5px #00000080;border-right:6px solid #263238}.cv-elevator{position:absolute;left:60px;top:6px;width:35px;height:38px;border:1px dashed rgba(255,255,255,.4);background:#0003}.cv-sponson{position:absolute;left:10px;bottom:-4px;width:40px;height:6px;background:var(--color-steel-mid);border-radius:0 0 4px 4px}.cv-arrow{position:absolute;left:5px;top:50%;transform:translateY(-50%);width:0;height:0;border-top:6px solid transparent;border-bottom:6px solid transparent;border-right:10px solid #fff}.hull-cl{width:170px;height:32px;background:var(--color-steel-mid);background-image:repeating-linear-gradient(90deg,transparent,transparent 19px,rgba(0,0,0,.1) 20px);border-radius:50% 10% 10% 50%;position:relative;box-shadow:inset 0 0 0 2px var(--color-steel-dark)}.cl-bridge-area{position:absolute;inset:0 40px 0 50px}.cl-block{position:absolute;left:0;top:2px;bottom:2px;width:15px;background:var(--color-steel-dark);border-radius:2px}.cl-funnel{position:absolute;width:8px;height:18px;background:#37474f;border-radius:4px;top:7px}.hull-dd{width:120px;height:22px;background:var(--deck-dd);border-radius:100px 3px 3px 100px;position:relative;display:flex;align-items:center}.dd-mid{position:absolute;left:35px;right:30px;height:100%}.dd-structure{position:absolute;top:6px;width:8px;height:10px;background:#546e7a;border-radius:2px}.dd-torpedo{position:absolute;top:5px;width:12px;height:12px;background:linear-gradient(90deg,#455a64,#263238);border-radius:2px}.hull-ss{width:60px;height:14px;background:var(--hull-ss);border-radius:10px;position:relative;box-shadow:inset 0 2px 4px #ffffff1a}.ss-tower{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:8px;height:22px;background:#333;border-radius:2px;border-top:1px solid #666}.ss-periscope{position:absolute;right:-2px;top:0;width:2px;height:6px;background:#999}.ship-inner{display:flex;align-items:center;justify-content:center;overflow:visible}.hull-scale-wrapper{transform-origin:center center}</style>
</head>
<body>
  <header>
    <h1>ÊåáÊå•ÂÆòÔºöÂÜ≥ÊàòÂ§ßÊ¥ã</h1>
    <button id="btn-menu-toggle" class="icon-btn" aria-label="ËèúÂçï">‚öôÔ∏è</button>
  </header>

  <div id="help-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" data-action="toggle-help">&times;</span>
      <h2 style="color: var(--accent); text-align: center; margin-top: 0;">Ê∏∏ÊàèËßÑÂàôËØ¥Êòé</h2>

      <h3>1. ËÉúÂà©Êù°‰ª∂</h3>
      <p>ÁéáÂÖàÂáªÊ≤âÊïåÊñπÊâÄÊúâ 5 ËâòËà∞ËàπÁöÑ‰∏ÄÊñπËé∑ËÉú„ÄÇ</p>

      <h3>2. Ëà∞ËàπÂ±ûÊÄß</h3>
      <table class="rules-table">
        <thead>
          <tr><th>ÂõæÁ§∫</th><th>‰ª£Âè∑</th><th>ÂêçÁß∞</th><th>ÈïøÂ∫¶</th><th>Ë°ÄÈáè/Ê†º</th><th>ÁâπÊÆäËÉΩÂäõ</th></tr>
        </thead>
        <tbody id="rules-ship-table-body"></tbody>
      </table>

      <h3>3. Ê≠¶Âô®Á≥ªÁªü</h3>
      <table class="rules-table">
        <tr><th>Ê≠¶Âô®</th><th>ËåÉÂõ¥</th><th>‰º§ÂÆ≥</th><th>ËØ¥Êòé</th></tr>
        <tr><td><b>‰∏ªÁÇÆ</b></td><td>ÂçïÁÇπ</td><td>1~3</td><td>Âü∫Á°ÄÊîªÂáª„ÄÇ‰º§ÂÆ≥ÂèñÂÜ≥‰∫éÂ≠òÊ¥ªËà∞Ëàπ(BB=3, CL/SS=2, ÂÖ∂‰ªñ=1)„ÄÇ</td></tr>
        <tr><td><b>Á©∫Ë¢≠</b></td><td>XÂûã (5Ê†º)</td><td>1</td><td>ÈúÄËà™ÊØç(CV)Â≠òÊ¥ª„ÄÇÂØπ‰∏≠ÂøÉÂèäÂõõËßíÈÄ†Êàê‰º§ÂÆ≥„ÄÇ</td></tr>
        <tr><td><b>Ê∞¥Âê¨</b></td><td>3x3 Âå∫Âüü</td><td>0</td><td>ÈúÄÈ©±ÈÄê(DD)ÊàñÊΩúËâá(SS)Â≠òÊ¥ª„ÄÇÊé¢ÊµãÂå∫ÂüüÂÜÖÊòØÂê¶ÊúâËàπ„ÄÇËã•ÊúâÔºåÊòæÁ§∫‰∏≠ÂøÉÁúüÂÆûÁä∂ÊÄÅÔºåÂπ∂Ê†áËÆ∞Âë®Âõ¥‰∏∫Áñë‰ºº„ÄÇ</td></tr>
      </table>

      <h3>4. Áä∂ÊÄÅÊ†áËØÜ</h3>
      <ul style="font-size: 14px; line-height: 1.6;">
        <li>üåä <b>Á©∫ÁôΩ</b>ÔºöÊú™Áü•Êµ∑Âüü„ÄÇ</li>
        <li>‚ö™ <b>Ê∞¥Ëä±</b>ÔºöÊú™ÂëΩ‰∏≠ (Miss)„ÄÇ</li>
        <li>‚ùì <b>ÈóÆÂè∑</b>ÔºöÁñë‰ººÁõÆÊ†á (Â£∞ÂëêÊâ´ÊèèÁªìÊûú)„ÄÇ</li>
        <li>üí• <b>ÂÜíÁÉü</b>ÔºöÂèóÊçü (Hit)ÔºåËàπËøòÂú®„ÄÇ</li>
        <li>‚ò†Ô∏è <b>Á∫¢Âèâ</b>ÔºöÊØÅÂùè (Destroyed)ÔºåËØ•Ê†ºË°ÄÈáèÂΩíÈõ∂„ÄÇ</li>
      </ul>

      <h3>5. Â∞èÊèêÁ§∫</h3>
      <ul style="font-size: 14px; line-height: 1.6;">
        <li>ÁßªÂä®Á´ØÈïøÊåâË¶ÅÊîªÂáªÁöÑÊ†º‰ΩçÂèØ‰ª•È¢ÑËßàÊîªÂáªËåÉÂõ¥</li>
        <li>Êõ¥ÊîπÈÉ®ÁΩ≤ÊñπÂêëÈ¶ñÂÖàÈúÄË¶ÅÂ∞ÜËà∞ËàπÊãñÂõûÊ∏ØÂè£ÔºàÂú®‰øÆ‰∫ÜÂú®‰øÆ‰∫ÜÔºâ</li>
      </ul>
    </div>
  </div>

  <div id="game-over-modal" class="modal">
    <div class="modal-content game-over-content">
      <h2 id="game-over-title" class="game-over-title"></h2>
      <p id="game-over-msg" style="font-size: 1.2rem; margin-bottom: 30px; color: #cbd5e0;"></p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn-blue" data-action="view-battlefield" style="font-size: 1.2rem; padding: 12px 20px;">üëÄ Êü•ÁúãÊàòÂú∫</button>
        <button class="btn-restart" data-action="restart-game" style="font-size: 1.2rem; padding: 12px 20px;">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
      </div>
    </div>
  </div>

  <!-- ÈÄöÁî®ËèúÂçïÊ®°ÊÄÅÊ°Ü (ÂéüËÆæÁΩÆËèúÂçï) -->
  <div id="settings-modal" class="modal">
    <div class="modal-content menu-modal-content">
      <span class="close-btn" data-action="toggle-settings">&times;</span>
      <h2 style="color: var(--accent); text-align: center; margin-top: 0;">‚ò∞ ËèúÂçï</h2>
      
      <div class="menu-grid">
        <!-- Ê∏∏ÊàèÊéßÂà∂ -->
        <div class="menu-section">
            <div class="menu-label">Ê∏∏ÊàèÊéßÂà∂</div>
            <div class="menu-row">
                <button id="mobile-menu-restart" class="menu-btn btn-restart">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
                <button id="mobile-menu-random" class="menu-btn btn-blue">üé≤ ÈöèÊú∫ÈÉ®ÁΩ≤</button>
            </div>
            <button id="mobile-menu-reset" class="menu-btn btn-blue" style="width:100%; margin-top:8px">‚Ü©Ô∏è ÂÖ®ÈÉ®ÂõûÊ∏Ø</button>
        </div>

        <!-- ÈöæÂ∫¶ËÆæÁΩÆ -->
        <div class="menu-section">
            <div class="menu-label">AI ÈöæÂ∫¶</div>
            <div class="difficulty-bar">
                <button class="diff-btn" id="mobile-diff-easy" data-difficulty="EASY">Êñ∞ÂÖµ</button>
                <button class="diff-btn" id="mobile-diff-normal" data-difficulty="NORMAL">Ëà∞Èïø</button>
                <button class="diff-btn" id="mobile-diff-hard" data-difficulty="HARD">ÊèêÁù£</button>
            </div>
        </div>

        <!-- ÈÄâÈ°π -->
        <div class="menu-section">
            <div class="menu-label">ÈÄâÈ°π</div>
            <div class="menu-row">
                <button class="btn-mode" id="mobile-first-turn">ÂÖàÊâãÔºöÁé©ÂÆ∂ üë§</button>
                <button class="btn-mode" id="mobile-debug">üß† AI ËßÜËßí</button>
            </div>
        </div>
        
        <!-- Â∏ÆÂä© -->
        <div class="menu-section">
             <button id="mobile-menu-help" class="menu-btn btn-orange" style="width:100%">üìñ Ê∏∏ÊàèËØ¥Êòé</button>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <div class="dock-panel">
      <div class="dock-header">
        <span>‚öì Ë£ÖÂ§áÂå∫</span>
        <div id="help-btn" data-action="toggle-help">? Â∏ÆÂä©</div>
      </div>

      <div id="battle-panel" class="dock-container" style="display: none; align-items: stretch;">
        <div class="weapon-bar" id="weapon-bar">
          <button class="weapon-btn active" id="btn-ap" data-weapon="AP">
            <span>üí• ‰∏ªÁÇÆ</span>
            <span id="ap-desc" style="font-size:10px; opacity:0.8">ÂçïÁÇπ 3‰º§</span>
          </button>
          <button class="weapon-btn" id="btn-he" data-weapon="HE">
            <span>‚úàÔ∏è Á©∫Ë¢≠</span>
            <span style="font-size:10px; opacity:0.8">ËåÉÂõ¥ 1‰º§</span>
          </button>
          <button class="weapon-btn" id="btn-sonar" data-weapon="SONAR">
            <span>üì° Ê∞¥Âê¨</span>
            <span style="font-size:10px; opacity:0.8">‰æ¶Êü• 3x3</span>
          </button>
        </div>

        <div class="status-panel" id="status-panel">
          <div style="text-align:center; color:#90cdf4; font-weight:bold; margin-bottom:5px">Ëà∞ÈòüÁä∂ÊÄÅ</div>
          <div id="ship-status-list"></div>
        </div>
      </div>

      <div class="dock-container" id="dock"></div>

      <div class="control-group">
        <div style="font-size: 12px; color: #a0aec0; margin-bottom: 2px;">AI ÈöæÂ∫¶</div>
        <div class="difficulty-bar" id="diff-bar">
          <button class="diff-btn" data-difficulty="EASY">Êñ∞ÂÖµ (ÁÆÄÂçï)</button>
          <button class="diff-btn" data-difficulty="NORMAL">Ëà∞Èïø (Âõ∞Èöæ)</button>
          <button class="diff-btn active" data-difficulty="HARD">ÊèêÁù£ (ÂÜ∑ÈÖ∑)</button>
        </div>

        <div class="btn-row">
          <button class="btn-mode" id="rotate-toggle" title="ÂàáÊç¢ÈÉ®ÁΩ≤ÊñπÂêë">ÊñπÂêëÔºöÊ∞¥Âπ≥ ‚Æï</button>
          <button class="btn-mode" id="first-turn-toggle" title="ÂàáÊç¢ÂÖàÊâã">ÂÖàÊâãÔºöÁé©ÂÆ∂ üë§</button>
        </div>
      </div>
    </div>

    <div class="center-area">
      <div class="toggle-btn toggle-left" data-panel-toggle="left" title="ÂàáÊç¢Ë£ÖÂ§áÂå∫">‚óÄ</div>
      <div class="toggle-btn toggle-right" data-panel-toggle="right" title="ÂàáÊç¢Êó•ÂøóÂå∫">‚ñ∂</div>

      <div class="scroll-view">
        <div class="battlefield">
          <div class="board-box" id="player-board-box">
            <div class="board-title" style="color:#68d391">ÊàëÊñπÊµ∑Âüü (Èò≤ÂÆà)</div>
            <div id="player-grid" class="grid"></div>
          </div>
          <div class="board-box" id="enemy-board-box">
            <div class="board-title" style="color:#fc8181">ÊïåÊñπÊµ∑Âüü (ËøõÊîª)</div>
            <div id="enemy-grid" class="grid"></div>
          </div>
        </div>
      </div>

      <div class="bottom-controls" id="bottom-controls">
        <!-- ÁßªÂä®Á´ØÂ∫ïÈÉ®ÂØºËà™ (Êñ∞ËÆæËÆ°) -->
        <div class="mobile-bottom-bar">
            <button class="nav-tab active" id="mb-tab-player">
                <span class="icon">üõ°Ô∏è</span>
                <span class="label">ÊàëÊñπ</span>
            </button>
            
            <div class="action-center">
                <!-- ÈÉ®ÁΩ≤Èò∂ÊÆµ -->
                <div class="deploy-actions" id="mb-deploy-group">
                    <button id="mb-btn-start" class="action-btn primary" disabled>
                        <span>üöÄ ÂºÄÂßã</span>
                    </button>
                </div>
                <!-- ÊàòÊñóÈò∂ÊÆµ -->
                <div class="combat-actions" id="mb-combat-group" style="display:none">
                    <button id="mb-btn-weapon" class="action-btn weapon-selector">
                        <span id="mb-weapon-icon">üí•</span>
                        <span id="mb-weapon-name">‰∏ªÁÇÆ</span>
                    </button>
                </div>
            </div>

            <button class="nav-tab" id="mb-tab-enemy">
                <span class="icon">üéØ</span>
                <span class="label">ÊïåÊñπ</span>
            </button>
        </div>

        <!-- Ê°åÈù¢Á´ØÂéüÊúâÊåâÈíÆ (ÁßªÂä®Á´ØÈöêËóè) -->
        <div class="desktop-controls">
            <button class="btn-mode" id="btn-debug" title="AI ËßÜËßí (Debug)">üß† AI ËßÜËßí</button>
            <button id="btn-reset" class="btn-blue" title="ÂÖ®ÈÉ®ÂõûÊ∏Ø">üîÑ ÂÖ®ÈÉ®ÂõûÊ∏Ø</button>
            <button id="btn-settings" class="btn-blue" style="display:none" title="ËÆæÁΩÆ">‚öôÔ∏è ËÆæÁΩÆ</button>
            <button id="btn-random" class="btn-blue" title="ÈöèÊú∫ÈÉ®ÁΩ≤">üé≤ ÈöèÊú∫ÈÉ®ÁΩ≤</button>
            <button class="btn-orange" id="start-btn" disabled>üöÄ ÂºÄÂßãÊàòÊñó</button>
        </div>
      </div>
    </div>

    <div class="log-panel">
      <div class="log-header">‚ö° ÊàòÂÜµËÆ∞ÂΩï</div>
      <div id="log" class="log-content">
        <div class="log-line c-sys">ÊãñÊãΩÈÉ®ÁΩ≤ÔºåÁªøËâ≤Âå∫Âüü‰∏∫ÊúâÊïà„ÄÇ</div>
        <div class="log-line c-sys">ÂáÜÂ§áÂ∞±Áª™ÂêéÁÇπÂáªÂºÄÂßã„ÄÇ</div>
      </div>
    </div>
  </div>

</body>
</html>
